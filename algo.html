<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo Bonnie Makeup — Con Flip & Descripción</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,Arial;
      background:linear-gradient(135deg,#ffecf1 0%,#fff6fb 50%,#fff 100%);
      min-height:100vh;
      padding:28px;
      color:#111;
    }

    /* Header */
    .header{text-align:center;margin-bottom:28px;position:relative}
    .header h1{
      font-size:2.6rem;
      background:linear-gradient(45deg,#ff6b6b,#ff9a9e);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .header p{font-size:1rem;color:#666}

    /* Tabs */
    #tabs{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px}
    .tab{
      background:rgba(255,255,255,0.95);
      padding:8px 16px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);
      font-weight:700;cursor:pointer;color:#444;transition:.25s
    }
    .tab:hover,.tab.active{transform:translateY(-3px);box-shadow:0 8px 22px rgba(102,126,234,0.12);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}

    /* Card base */
    .card {
      perspective: 1000px;
      position:relative;
    }

    .flip-inner {
      position:relative;
      width:100%;
      transform-style:preserve-3d;
      transition: transform .7s cubic-bezier(.2,.9,.2,1);
    }
    .flip-inner.flipped { transform: rotateY(180deg); }

    .flip-face {
      backface-visibility: hidden;
      transform-style: preserve-3d;
      border-radius:18px;
      overflow:hidden;
      min-height:320px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow: 0 18px 40px rgba(34,34,60,0.06), inset 0 1px 0 rgba(255,255,255,0.6);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border:1px solid rgba(0,0,0,0.04);
    }

    /* Front/Back faces */
    .card-front { padding:18px; }
    .card-back { 
      padding:12px 14px; 
      position: absolute; inset:0; transform: rotateY(180deg);
      display:flex;flex-direction:column;gap:12px; align-items:center; justify-content:flex-start;
    }

    /* Decorative header accent */
    .card-accent {
      position:absolute;left:0;top:0;height:64px;width:100%;
      background: linear-gradient(90deg, rgba(255,111,111,0.08), rgba(102,126,234,0.06));
      pointer-events:none;
    }

    /* Eye toggle */
    .eye-toggle {
      position:absolute; left:12px; top:12px;
      width:40px;height:40px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,0.8);backdrop-filter: blur(4px);
      border:1px solid rgba(0,0,0,0.06); cursor:pointer; z-index:5;
      transition:transform .18s, background .18s;
      box-shadow:0 6px 14px rgba(0,0,0,0.06);
    }
    .eye-toggle:active{ transform:scale(.96) }

    /* small image circle on front */
    .front-image {
      width:84px;height:84px;border-radius:50%;overflow:hidden;margin:8px auto 12px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      border:6px solid rgba(255,255,255,0.9);
      background:linear-gradient(135deg,#fff,#fff);
      display:flex;align-items:center;justify-content:center;
    }
    .product-img{ width:100%; height:100%; object-fit:cover; display:block; }

    .name { font-weight:800; text-align:center; margin-top:6px; font-size:1rem; color:#222 }
    .cat { font-size:12px; color:#888; text-align:center; margin-top:4px }
    .meta { padding:12px 18px 6px; display:flex;flex-direction:column; gap:8px; align-items:center }

    .price { font-size:1.3rem; font-weight:800; text-align:center; color: #333; }
    .stock { font-size:0.85rem; padding:6px 12px; border-radius:20px; background:linear-gradient(90deg,#667eea,#764ba2); color:#fff; font-weight:700 }

    .actions{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px 0}
    .small{padding:6px 8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
    .qty{min-width:22px;text-align:center;font-weight:700}
    .btn.order { background:#111;color:#fff;padding:8px 12px;border-radius:12px;border:0;cursor:pointer; font-weight:800 }
    .btn.order[disabled]{opacity:.5;cursor:not-allowed}

    /* Back: larger image and description box */
    .back-image-wrap { width:100%; height:180px; border-radius:12px; overflow:hidden; display:flex;align-items:center;justify-content:center; background:linear-gradient(180deg,#fafafa,#fff) }
    .back-image { width:100%; height:100%; object-fit:cover; display:block }
    .desc-box { width:100%; max-height:120px; overflow:auto; padding:12px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfbff); border:1px solid rgba(0,0,0,0.04); font-size:0.95rem; color:#333 }

    /* small decorative corner badge */
    .ribbon {
      position:absolute; right:10px; top:10px; padding:6px 10px;
      background:linear-gradient(45deg,#ff6b6b,#ff9a9e);
      color:#fff; font-weight:800; border-radius:12px; font-size:12px; box-shadow:0 8px 18px rgba(255,107,107,0.14)
    }

    /* subtle hover */
    .card:hover .flip-face { transform: translateY(-4px); transition: .3s; }

    /* responsive tweaks */
    @media (max-width:520px){
      .back-image-wrap{height:150px}
      .grid{gap:14px}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>💄 Marrie</h1>
    <p>Belleza que inspira, calidad que perdura</p>
  </div>

  <div id="app">
    <div id="tabs">Cargando categorías...</div>
    <div id="content">Cargando productos...</div>
  </div>

  <!-- Carrito UI (misma estructura que tenías) -->
  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">🛒</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay" style="display:none">
    <div id="cart-popup" role="dialog" aria-modal="true">
      <h3>Confirmar pedido</h3>
      <div id="cart-items-container"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
      <div class="actions">
        <button class="small-btn" id="cart-close">Seguir comprando</button>
        <button class="confirm-btn" id="cart-confirm">Confirmar y enviar por WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://d.thepersonmrt.workers.dev/";
    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');
    let lastProductsCache = [];
    let lastLoadedSheetKey = null;

    function firstKeyValue(obj, keys){
      if (!obj) return undefined;
      const map = {};
      Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
      for (let key of keys){
        const v = map[key.toLowerCase()];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return undefined;
    }

    function fmtPrice(v){
      if (v===undefined || v===null) return '-';
      const s = String(v).trim();
      if (s === '') return '-';
      const n = parsePriceNumber(s);
      if (/^[\d\.\,]+$/.test(s)) {
        return Number(n).toLocaleString('de-DE');
      }
      return s;
    }

    function parsePriceNumber(v){
      if (v === undefined || v === null) return 0;
      if (typeof v === 'number' && !isNaN(v)) return v;
      let s = String(v).trim();
      if (s === '') return 0;
      s = s.replace(/\s+/g, '');
      s = s.replace(/\./g, '');
      s = s.replace(/,/g, '.');
      s = s.replace(/[^0-9.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* ---------- Carrito (sin cambios funcionales importantes) ---------- */
    const WHATSAPP_NUMBER = '573207378992';
    let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

    const cartBtn = document.getElementById('cart-btn');
    const cartCountEl = document.getElementById('cart-count');
    const cartSummaryEl = document.getElementById('cart-summary');
    const cartOverlay = document.getElementById('cart-popup-overlay');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCloseBtn = document.getElementById('cart-close');
    const cartConfirmBtn = document.getElementById('cart-confirm');

    function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
    function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

    function getOriginalStock(sheetKey, row){
      const card = Array.from(document.querySelectorAll('.card')).find(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      if(card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);
      if(window.lastProductsCache && Array.isArray(window.lastProductsCache)){
        const p = window.lastProductsCache.find(pp => String(pp.row) === String(row));
        if(p){
          const d = p.data || {};
          const stock = firstKeyValue(d, ['stock','cantidad']) || 0;
          return Number(stock || 0);
        }
      }
      return 0;
    }

    function getReservedQty(sheetKey, row){
      return cart.filter(i => i.sheetKey === sheetKey && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
    }

    function refreshCardStockDisplay(sheetKey, row){
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey, row);
      const avail = Math.max(0, origStock - reserved);
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan) stockSpan.innerText = avail;
        const orderBtn = card.querySelector('.order');
        if(avail <= 0){
          card.classList.add('out');
          if(orderBtn) orderBtn.disabled = true;
        } else {
          card.classList.remove('out');
          if(orderBtn) orderBtn.disabled = false;
        }
      });
    }

    function updateCartUI(){
      const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
      const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
      cartCountEl.innerText = count;
      cartSummaryEl.innerText = `Carrito ${count>0? '• ' + count + ' items':''}`;
      if(cartBtn) cartBtn.style.display = 'flex';
      if(cartBtn) cartBtn.title = count ? `${count} item(s) en carrito — Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vacío';
      saveCart();
    }

    function addToCart(card, qty){
      const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
      const row = card.dataset.row;
      const name = card.querySelector('.name')?.innerText || 'Sin nombre';
      const priceRaw = card.dataset.price !== undefined ? card.dataset.price : (card.querySelector('.price')?.innerText || '');
      const priceNum = parsePriceNumber(priceRaw);
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey,row);
      const available = Math.max(0, origStock - reserved);

      if(qty > available){
        alert('No hay suficiente stock disponible.');
        return;
      }

      const key = `${sheetKey}::${row}`;
      const existing = cart.find(i=>cartItemKey(i) === key);
      if(existing){
        existing.qty = Math.min(origStock, existing.qty + qty);
      } else {
        cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
      }

      refreshCardStockDisplay(sheetKey,row);
      updateCartUI();
    }

    /* Modal Carrito (igual lógica que tenías) */
    function renderCartModal(){
      cartItemsContainer.innerHTML = '';
      if(cart.length === 0){
        cartItemsContainer.innerHTML = `<div class="empty-msg">El carrito está vacío</div>`;
        cartTotalEl.innerText = '';
        return;
      }

      cart.forEach((it, index) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        const left = document.createElement('div');
        left.className = 'left';
        left.innerHTML = `<strong>${it.name}</strong><div style="font-size:13px;color:#666">Precio: $ ${fmtPrice(it.price)} · Nota: ${it.sheetKey}</div>`;

        const right = document.createElement('div');
        right.className = 'right';
        const controls = document.createElement('div');
        controls.style.display = 'flex';
        controls.style.flexDirection = 'column';
        controls.style.alignItems = 'flex-end';
        controls.innerHTML = `
          <div style="display:flex;gap:6px;align-items:center">
            <button class="small-btn cart-minus" data-idx="${index}">-</button>
            <span class="cart-qty" data-idx="${index}">${it.qty}</span>
            <button class="small-btn cart-plus" data-idx="${index}">+</button>
          </div>
          <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
            <div style="font-weight:700">$ ${Number(parsePriceNumber(it._priceNum !== undefined ? it._priceNum : it.price) * Number(it.qty)).toLocaleString('de-DE')}</div>
            <button class="small-btn cart-remove" data-idx="${index}">Eliminar</button>
          </div>
        `;
        right.appendChild(controls);
        div.appendChild(left); div.appendChild(right);
        cartItemsContainer.appendChild(div);
      });

      const total = cart.reduce((s,i)=>s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)),0);
      cartTotalEl.innerText = 'Total: $ ' + Number(total).toLocaleString();

      Array.from(cartItemsContainer.querySelectorAll('.cart-minus')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          if(cart[idx].qty > 1){
            cart[idx].qty = cart[idx].qty - 1;
            refreshCardStockDisplay(cart[idx].sheetKey, cart[idx].row);
            saveCart(); updateCartUI(); renderCartModal();
          } else {
            const it = cart[idx];
            cart.splice(idx,1);
            refreshCardStockDisplay(it.sheetKey, it.row);
            saveCart(); updateCartUI(); renderCartModal();
          }
        };
      });

      Array.from(cartItemsContainer.querySelectorAll('.cart-plus')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          const it = cart[idx];
          const orig = getOriginalStock(it.sheetKey, it.row);
          if(Number(it.qty) < orig){
            it.qty = Number(it.qty) + 1;
            refreshCardStockDisplay(it.sheetKey, it.row);
            saveCart(); updateCartUI(); renderCartModal();
          } else {
            alert('No hay más stock disponible para aumentar la cantidad.');
          }
        };
      });
      Array.from(cartItemsContainer.querySelectorAll('.cart-remove')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          const it = cart[idx];
          cart.splice(idx,1);
          refreshCardStockDisplay(it.sheetKey, it.row);
          saveCart(); updateCartUI(); renderCartModal();
        };
      });
    }

    function openCartModal(){
      if(cart.length === 0){
        alert('El carrito está vacío');
        return;
      }
      renderCartModal();
      if(cartOverlay) cartOverlay.style.display = 'flex';
    }
    function closeCartModal(){ if(cartOverlay) cartOverlay.style.display = 'none'; }

    async function sendOrderAndWhatsapp(){
      if(cart.length === 0) return alert('Carrito vacío');
      cartConfirmBtn.disabled = true;
      cartConfirmBtn.innerText = 'Procesando...';

      try{
        const promises = cart.map(it => {
          const form = new URLSearchParams();
          form.append('action','decrement');
          form.append('sheetKey', it.sheetKey);
          form.append('row', it.row);
          form.append('amount', it.qty);
          return fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form })
            .then(r=>r.json())
            .then(res => {
              if(res.error) throw new Error(res.message || 'Error API');
              return { ok:true, ...res, item: it };
            });
        });

        const results = await Promise.all(promises);

        results.forEach(r => {
          const it = r.item;
          const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
            const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
            const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
            return sk === it.sheetKey && rrow === it.row.toString();
          });
          cards.forEach(card => {
            const stockSpan = card.querySelector('.stockval');
            if(stockSpan && typeof r.newStock !== 'undefined'){
              card.dataset.origStock = Number(r.newStock);
              stockSpan.innerText = Number(r.newStock);
              const orderBtn = card.querySelector('.order');
              if(Number(r.newStock) <= 0){
                card.classList.add('out');
                if(orderBtn) orderBtn.disabled = true;
              } else {
                card.classList.remove('out');
                if(orderBtn) orderBtn.disabled = false;
              }
            }
          });
        });

        let msg = 'buenas noches, me interesaria comprar:%0A';
        cart.forEach(it => {
          msg += `- ${it.name}, precio: $ ${fmtPrice(it.price)}, cantidad: ${it.qty}%0A`;
        });
        msg += '%0Amuchas gracias';

        if(!WHATSAPP_NUMBER || WHATSAPP_NUMBER.includes('WHATSAPP_NUMBER_HERE')){
          alert('Por favor reemplaza WHATSAPP_NUMBER_HERE por el número de destino en el script.');
        } else {
          const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
          window.open(waUrl, '_blank');
        }

        cart = [];
        saveCart();
        updateCartUI();
        closeCartModal();
      }catch(err){
        alert('Error al procesar el pedido: ' + (err.message || err));
      }finally{
        cartConfirmBtn.disabled = false;
        cartConfirmBtn.innerText = 'Confirmar y enviar por WhatsApp';
      }
    }

    if(cartCloseBtn) cartCloseBtn.onclick = closeCartModal;
    if(cartConfirmBtn) cartConfirmBtn.onclick = sendOrderAndWhatsapp;
    if(cartBtn) cartBtn.onclick = openCartModal;

    updateCartUI();

    /* ----------------- Cargar categorías y renderProductos (sin cambiar worker) -----------------*/
    async function loadCategories(){
      try {
        const r = await fetch(API_URL, {cache:'no-store'});
        const data = await r.json();
        if (!data.sheets) throw new Error("Respuesta inválida");
        renderTabs(data.sheets);
      } catch(err){
        if(tabsEl) tabsEl.innerHTML = 'Error cargando categorías';
        console.error(err);
      }
    }
    function renderTabs(sheets){
      if(!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.className = 'tab active';
      allBtn.innerText = "Todos";
      allBtn.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        allBtn.classList.add('active');
        loadProductsAll();
      };
      tabsEl.appendChild(allBtn);

      sheets.forEach((s, i)=>{
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.innerText = s.key;
        btn.dataset.key = s.key;
        btn.onclick = ()=> {
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          loadProductsFor(s.key);
        };
        tabsEl.appendChild(btn);
      });

      loadProductsAll();
    }

    async function loadProductsFor(sheetKey){
      lastLoadedSheetKey = sheetKey;
      if(contentEl) contentEl.innerHTML = 'Cargando...';
      try {
        const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, sheetKey);
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    async function loadProductsAll(){
      lastLoadedSheetKey = "ALL";
      if(contentEl) contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
      try {
        const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, "ALL");
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    function escapeHtml(str){
      if(str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    /* Helper: proxied URL (usa tu worker /image-proxy) */
    function proxiedUrl(raw){
      if(!raw || typeof raw !== 'string') return '';
      return API_URL + 'image-proxy?url=' + encodeURIComponent(raw);
    }

    /* Helper: crea un <img> con fallback sencillo */
    function makeImgEl(raw, alt, className){
      const img = document.createElement('img');
      img.alt = alt || '';
      img.className = className || '';
      try {
        img.src = proxiedUrl(raw);
      } catch(e){
        img.src = '';
      }
      img.onerror = () => {
        img.remove();
      };
      return img;
    }

    /* Render products: ahora usamos sheetKey real del producto (p.sheetKey) para la lógica de filtrado */
    function renderProducts(products, sheetKey){
      if (!products || !products.length){
        if(contentEl) contentEl.innerHTML = 'No hay productos';
        return;
      }
      const grid = document.createElement('div');
      grid.className='grid';

      products.forEach(p=>{
        const d = p.data || {};
        const name = firstKeyValue(d, ['name','nombre','producto']) || firstKeyValue(d, ['Nombre']) || 'Sin nombre';
        const price = firstKeyValue(d, ['price','precio','Precio']) || '';
        const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || 0);
        const rawIcon = firstKeyValue(d, ['icon','emoji','image','img','icono','imagen','foto','url','Icono']) || '🛍️';
        const cat  = firstKeyValue(d, ['descripcion','category','categoria']) || '';
        // description field (look for descripcion or aliases)
        const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota','nota_descripcion']) || '';

        // Determinar sheetKey del producto:
        const productSheetKey = p.sheetKey || d.sheetKey || d.SheetKey || (sheetKey === "ALL" ? (d.Descripcion || d.descripcion || d.Categoria || d.categoria || d.category || 'UNKNOWN') : sheetKey);

        const cardWrap = document.createElement('div');
        cardWrap.className = 'card';
        cardWrap.dataset.origStock = stock;
        cardWrap.dataset.price = price;
        cardWrap.dataset.row = p.row;
        cardWrap.dataset.sheetKey = productSheetKey;

        // inner flip container
        const inner = document.createElement('div');
        inner.className = 'flip-inner';

        // FRONT face
        const front = document.createElement('div');
        front.className = 'flip-face card-front';

        front.innerHTML = `
          <div class="card-accent" aria-hidden="true"></div>
          <div class="ribbon">Bonnie</div>
          <div style="position:relative">
            <button class="eye-toggle" aria-pressed="false" title="Ver descripción" type="button" aria-label="Ver descripción">
              <!-- open eye icon (SVG) -->
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#333" stroke-width="1.2"/>
              </svg>
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="display:none">
                <path d="M3 3l18 18" stroke="#333" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12s4-7 10-7 10 7 10 7" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div style="height:8px"></div>
            <div class="front-image"></div>
          </div>

          <div class="meta">
            <div class="name">${escapeHtml(name)}</div>
            <div class="cat">${escapeHtml(cat)}</div>
            <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px">
              <div class="price">$ ${fmtPrice(price)}</div>
              <div class="stock">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></div>
            </div>
          </div>

          <div style="padding:0 14px 14px">
            <div class="actions">
              <button class="small minus">-</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        `;

        // BACK face
        const back = document.createElement('div');
        back.className = 'flip-face card-back';
        back.innerHTML = `
          <div class="card-accent" aria-hidden="true"></div>
          <div style="width:100%;display:flex;justify-content:center;position:relative">
            <button class="eye-toggle" aria-pressed="true" title="Ocultar descripción" type="button" aria-label="Ocultar descripción" style="left:10px;top:10px;position:absolute;">
              <!-- closed eye SVG -->
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3l18 18" stroke="#333" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12s4-7 10-7 10 7 10 7" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <div class="back-image-wrap"></div>
          <div class="desc-box">${escapeHtml(description || 'Sin descripción')}</div>
          <div style="width:100%;display:flex;justify-content:center;padding-bottom:10px">
            <div class="actions">
              <button class="small minus">-</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        `;

        inner.appendChild(front);
        inner.appendChild(back);
        cardWrap.appendChild(inner);

        // attach to grid
        grid.appendChild(cardWrap);

        // ---- After DOM nodes exist, wire up images, eye toggle and controls ----
        // front small image
        const frontImageWrap = front.querySelector('.front-image');
        if (rawIcon && typeof rawIcon === 'string' && /^(https?:)?\/\//i.test(rawIcon)) {
          const imgSmall = makeImgEl(rawIcon, name, 'product-img');
          imgSmall.style.width = '84px';
          imgSmall.style.height = '84px';
          imgSmall.className = 'product-img';
          frontImageWrap.appendChild(imgSmall);
        } else {
          // show rawIcon text/emoji inside circle
          const span = document.createElement('div');
          span.style.fontSize = '30px';
          span.innerText = rawIcon;
          frontImageWrap.appendChild(span);
        }

        // back large image
        const backImageWrap = back.querySelector('.back-image-wrap');
        if (rawIcon && typeof rawIcon === 'string' && /^(https?:)?\/\//i.test(rawIcon)) {
          const imgLarge = makeImgEl(rawIcon, name, 'back-image');
          imgLarge.className = 'back-image';
          backImageWrap.appendChild(imgLarge);
        } else {
          backImageWrap.innerHTML = `<div style="padding:20px;color:#999">Imagen no disponible</div>`;
        }

        // Eye toggles (front and back) - synchronize flip state
        const eyeFront = front.querySelector('.eye-toggle');
        const eyeBack = back.querySelector('.eye-toggle');

        function setFlipState(flip){
          if(flip){
            inner.classList.add('flipped');
            eyeFront.setAttribute('aria-pressed','true');
            eyeBack.setAttribute('aria-pressed','true');
            // swap visuals: hide open-eye on front, show closed; but simpler: toggle svg visibility
            const frontOpen = eyeFront.querySelector('.eye-open');
            const frontClosed = eyeFront.querySelector('.eye-closed');
            if(frontOpen) frontOpen.style.display = 'none';
            if(frontClosed) frontClosed.style.display = 'inline';
          } else {
            inner.classList.remove('flipped');
            eyeFront.setAttribute('aria-pressed','false');
            eyeBack.setAttribute('aria-pressed','false');
            const frontOpen = eyeFront.querySelector('.eye-open');
            const frontClosed = eyeFront.querySelector('.eye-closed');
            if(frontOpen) frontOpen.style.display = 'inline';
            if(frontClosed) frontClosed.style.display = 'none';
          }
        }

        eyeFront.addEventListener('click', (ev) => {
          ev.stopPropagation();
          setFlipState(true);
        });
        eyeBack.addEventListener('click', (ev) => {
          ev.stopPropagation();
          setFlipState(false);
        });

        // quantity controls (front and back) must keep qty in sync within the same card
        const minusBtns = cardWrap.querySelectorAll('.minus');
        const plusBtns = cardWrap.querySelectorAll('.plus');
        const qtySpans = cardWrap.querySelectorAll('.qty');
        minusBtns.forEach(btn => btn.addEventListener('click', ()=>{
          const current = Number(qtySpans[0].innerText || '1');
          if(current > 1){
            qtySpans.forEach(s=>s.innerText = current - 1);
          }
        }));
        plusBtns.forEach(btn => btn.addEventListener('click', ()=>{
          const orig = getOriginalStock(cardWrap.dataset.sheetKey, cardWrap.dataset.row);
          const current = Number(qtySpans[0].innerText || '1');
          if(current < Math.max(0, orig - getReservedQty(cardWrap.dataset.sheetKey, cardWrap.dataset.row))){
            qtySpans.forEach(s=>s.innerText = current + 1);
          }
        }));

        // Order buttons (both faces) use same logic - add to cart with current qty
        const orderBtns = cardWrap.querySelectorAll('.order');
        orderBtns.forEach(btn => btn.addEventListener('click', ()=>{
          const qty = Number(cardWrap.querySelector('.qty').innerText || '1');
          addToCart(cardWrap, qty);
        }));

        // initial visual state
        setFlipState(false);
      });

      if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
    }

    loadCategories();
  </script>
</body>
</html>
