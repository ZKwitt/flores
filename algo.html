<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo Bonnie Makeup</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,Arial;
      background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
      min-height:100vh;
      padding:20px;
      overflow-x:hidden;
      color:#111;
    }

    /* Header */
    .header{text-align:center;margin-bottom:30px;position:relative}
    .header::before{
      content:'';position:absolute;top:-20px;left:50%;
      transform:translateX(-50%);
      width:100px;height:4px;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);
      border-radius:2px;
    }
    .header h1{
      font-size:3rem;
      background:linear-gradient(45deg,#667eea,#764ba2,#ff6b6b);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 4px 20px rgba(0,0,0,0.1);
      margin-bottom:8px;
    }
    .header p{font-size:1.1rem;color:#555;font-style:italic}

    /* Tabs (categorías) */
    #tabs{
      display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
      margin-bottom:24px;
    }
    .tab{
      background:rgba(255,255,255,0.9);
      padding:10px 20px;
      border-radius:25px;
      border:2px solid transparent;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      color:#666;
    }
    .tab:hover,.tab.active{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(102,126,234,.3);
    }

    /* Productos grid */
    #content{min-height:160px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:20px;
    }

    .card{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(15px);
      border-radius:20px;
      padding:20px;
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 12px 30px rgba(0,0,0,0.08);
      transition:.35s cubic-bezier(0.175,0.885,0.32,1.275);
      display:flex;flex-direction:column;gap:10px;
      position:relative;overflow:hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:-100%;
      width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
      transition:.5s;
    }
    .card:hover{transform:translateY(-6px) scale(1.02)}
    .card:hover::before{left:100%}
    .card.out{opacity:.5}

    .icon{
      width:60px;height:60px;
      border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:26px;
      background:linear-gradient(45deg,#667eea,#764ba2);
      margin:0 auto 12px;
      color:#fff;
      box-shadow:0 6px 18px rgba(102,126,234,0.3);
    }
    .name{font-weight:700;font-size:1.05rem;text-align:center;min-height:40px}
    .cat{font-size:12px;color:#888;text-align:center}
    .price{
      font-size:1.6rem;font-weight:700;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-align:center;
    }
    .stock{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;font-size:.9rem;font-weight:600;
      padding:6px 14px;border-radius:20px;
      margin:0 auto;
      box-shadow:0 4px 12px rgba(102,126,234,0.25);
    }

    .actions{display:flex;gap:8px;margin-top:8px;align-items:center;justify-content:center}
    button.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    button.order{background:#111;color:#fff}
    button.order[disabled]{opacity:.5;cursor:not-allowed}
    button.small{padding:6px 8px;border:1px solid #ddd;background:#fff}
    .qty{min-width:20px;text-align:center;font-weight:600}

    /* Debug */
    #debug{
      margin-top:20px;background:#fff;
      padding:12px;border-radius:10px;
      border:1px solid #eee;
      white-space:pre-wrap;font-size:13px;color:#222;
      max-width:1100px;margin-left:auto;margin-right:auto;
    }

    /* Floating emojis */
    .floating-shapes{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
    .shape{position:absolute;opacity:.08;animation:float 6s ease-in-out infinite;font-size:2rem}
    .shape:nth-child(1){top:20%;left:10%;animation-delay:0s}
    .shape:nth-child(2){top:60%;left:80%;animation-delay:2s}
    .shape:nth-child(3){top:30%;left:60%;animation-delay:4s}
    @keyframes float{
      0%,100%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-20px) rotate(180deg)}
    }

    /* Carrito (esquina inferior derecha) */
    #cart-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #0b84ff;
      color: white;
      border: none;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      cursor: pointer;
      display:flex;
      gap:10px;
      align-items:center;
      z-index:9999;
    }
    #cart-btn .badge { background:#ff4757; padding:4px 7px; border-radius:999px; font-weight:700; }
    #cart-popup-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:10000; }
    #cart-popup { background:white; width:90%; max-width:560px; border-radius:10px; padding:18px; box-shadow:0 8px 28px rgba(0,0,0,0.2); max-height:80vh; overflow:auto; }
    #cart-popup h3 { margin-top:0; }
    .cart-item { display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid #eee; }
    .cart-item .left { flex:1; }
    .cart-item .right { text-align:right; min-width:110px; }
    #cart-popup .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
    .small-btn { padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
    .confirm-btn { background:#0b84ff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .empty-msg { text-align:center; color:#666; padding:18px 0; }

    /* Image / fallback small helpers */
    .product-img {
      width:60px;
      height:60px;
      object-fit:cover;
      border-radius:50%;
      display:inline-block;
      vertical-align:middle;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    .icon-fallback {
      display:inline-block;
      width:60px;
      height:60px;
      line-height:60px;
      text-align:center;
      font-size:26px;
      border-radius:50%;
      color:#fff;
      background:linear-gradient(45deg,#667eea,#764ba2);
      box-shadow:0 6px 18px rgba(102,126,234,0.3);
    }
  </style>
</head>
<body>
  <div class="floating-shapes">
    <div class="shape">💄</div>
    <div class="shape">✨</div>
    <div class="shape">💋</div>
  </div>

  <div class="header">
    <h1>💄 Marrie</h1>
    <p>Belleza que inspira, calidad que perdura</p>
  </div>

  <div id="app">
    <div id="tabs">Cargando categorías...</div>
    <div id="content">Cargando productos...</div>
    <div id="debug">Debug: —</div>
  </div>

  <!-- Añade esto en tu HTML (por ejemplo al final del body) -->
  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">🛒</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay">
    <div id="cart-popup" role="dialog" aria-modal="true">
      <h3>Confirmar pedido</h3>
      <div id="cart-items-container"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
      <div class="actions">
        <button class="small-btn" id="cart-close">Seguir comprando</button>
        <button class="confirm-btn" id="cart-confirm">Confirmar y enviar por WhatsApp</button>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; 
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
let lastProductsCache = [];
let lastLoadedSheetKey = null;

function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}

/* ---------- Mostrar precio: formatea números con puntos de miles ---------- */
function fmtPrice(v){
  if (v===undefined || v===null) return '-';
  const s = String(v).trim();
  if (s === '') return '-';
  const n = parsePriceNumber(s);
  if (/^[\d\.\,]+$/.test(s)) {
    return Number(n).toLocaleString('de-DE');
  }
  return s;
}

function parsePriceNumber(v){
  if (v === undefined || v === null) return 0;
  if (typeof v === 'number' && !isNaN(v)) return v;
  let s = String(v).trim();
  if (s === '') return 0;
  s = s.replace(/\s+/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  s = s.replace(/[^0-9.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

function parsePriceFromCardText(txt){
  if (!txt) return 0;
  let s = String(txt).replace(/\$/g, '').trim();
  return parsePriceNumber(s);
}

/* ----------------- Carrito (editar/eliminar y reserva visual de stock) ----------------- */
const WHATSAPP_NUMBER = '573207378992';
let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

const cartBtn = document.getElementById('cart-btn');
const cartCountEl = document.getElementById('cart-count');
const cartSummaryEl = document.getElementById('cart-summary');
const cartOverlay = document.getElementById('cart-popup-overlay');
const cartItemsContainer = document.getElementById('cart-items-container');
const cartTotalEl = document.getElementById('cart-total');
const cartCloseBtn = document.getElementById('cart-close');
const cartConfirmBtn = document.getElementById('cart-confirm');

function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

function getOriginalStock(sheetKey, row){
  const card = Array.from(document.querySelectorAll('.card')).find(c => {
    const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
    const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
    return sk === (sheetKey||'') && rrow === (row||'').toString();
  });
  if(card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);
  if(window.lastProductsCache && Array.isArray(window.lastProductsCache)){
    const p = window.lastProductsCache.find(pp => String(pp.row) === String(row));
    if(p){
      const d = p.data || {};
      const stock = firstKeyValue(d, ['stock','cantidad']) || 0;
      return Number(stock || 0);
    }
  }
  return 0;
}

function getReservedQty(sheetKey, row){
  return cart.filter(i => i.sheetKey === sheetKey && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
}

function refreshCardStockDisplay(sheetKey, row){
  const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
    const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
    const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
    return sk === (sheetKey||'') && rrow === (row||'').toString();
  });
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey, row);
  const avail = Math.max(0, origStock - reserved);
  cards.forEach(card => {
    const stockSpan = card.querySelector('.stockval');
    if(stockSpan) stockSpan.innerText = avail;
    const orderBtn = card.querySelector('.order');
    if(avail <= 0){
      card.classList.add('out');
      if(orderBtn) orderBtn.disabled = true;
    } else {
      card.classList.remove('out');
      if(orderBtn) orderBtn.disabled = false;
    }
  });
}

function updateCartUI(){
  const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  cartCountEl.innerText = count;
  cartSummaryEl.innerText = `Carrito ${count>0? '• ' + count + ' items':''}`;
  if(cartBtn) cartBtn.style.display = 'flex';
  if(cartBtn) cartBtn.title = count ? `${count} item(s) en carrito — Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vacío';
  saveCart();
}

function addToCart(card, qty){
  const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
  const row = card.dataset.row;
  const name = card.querySelector('.name')?.innerText || 'Sin nombre';
  const priceRaw = card.dataset.price !== undefined ? card.dataset.price : (card.querySelector('.price')?.innerText || '');
  const priceNum = parsePriceNumber(priceRaw);
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey,row);
  const available = Math.max(0, origStock - reserved);

  if(qty > available){
    alert('No hay suficiente stock disponible.');
    return;
  }

  const key = `${sheetKey}::${row}`;
  const existing = cart.find(i=>cartItemKey(i) === key);
  if(existing){
    existing.qty = Math.min(origStock, existing.qty + qty);
  } else {
    cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
  }

  refreshCardStockDisplay(sheetKey,row);
  updateCartUI();
}

function renderCartModal(){
  cartItemsContainer.innerHTML = '';
  if(cart.length === 0){
    cartItemsContainer.innerHTML = `<div class="empty-msg">El carrito está vacío</div>`;
    cartTotalEl.innerText = '';
    return;
  }

  cart.forEach((it, index) => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    const left = document.createElement('div');
    left.className = 'left';
    left.innerHTML = `<strong>${it.name}</strong><div style="font-size:13px;color:#666">Precio: $ ${fmtPrice(it.price)} · Nota: ${it.sheetKey}</div>`;

    const right = document.createElement('div');
    right.className = 'right';
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.flexDirection = 'column';
    controls.style.alignItems = 'flex-end';
    controls.innerHTML = `
      <div style="display:flex;gap:6px;align-items:center">
        <button class="small-btn cart-minus" data-idx="${index}">-</button>
        <span class="cart-qty" data-idx="${index}">${it.qty}</span>
        <button class="small-btn cart-plus" data-idx="${index}">+</button>
      </div>
      <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
        <div style="font-weight:700">$ ${Number(parsePriceNumber(it._priceNum !== undefined ? it._priceNum : it.price) * Number(it.qty)).toLocaleString('de-DE')}</div>
        <button class="small-btn cart-remove" data-idx="${index}">Eliminar</button>
      </div>
    `;
    right.appendChild(controls);
    div.appendChild(left); div.appendChild(right);
    cartItemsContainer.appendChild(div);
  });

  const total = cart.reduce((s,i)=>s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)),0);
  cartTotalEl.innerText = 'Total: $ ' + Number(total).toLocaleString();

  Array.from(cartItemsContainer.querySelectorAll('.cart-minus')).forEach(btn=>{
    btn.onclick = (e)=>{
      const idx = Number(btn.dataset.idx);
      if(isNaN(idx)) return;
      if(cart[idx].qty > 1){
        cart[idx].qty = cart[idx].qty - 1;
        refreshCardStockDisplay(cart[idx].sheetKey, cart[idx].row);
        saveCart(); updateCartUI(); renderCartModal();
      } else {
        const it = cart[idx];
        cart.splice(idx,1);
        refreshCardStockDisplay(it.sheetKey, it.row);
        saveCart(); updateCartUI(); renderCartModal();
      }
    };
  });

  Array.from(cartItemsContainer.querySelectorAll('.cart-plus')).forEach(btn=>{
    btn.onclick = (e)=>{
      const idx = Number(btn.dataset.idx);
      if(isNaN(idx)) return;
      const it = cart[idx];
      const orig = getOriginalStock(it.sheetKey, it.row);
      if(Number(it.qty) < orig){
        it.qty = Number(it.qty) + 1;
        refreshCardStockDisplay(it.sheetKey, it.row);
        saveCart(); updateCartUI(); renderCartModal();
      } else {
        alert('No hay más stock disponible para aumentar la cantidad.');
      }
    };
  });
  Array.from(cartItemsContainer.querySelectorAll('.cart-remove')).forEach(btn=>{
    btn.onclick = (e)=>{
      const idx = Number(btn.dataset.idx);
      if(isNaN(idx)) return;
      const it = cart[idx];
      cart.splice(idx,1);
      refreshCardStockDisplay(it.sheetKey, it.row);
      saveCart(); updateCartUI(); renderCartModal();
    };
  });
}

function openCartModal(){
  if(cart.length === 0){
    alert('El carrito está vacío');
    return;
  }
  renderCartModal();
  if(cartOverlay) cartOverlay.style.display = 'flex';
}

function closeCartModal(){ if(cartOverlay) cartOverlay.style.display = 'none'; }

async function sendOrderAndWhatsapp(){
  if(cart.length === 0) return alert('Carrito vacío');
  cartConfirmBtn.disabled = true;
  cartConfirmBtn.innerText = 'Procesando...';

  try{
    const promises = cart.map(it => {
      const form = new URLSearchParams();
      form.append('action','decrement');
      form.append('sheetKey', it.sheetKey);
      form.append('row', it.row);
      form.append('amount', it.qty);
      return fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form })
        .then(r=>r.json())
        .then(res => {
          if(res.error) throw new Error(res.message || 'Error API');
          return { ok:true, ...res, item: it };
        });
    });

    const results = await Promise.all(promises);

    results.forEach(r => {
      const it = r.item;
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === it.sheetKey && rrow === it.row.toString();
      });
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan && typeof r.newStock !== 'undefined'){
          card.dataset.origStock = Number(r.newStock);
          stockSpan.innerText = Number(r.newStock);
          const orderBtn = card.querySelector('.order');
          if(Number(r.newStock) <= 0){
            card.classList.add('out');
            if(orderBtn) orderBtn.disabled = true;
          } else {
            card.classList.remove('out');
            if(orderBtn) orderBtn.disabled = false;
          }
        }
      });
    });

    let msg = 'buenas noches, me interesaria comprar:%0A';
    cart.forEach(it => {
      msg += `- ${it.name}, precio: $ ${fmtPrice(it.price)}, cantidad: ${it.qty}%0A`;
    });
    msg += '%0Amuchas gracias';

    if(!WHATSAPP_NUMBER || WHATSAPP_NUMBER.includes('WHATSAPP_NUMBER_HERE')){
      alert('Por favor reemplaza WHATSAPP_NUMBER_HERE por el número de destino en el script.');
    } else {
      const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      window.open(waUrl, '_blank');
    }

    cart = [];
    saveCart();
    updateCartUI();
    closeCartModal();
  }catch(err){
    alert('Error al procesar el pedido: ' + (err.message || err));
  }finally{
    cartConfirmBtn.disabled = false;
    cartConfirmBtn.innerText = 'Confirmar y enviar por WhatsApp';
  }
}

if(cartCloseBtn) cartCloseBtn.onclick = closeCartModal;
if(cartConfirmBtn) cartConfirmBtn.onclick = sendOrderAndWhatsapp;
if(cartBtn) cartBtn.onclick = openCartModal;

updateCartUI();

/* ----------------- Cargar categorías y renderProductos (con soporte de reservas) -----------------*/
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inválida");
    renderTabs(data.sheets);
  } catch(err){
    if(tabsEl) tabsEl.innerHTML = 'Error cargando categorías';
  }
}
function renderTabs(sheets){
  if(!tabsEl) return;
  tabsEl.innerHTML = '';

  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsEl.appendChild(allBtn);

  sheets.forEach((s, i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
  });

  loadProductsAll();
}

async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  if(contentEl) contentEl.innerHTML = 'Cargando...';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ if(contentEl) contentEl.innerHTML='Error cargando productos'; }
}

async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  if(contentEl) contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, "ALL");
  } catch(err){ if(contentEl) contentEl.innerHTML='Error cargando productos'; }
}

function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* helper: crear icono usando el image-proxy del worker (limpio, sin logs) */
function createIconElementUsingProxy(rawIcon, name, fallbackEmoji = '🛍️') {
  const wrapper = document.createElement('div');
  wrapper.style.display = 'inline-block';
  wrapper.style.verticalAlign = 'middle';
  wrapper.style.width = '60px';
  wrapper.style.height = '60px';
  wrapper.style.flex = '0 0 60px';

  const fallback = document.createElement('div');
  fallback.className = 'icon-fallback';
  fallback.style.width = '60px';
  fallback.style.height = '60px';
  fallback.style.lineHeight = '60px';
  fallback.style.textAlign = 'center';
  fallback.style.borderRadius = '50%';
  fallback.style.display = 'flex';
  fallback.style.alignItems = 'center';
  fallback.style.justifyContent = 'center';
  fallback.style.fontSize = '26px';
  fallback.innerText = (rawIcon && !/^(https?:)?\/\//i.test(rawIcon)) ? rawIcon : fallbackEmoji;
  wrapper.appendChild(fallback);

  if (rawIcon && typeof rawIcon === 'string' && /^(https?:)?\/\//i.test(rawIcon)) {
    const prox = API_URL + 'image-proxy?url=' + encodeURIComponent(rawIcon);
    const img = new Image();
    img.className = 'product-img';
    img.alt = name || 'imagen';
    img.style.width = '60px';
    img.style.height = '60px';
    img.style.objectFit = 'cover';
    img.style.display = 'block';
    img.style.borderRadius = '50%';
    img.referrerPolicy = 'no-referrer';

    img.onload = () => {
      wrapper.insertBefore(img, fallback);
      fallback.style.display = 'none';
    };
    img.onerror = () => {
      img.remove();
    };

    img.src = prox;
  }

  return wrapper;
}

/* renderProducts (ahora usa la sheetKey real del producto cuando esté disponible) */
function renderProducts(products, sheetKey){
  if (!products || !products.length){
    if(contentEl) contentEl.innerHTML = 'No hay productos';
    return;
  }
  const grid = document.createElement('div'); 
  grid.className='grid';

  products.forEach(p=>{
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad']) || 0);
    const rawIcon = firstKeyValue(d, ['icon','emoji','image','img','icono','imagen','foto','url']) || '🛍️';
    const cat  = firstKeyValue(d, ['category','categoria']) || '';

    // Determinar sheetKey del producto (prioridad: p.sheetKey | p.data.sheetKey | sheetKey arg | fallback categoria)
    const productSheetKey = p.sheetKey || d.sheetKey || d.SheetKey || (sheetKey === "ALL" ? (d.Categoria || d.categoria || d.category || 'UNKNOWN') : sheetKey);

    const card = document.createElement('div');
    card.className='card'+(stock<=0?' out':'');
    card.dataset.origStock = stock;
    card.dataset.price = price;
    card.dataset.row = p.row;
    card.dataset.sheetKey = productSheetKey;

    const reserved = getReservedQty(card.dataset.sheetKey, card.dataset.row);
    const available = Math.max(0, stock - reserved);

    card.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;flex-direction:column">
        <div class="icon-placeholder"></div>
        <div style="flex:1;width:100%">
          <div class="name">${escapeHtml(name)}</div>
          <div class="cat">${escapeHtml(cat)}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${available}</span></div>
      </div>
      <div class="actions">
        <button class="small minus">-</button>
        <span class="qty">1</span>
        <button class="small plus">+</button>
        <button class="btn order" ${available<=0?'disabled':''}>Pedir</button>
      </div>`;

    const placeholder = card.querySelector('.icon-placeholder');
    const iconEl = createIconElementUsingProxy(rawIcon, name, '🛍️');
    if (placeholder) placeholder.replaceWith(iconEl);

    const qtyEl = card.querySelector('.qty');
    const minusBtn = card.querySelector('.minus');
    const plusBtn = card.querySelector('.plus');
    const orderBtn = card.querySelector('.order');

    let qty = 1;
    minusBtn.onclick = ()=>{ if(qty>1){ qty--; qtyEl.innerText=qty; } };
    plusBtn.onclick = ()=>{ if(qty < available){ qty++; qtyEl.innerText=qty; } };
    orderBtn.onclick = ()=> {
      addToCart(card, qty);
      qty = 1; qtyEl.innerText = qty;
    };

    if(available <= 0) card.classList.add('out');

    grid.appendChild(card);
  });

  if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
}

loadCategories();
</script>

</body>
</html>

