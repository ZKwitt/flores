<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo Bonnie Makeup</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,Arial;
      background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
      min-height:100vh;
      padding:20px;
      overflow-x:hidden;
      color:#111;
    }

    /* Header */
    .header{text-align:center;margin-bottom:30px;position:relative}
    .header::before{
      content:'';position:absolute;top:-20px;left:50%;
      transform:translateX(-50%);
      width:100px;height:4px;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);
      border-radius:2px;
    }
    .header h1{
      font-size:3rem;
      background:linear-gradient(45deg,#667eea,#764ba2,#ff6b6b);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 4px 20px rgba(0,0,0,0.1);
      margin-bottom:8px;
    }
    .header p{font-size:1.1rem;color:#555;font-style:italic}

    /* Tabs (categor√≠as) */
    #tabs{
      display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
      margin-bottom:24px;
    }
    .tab{
      background:rgba(255,255,255,0.9);
      padding:10px 20px;
      border-radius:25px;
      border:2px solid transparent;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      color:#666;
    }
    .tab:hover,.tab.active{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(102,126,234,.3);
    }

    /* Productos grid */
    #content{min-height:160px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:20px;
    }

    .card{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(15px);
      border-radius:20px;
      padding:20px;
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 12px 30px rgba(0,0,0,0.08);
      transition:.35s cubic-bezier(0.175,0.885,0.32,1.275);
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:-100%;
      width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
      transition:.5s;
    }
    .card:hover{transform:translateY(-6px) scale(1.02)}
    .card:hover::before{left:100%}
    .card.out{opacity:.5}

    /* Contenedor inferior */
    .card-footer{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    .icon{
      width:60px;height:60px;
      border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:26px;
      background:linear-gradient(45deg,#667eea,#764ba2);
      margin:0 auto 12px;
      color:#fff;
      box-shadow:0 6px 18px rgba(102,126,234,0.3);
    }
    .name{font-weight:700;font-size:1.05rem;text-align:center;min-height:40px}
    .cat{font-size:12px;color:#888;text-align:center}
    .price{
      font-size:1.6rem;font-weight:700;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-align:center;
    }
    .stock{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;font-size:.9rem;font-weight:600;
      padding:6px 14px;border-radius:20px;
      margin:0 auto;
      box-shadow:0 4px 12px rgba(102,126,234,0.25);
    }

    .actions{display:flex;gap:8px;margin-top:8px;align-items:center;justify-content:center}
    button.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    button.order{background:#111;color:#fff}
    button.order[disabled]{opacity:.5;cursor:not-allowed}
    button.small{padding:6px 8px;border:1px solid #ddd;background:#fff}
    .qty{min-width:20px;text-align:center;font-weight:600}

    /* Debug */
    #debug{
      margin-top:20px;background:#fff;
      padding:12px;border-radius:10px;
      border:1px solid #eee;
      white-space:pre-wrap;font-size:13px;color:#222;
      max-width:1100px;margin-left:auto;margin-right:auto;
    }

    /* Loading styles */
    #tabs, #content{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      font-weight:600;
      color:#555;
      font-style:italic;
      text-align:center;
      padding:20px;
    }

    /* Floating emojis */
    .floating-shapes{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
    .shape{position:absolute;opacity:.08;animation:float 6s ease-in-out infinite;font-size:2rem}
    .shape:nth-child(1){top:20%;left:10%;animation-delay:0s}
    .shape:nth-child(2){top:60%;left:80%;animation-delay:2s}
    .shape:nth-child(3){top:30%;left:60%;animation-delay:4s}
    @keyframes float{
      0%,100%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-20px) rotate(180deg)}
    }
  </style>
</head>
<body>
  <div class="floating-shapes">
    <div class="shape">üíÑ</div>
    <div class="shape">‚ú®</div>
    <div class="shape">üíã</div>
  </div>

  <div class="header">
    <h1>üíÑ Marrie</h1>
    <p>Belleza que inspira, calidad que perdura</p>
  </div>

  <div id="app">
    <div id="tabs">Cargando categor√≠as...</div>
    <div id="content">Cargando productos...</div>
    <div id="debug">Debug: ‚Äî</div>
  </div>
<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; 
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const debugEl = document.getElementById('debug');
let lastProductsCache = [];
let lastLoadedSheetKey = null;

function dbg(txt){ debugEl.innerText = txt; console.log(txt); }

function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function fmtPrice(v){ return (v===''||v==null) ? '-' : Number(v).toLocaleString(); }

/* ======= Cargar categor√≠as ======= */
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida");
    renderTabs(data.sheets);
  } catch(err){
    tabsEl.innerHTML = 'Error cargando categor√≠as';
    dbg(err);
  }
}
function renderTabs(sheets){
  tabsEl.innerHTML = '';

  // Bot√≥n especial "Todos"
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsEl.appendChild(allBtn);

  // Resto de categor√≠as
  sheets.forEach((s, i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
  });

  // üöÄ Cargar "Todos" autom√°ticamente al inicio
  loadProductsAll();
}

/* ======= Cargar productos ======= */
async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  contentEl.innerHTML = 'Cargando...';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, "ALL");
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

function renderProducts(products, sheetKey){
  if (!products.length){ 
    contentEl.innerHTML='No hay productos'; 
    return; 
  }
  const grid = document.createElement('div'); 
  grid.className='grid';

  products.forEach(p=>{
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || 'üõçÔ∏è';
    const cat  = firstKeyValue(d, ['category','categoria']) || '';

    const card = document.createElement('div');
    card.className='card'+(stock<=0?' out':'');

    // ‚úÖ Si no hay sheetKey expl√≠cito (caso "todos"), usamos la categor√≠a
    card.dataset.row = p.row; 
    card.dataset.sheetKey = (sheetKey === "ALL") ? cat : sheetKey;

    card.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <div class="icon">${icon}</div>
        <div style="flex:1">
          <div class="name">${name}</div>
          <div class="cat">${cat}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div class="actions">
        <button class="small minus">-</button>
        <span class="qty">1</span>
        <button class="small plus">+</button>
        <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
      </div>`;

    const qtyEl = card.querySelector('.qty');
    const minusBtn = card.querySelector('.minus');
    const plusBtn = card.querySelector('.plus');
    const orderBtn = card.querySelector('.order');
    const stockSpan = card.querySelector('.stockval');

    let qty = 1;
    minusBtn.onclick = ()=>{ if(qty>1){ qty--; qtyEl.innerText=qty; } };
    plusBtn.onclick = ()=>{ if(qty < stock){ qty++; qtyEl.innerText=qty; } };
    orderBtn.onclick = ()=>handleOrder(card, qty);

    grid.appendChild(card);
  });

  contentEl.innerHTML=''; 
  contentEl.appendChild(grid);
}

/* ======= Pedir producto ======= */
async function handleOrder(card, qty){
  const sheetKey = card.dataset.sheetKey;
  const row = card.dataset.row;
  const stockSpan = card.querySelector('.stockval');
  const before = Number(stockSpan.innerText||0);
  if (before<=0){ alert('Sin stock'); return; }
  if (qty > before){ alert('No hay suficiente stock'); return; }

  const btn = card.querySelector('.order');
  btn.disabled=true; btn.innerText='...';
  try{
    const form=new URLSearchParams();
    form.append('action','decrement');
    form.append('sheetKey',sheetKey);
    form.append('row',row);
    form.append('amount', qty); // enviar cantidad
    const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form});
    const data=await r.json();
    if (data.error) throw new Error(data.message);
    const newStock=Number(data.newStock);
    stockSpan.innerText=newStock;
    if (newStock<=0){ card.classList.add('out'); btn.disabled=true; }
    btn.innerText='Pedir';
  }catch(err){ dbg(err); alert('Error pedido'); btn.disabled=false; btn.innerText='Pedir'; }
}

/* ======= Init ======= */
loadCategories();
</script>
</body>
</html>
