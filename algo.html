<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo — Marrie</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg1: #fff6f8;
      --bg2: #fffaf7;
      --muted: #7a7a85;
      --soft-shadow: 0 18px 48px rgba(34,34,60,0.06);
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255,230,240,0.6), transparent 10%),
                  radial-gradient(800px 400px at 90% 80%, rgba(230,245,255,0.45), transparent 10%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:36px;
      color:#111;
    }

    /* background blobs */
    .bg-blob{ position:fixed; pointer-events:none; z-index:0; filter: blur(40px); opacity:.14; animation: floatBlob 10s ease-in-out infinite; }
    .bg-blob.b1{ width:420px;height:420px;background:linear-gradient(135deg,#ffd1e8,#ffd6b3); left:-80px; top:-60px; transform:rotate(20deg); }
    .bg-blob.b2{ width:360px;height:360px;background:linear-gradient(135deg,#cfe7ff,#c9ffd9); right:-90px; bottom:-80px; animation-delay:3s; transform:rotate(-10deg) }
    @keyframes floatBlob{ 0% {transform: translateY(0) scale(1)} 50% {transform: translateY(-18px) scale(1.02)} 100% {transform: translateY(0) scale(1)} }

    .header{text-align:center;margin-bottom:22px;position:relative;z-index:1}
    .header h1{
      font-size:2.2rem;
      background:linear-gradient(90deg,#ff9ab3,#9ad1ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .header p{color:var(--muted);font-size:1rem}

    /* Tabs */
    #tabs{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:12px 0 20px;z-index:1;position:relative}
    .tab{
      background:rgba(255,255,255,0.95);
      padding:8px 14px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);
      font-weight:700;cursor:pointer;color:#444;transition:all .25s;
      box-shadow:0 8px 22px rgba(26,22,66,0.03);
    }
    .tab:hover{transform:translateY(-3px)}
    .tab.active{background:linear-gradient(90deg,#ffd1e8,#cfe7ff); color:#222; box-shadow:0 14px 34px rgba(102,126,234,0.07)}

    /* content container centered and responsive grid */
    #content { max-width:1200px; margin: 0 auto; min-height:160px; text-align:center; z-index:1; }
    .loading { text-align:center; padding:40px 0; color:var(--muted); font-weight:700; }

    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap:22px; align-items:start; }

    /* Card */
    .card { position:relative; perspective:900px; }
    .flip-inner {
      position:relative;
      width:100%;
      min-height:420px; /* fixed height to avoid reflow when switching */
      border-radius:20px;
      overflow:visible;
      transition: none;
    }
    .face {
      position:absolute;
      inset:0;
      border-radius:20px;
      overflow:hidden;
      box-shadow: var(--soft-shadow);
      transition: opacity .32s ease, transform .32s ease, visibility .32s;
      background: linear-gradient(180deg, rgba(255,255,255,0.99), rgba(255,255,255,0.97));
      border:1px solid rgba(0,0,0,0.035);
      display:flex;flex-direction:column;justify-content:space-between;
      padding-bottom:16px;
      backface-visibility:hidden;
    }
    .face.front{ opacity:1; transform: translateY(0); visibility:visible; z-index:2; position:relative; }
    .face.back{ opacity:0; transform: translateY(6px); visibility:hidden; z-index:1; }

    .flip-inner.flipped .face.front{ opacity:0; transform: translateY(-6px); visibility:hidden; z-index:1; }
    .flip-inner.flipped .face.back{ opacity:1; transform: translateY(0); visibility:visible; z-index:2; }

    /* eye toggle */
    .eye-toggle {
      position:absolute; left:12px; top:12px;
      width:44px;height:44px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,0.9);
      border:1px solid rgba(0,0,0,0.05);
      cursor:pointer; z-index:10; transition: transform .12s ease;
      box-shadow:0 12px 28px rgba(34,34,60,0.06);
    }
    .eye-toggle:active{ transform:scale(.97) }

    /* front image / icon circle */
    .front-image {
      width:120px;height:120px;border-radius:50%;overflow:hidden;margin:26px auto 12px;
      box-shadow:0 16px 42px rgba(34,34,60,0.06);
      border:8px solid rgba(255,255,255,0.92);
      background:linear-gradient(135deg,#fff,#fff);
      display:flex;align-items:center;justify-content:center;font-size:46px;
    }
    .product-img{ width:100%; height:100%; object-fit:cover; display:block }

    .name { font-weight:800; text-align:center; margin-top:6px; font-size:1.05rem; color:#222; padding:0 18px }
    .cat { font-size:12px; color:var(--muted); text-align:center; margin-top:6px }

    .meta { padding:8px 18px 0; display:flex;flex-direction:column; gap:10px; align-items:center }

    .price { font-size:1.4rem; font-weight:800; text-align:center; color:#333 }
    .stock { font-size:.88rem; padding:6px 14px; border-radius:18px; color:#fff; font-weight:800; background: linear-gradient(90deg,#9ad1ff,#b9ffd4) }

    .actions{display:flex;gap:10px;align-items:center;justify-content:center;padding:12px 18px 10px}
    .small{padding:8px 10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
    .qty{min-width:26px;text-align:center;font-weight:800}
    .btn.order { background:#111;color:#fff;padding:10px 14px;border-radius:14px;border:0;cursor:pointer; font-weight:900 }
    .btn.order[disabled]{opacity:.5;cursor:not-allowed}

    /* back face specifics: fits in same area, image contained */
    .back-image-wrap { width:100%; height:240px; border-radius:12px; overflow:hidden; display:flex;align-items:center;justify-content:center; background: linear-gradient(180deg,#fff,#fbfbff); margin:10px 12px 6px; }
    .back-image { width:100%; height:100%; object-fit:contain; display:block; cursor:zoom-in }
    .desc-box { width:calc(100% - 24px); max-height:110px; overflow:auto; margin:0 12px 10px; padding:12px; border-radius:12px; background: linear-gradient(180deg,#fff,#fff); border:1px solid rgba(0,0,0,0.04); font-size:0.95rem; color:#333 }

    /* modal for full-size image */
    #img-modal-overlay { position:fixed; inset:0; display:none; background:rgba(0,0,0,0.65); align-items:center; justify-content:center; z-index:20000; padding:18px; }
    #img-modal { max-width:95vw; max-height:95vh; overflow:auto; border-radius:12px; box-shadow:0 20px 80px rgba(0,0,0,0.6); background:#fff; display:flex;flex-direction:column; align-items:center; justify-content:center; }
    #img-modal img { max-width:100%; max-height:85vh; object-fit:contain; display:block; border-radius:6px; }

    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
      .front-image{ width:100px;height:100px }
      .flip-inner{ min-height:380px }
      .back-image-wrap{height:180px}
    }
  </style>
</head>
<body>
  <div class="bg-blob b1" aria-hidden="true"></div>
  <div class="bg-blob b2" aria-hidden="true"></div>

  <div class="header">
    <h1>💄 Marrie</h1>
    <p>Belleza suave · pedidos rápidos</p>
  </div>

  <div id="app" style="position:relative;z-index:1">
    <div id="tabs">Cargando categorías...</div>
    <div id="content"><div class="loading">Cargando productos...</div></div>
  </div>

  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">🛒</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay" style="display:none">
    <div id="cart-popup" role="dialog" aria-modal="true">
      <h3>Confirmar pedido</h3>
      <div id="cart-items-container"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="cart-close" class="small">Seguir comprando</button>
        <button id="cart-confirm" class="btn order">Confirmar y enviar por WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- image modal -->
  <div id="img-modal-overlay" role="dialog" aria-hidden="true">
    <div id="img-modal">
      <button id="img-modal-close" class="small" style="align-self:flex-end;margin:8px;border-radius:8px">Cerrar</button>
      <img id="img-modal-img" alt="Imagen completa">
    </div>
  </div>

  <script>
    const API_URL = "https://d.thepersonmrt.workers.dev/";
    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');
    let lastProductsCache = [];
    let lastLoadedSheetKey = null;

    function firstKeyValue(obj, keys){
      if (!obj) return undefined;
      const map = {};
      Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
      for (let key of keys){
        const v = map[key.toLowerCase()];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return undefined;
    }

    function fmtPrice(v){
      if (v===undefined || v===null) return '-';
      const s = String(v).trim();
      if (s === '') return '-';
      const n = parsePriceNumber(s);
      if (/^[\d\.\,]+$/.test(s)) {
        return Number(n).toLocaleString('de-DE');
      }
      return s;
    }

    function parsePriceNumber(v){
      if (v === undefined || v === null) return 0;
      if (typeof v === 'number' && !isNaN(v)) return v;
      let s = String(v).trim();
      if (s === '') return 0;
      s = s.replace(/\s+/g, '');
      s = s.replace(/\./g, '');
      s = s.replace(/,/g, '.');
      s = s.replace(/[^0-9.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* Carrito (igual) */
    const WHATSAPP_NUMBER = '573207378992';
    let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

    const cartBtn = document.getElementById('cart-btn');
    const cartCountEl = document.getElementById('cart-count');
    const cartSummaryEl = document.getElementById('cart-summary');
    const cartOverlay = document.getElementById('cart-popup-overlay');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCloseBtn = document.getElementById('cart-close');
    const cartConfirmBtn = document.getElementById('cart-confirm');

    function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
    function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

    function getOriginalStock(sheetKey, row){
      const card = Array.from(document.querySelectorAll('.card')).find(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      if(card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);
      if(window.lastProductsCache && Array.isArray(window.lastProductsCache)){
        const p = window.lastProductsCache.find(pp => String(pp.row) === String(row));
        if(p){
          const d = p.data || {};
          const stock = firstKeyValue(d, ['stock','cantidad']) || 0;
          return Number(stock || 0);
        }
      }
      return 0;
    }

    function getReservedQty(sheetKey, row){
      return cart.filter(i => i.sheetKey === sheetKey && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
    }

    function refreshCardStockDisplay(sheetKey, row){
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey, row);
      const avail = Math.max(0, origStock - reserved);
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan) stockSpan.innerText = avail;
        const orderBtn = card.querySelector('.order');
        if(avail <= 0){
          card.classList.add('out');
          if(orderBtn) orderBtn.disabled = true;
        } else {
          card.classList.remove('out');
          if(orderBtn) orderBtn.disabled = false;
        }
      });
    }

    function updateCartUI(){
      const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
      const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
      cartCountEl.innerText = count;
      cartSummaryEl.innerText = `Carrito ${count>0? '• ' + count + ' items':''}`;
      if(cartBtn) cartBtn.style.display = 'flex';
      if(cartBtn) cartBtn.title = count ? `${count} item(s) en carrito — Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vacío';
      saveCart();
    }

    function addToCart(card, qty){
      const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
      const row = card.dataset.row;
      const name = card.querySelector('.name')?.innerText || 'Sin nombre';
      const priceRaw = card.dataset.price !== undefined ? card.dataset.price : (card.querySelector('.price')?.innerText || '');
      const priceNum = parsePriceNumber(priceRaw);
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey,row);
      const available = Math.max(0, origStock - reserved);

      if(qty > available){
        alert('No hay suficiente stock disponible.');
        return;
      }

      const key = `${sheetKey}::${row}`;
      const existing = cart.find(i=>cartItemKey(i) === key);
      if(existing){
        existing.qty = Math.min(origStock, existing.qty + qty);
      } else {
        cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
      }

      refreshCardStockDisplay(sheetKey,row);
      updateCartUI();
    }

    /* Modal image handlers */
    const imgModalOverlay = document.getElementById('img-modal-overlay');
    const imgModalImg = document.getElementById('img-modal-img');
    const imgModalClose = document.getElementById('img-modal-close');
    function openImageModal(url, alt){
      if(!url) return;
      imgModalImg.src = proxiedUrl(url);
      imgModalImg.alt = alt || '';
      imgModalOverlay.style.display = 'flex';
      imgModalOverlay.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeImageModal(){
      imgModalOverlay.style.display = 'none';
      imgModalOverlay.setAttribute('aria-hidden','true');
      imgModalImg.src = '';
      document.body.style.overflow = '';
    }
    imgModalClose.addEventListener('click', closeImageModal);
    imgModalOverlay.addEventListener('click', (e)=>{ if(e.target === imgModalOverlay) closeImageModal(); });

    /* utilities */
    function escapeHtml(str){
      if(str === undefined || str === null) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function proxiedUrl(raw){
      if(!raw || typeof raw !== 'string') return '';
      return API_URL + 'image-proxy?url=' + encodeURIComponent(raw);
    }
    function makeImgEl(raw, alt, className){
      const img = document.createElement('img');
      img.alt = alt || '';
      img.className = className || '';
      try { img.src = proxiedUrl(raw); } catch(e){ img.src = ''; }
      img.onerror = () => { img.remove(); };
      return img;
    }

    /* Render products — now reads icono (emoji) for front and img (url) for back */
    function renderProducts(products, sheetKey){
      if (!products || !products.length){
        if(contentEl) contentEl.innerHTML = '<div class="loading">No hay productos</div>';
        return;
      }
      const grid = document.createElement('div');
      grid.className='grid';

      products.forEach(p=>{
        const d = p.data || {};
        const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || 'Sin nombre';
        const price = firstKeyValue(d, ['price','precio','Precio']) || '';
        const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || 0);

        // icono = emoji / texto corto para el círculo frontal
        const emojiIcon = firstKeyValue(d, ['icono','Icono','icon','emoji']) || '🛍️';
        // img = url real para la cara posterior
        const imgUrl = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || '';

        const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota']) || '';
        const productSheetKey = p.sheetKey || d.sheetKey || d.SheetKey || (sheetKey === "ALL" ? (d.Descripcion || d.descripcion || d.Categoria || d.categoria || d.category || 'UNKNOWN') : sheetKey);

        const cardWrap = document.createElement('div');
        cardWrap.className = 'card';
        cardWrap.dataset.origStock = stock;
        cardWrap.dataset.price = price;
        cardWrap.dataset.row = p.row;
        cardWrap.dataset.sheetKey = productSheetKey;

        const inner = document.createElement('div');
        inner.className = 'flip-inner';

        const front = document.createElement('div');
        front.className = 'face front';
        front.innerHTML = `
          <div style="position:relative;padding:12px;">
            <button class="eye-toggle" aria-pressed="false" title="Ver imagen y descripción" type="button" aria-label="Ver imagen y descripción">
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#333" stroke-width="1.2"/>
              </svg>
            </button>

            <div class="front-image"></div>

            <div class="meta">
              <div class="name">${escapeHtml(name)}</div>
              <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px">
                <div class="price">$ ${fmtPrice(price)}</div>
                <div class="stock">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></div>
              </div>
            </div>
          </div>

          <div style="padding:0 14px 14px">
            <div class="actions">
              <button class="small minus">-</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        `;

        const back = document.createElement('div');
        back.className = 'face back';
        back.innerHTML = `
          <div style="position:relative;padding:10px 12px 6px">
            <button class="eye-toggle" aria-pressed="true" title="Volver" type="button" aria-label="Volver">
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3l18 18" stroke="#333" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12s4-7 10-7 10 7 10 7" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="back-image-wrap"></div>
          <div style="padding:12px">
            <div class="desc-box">${escapeHtml(description || 'Sin descripción')}</div>
          </div>

          <div style="height:12px"></div>
        `;

        inner.appendChild(front);
        inner.appendChild(back);
        cardWrap.appendChild(inner);
        grid.appendChild(cardWrap);

        // populate front circle with emojiIcon (if it's a URL we still show as emoji fallback)
        const frontImageWrap = front.querySelector('.front-image');
        if (emojiIcon && typeof emojiIcon === 'string' && !/^(https?:)?\/\//i.test(emojiIcon)) {
          // treat as emoji / text
          const span = document.createElement('div');
          span.style.fontSize = '46px';
          span.style.lineHeight = '1';
          span.innerText = emojiIcon;
          frontImageWrap.appendChild(span);
        } else if (emojiIcon && typeof emojiIcon === 'string') {
          // rare: if icono is a url treat as image small
          const smallImg = makeImgEl(emojiIcon, name, 'product-img');
          frontImageWrap.appendChild(smallImg);
        }

        // back image: only from imgUrl
        const backImageWrap = back.querySelector('.back-image-wrap');
        if (imgUrl && typeof imgUrl === 'string' && /^(https?:)?\/\//i.test(imgUrl)) {
          const imgLarge = makeImgEl(imgUrl, name, 'back-image');
          imgLarge.addEventListener('click', (e)=>{ e.stopPropagation(); openImageModal(imgUrl, name); });
          backImageWrap.appendChild(imgLarge);
        } else {
          backImageWrap.innerHTML = `<div style="padding:20px;color:#999">Imagen no disponible</div>`;
        }

        // toggles (only click)
        const eyeFront = front.querySelector('.eye-toggle');
        const eyeBack = back.querySelector('.eye-toggle');

        function showBack(){
          inner.classList.add('flipped'); // hides order (order only in front)
        }
        function showFront(){
          inner.classList.remove('flipped');
        }

        eyeFront.addEventListener('click', (e)=>{ e.stopPropagation(); showBack(); });
        eyeBack.addEventListener('click', (e)=>{ e.stopPropagation(); showFront(); });

        // close back if click outside content area inside the card (keeps layout stable)
        cardWrap.addEventListener('click', (ev) => {
          if (inner.classList.contains('flipped')) {
            const targetIsInsideBack = back.contains(ev.target);
            if (!targetIsInsideBack) showFront();
          }
        });

        // quantity controls
        const minusBtns = cardWrap.querySelectorAll('.minus');
        const plusBtns = cardWrap.querySelectorAll('.plus');
        const qtySpans = cardWrap.querySelectorAll('.qty');
        minusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const current = Number(qtySpans[0].innerText || '1');
          if(current > 1){ qtySpans.forEach(s=>s.innerText = current - 1); }
        }));
        plusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const orig = getOriginalStock(cardWrap.dataset.sheetKey, cardWrap.dataset.row);
          const current = Number(qtySpans[0].innerText || '1');
          if(current < Math.max(0, orig - getReservedQty(cardWrap.dataset.sheetKey, cardWrap.dataset.row))){
            qtySpans.forEach(s=>s.innerText = current + 1);
          }
        }));

        // order buttons (only front)
        const orderBtns = cardWrap.querySelectorAll('.order');
        orderBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const qty = Number(cardWrap.querySelector('.qty').innerText || '1');
          addToCart(cardWrap, qty);
        }));

        showFront();
      });

      if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
    }

    /* load categories / tabs (same behavior) */
    async function loadCategories(){
      try {
        const r = await fetch(API_URL, {cache:'no-store'});
        const data = await r.json();
        if (!data.sheets) throw new Error("Respuesta inválida");
        renderTabs(data.sheets);
      } catch(err){
        if(tabsEl) tabsEl.innerHTML = 'Error cargando categorías';
        console.error(err);
      }
    }

    function renderTabs(sheets){
      if(!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.className = 'tab active';
      allBtn.innerText = "Todos";
      allBtn.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        allBtn.classList.add('active');
        loadProductsAll();
      };
      tabsEl.appendChild(allBtn);

      sheets.forEach((s)=>{
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.innerText = s.key;
        btn.dataset.key = s.key;
        btn.onclick = ()=> {
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          loadProductsFor(s.key);
        };
        tabsEl.appendChild(btn);
      });

      loadProductsAll();
    }

    async function loadProductsFor(sheetKey){
      lastLoadedSheetKey = sheetKey;
      if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando...</div>';
      try {
        const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, sheetKey);
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='<div class="loading">Error cargando productos</div>'; }
    }

    async function loadProductsAll(){
      lastLoadedSheetKey = "ALL";
      if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando todos los productos... (puede tardar)</div>';
      try {
        const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, "ALL");
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='<div class="loading">Error cargando productos</div>'; }
    }

    // init
    loadCategories();
    updateCartUI();
  </script>
</body>
</html>
