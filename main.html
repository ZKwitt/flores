<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WyvernStore</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            position: relative;
            color: #fff;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(75, 0, 130, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(75, 0, 130, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(75, 0, 130, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        header {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem 2rem;
            box-shadow: 0 2px 30px rgba(75, 0, 130, 0.4);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid rgba(75, 0, 130, 0.5);
        }
        nav { display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto; position: relative; z-index: 1; }
        .logo {
            font-size:2rem;
            font-weight:900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(75, 0, 130, 0.8);
        }
        .logo::before {
            content: 'ü¶∏';
            filter: grayscale(100%) brightness(0) invert(1);
            margin-right: 0.5rem;
        }
        .nav-links { display:flex; gap:2.5rem; list-style:none; }
        .nav-links a {
            text-decoration:none;
            color:#fff;
            font-weight:600;
            transition:all .3s;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .nav-links a:hover {
            color:#7B2CBF;
            text-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }

        .search-container { max-width:600px; margin:2.5rem auto; position:relative; z-index: 1; }
        .search-bar {
            width:100%;
            padding:1rem 3rem 1rem 1.5rem;
            border:2px solid rgba(75, 0, 130, 0.4);
            border-radius:8px;
            font-size:1rem;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition:all .3s;
            color: #fff;
        }
        .search-bar::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-bar:focus {
            outline:none;
            border-color: #7B2CBF;
            box-shadow:0 4px 30px rgba(75, 0, 130, 0.5);
            transform:translateY(-2px);
        }
        .search-btn {
            position:absolute;
            right:8px;
            top:50%;
            transform:translateY(-50%);
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            border:none;
            color:white;
            width:42px;
            height:42px;
            border-radius:6px;
            cursor:pointer;
            font-size:1.2rem;
            transition:all .3s;
            box-shadow: 0 4px 15px rgba(75, 0, 130, 0.5);
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .search-btn:hover {
            transform:translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.7);
        }

        .cart-icon {
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            color:white;
            padding:.8rem 1.8rem;
            border-radius:6px;
            cursor:pointer;
            transition:all .3s;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .cart-icon:hover {
            transform:translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.7);
        }
        .cart-icon::before {
            content: 'üõí ';
            filter: grayscale(100%) brightness(0) invert(1);
        }

        .container { max-width:1400px; margin:2rem auto; padding:0 2rem; position: relative; z-index: 1; }

        .carousel-section {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.3);
            border-radius:12px;
            padding:2.5rem;
            margin-bottom:3rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        /* Carrusel: contenedor cuadrado centrado para cada slide */
.carousel-item .carousel-img-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
  aspect-ratio: 1 / 1;      /* cuadrado */
  max-height: 450px;
  width: 100%;
  overflow: hidden;
  background: #0f0f0f;
  border-radius: 8px;
}

/* imagen dentro del cuadrado: mantener proporciones, no recortar */
.carousel-item .carousel-img{
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display:block;
}
        .carousel-title {
            text-align:center;
            font-size:2.2rem;
            color:#fff;
            margin-bottom:2rem;
            text-shadow:0 0 20px rgba(75, 0, 130, 0.8);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .carousel-container { position:relative; overflow:hidden; border-radius:8px; }
        .carousel { display:flex; transition:transform .5s ease-in-out; }
        .carousel-item { min-width:100%; position:relative; }
        .carousel-item img {
            display:block;
            width:100%;
            height:450px;
            object-fit:contain;
            border-radius:8px;
            background:#0f0f0f;
            border: 2px solid rgba(75, 0, 130, 0.3);
        }
        .carousel-caption {
            position:absolute;
            bottom:25px;
            left:25px;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            color:white;
            padding:1.2rem 2rem;
            border-radius:8px;
            border: 2px solid rgba(75, 0, 130, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        }
        .carousel-caption h3 { font-size:1.6rem; margin-bottom:.5rem; font-weight: 800; text-shadow: 0 0 10px rgba(75, 0, 130, 0.8); }
        .carousel-caption p { font-size:1.3rem; font-weight:bold; color: #9D4EDD; }
        .carousel-btn {
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            background:rgba(20, 20, 20, 0.9);
            border:2px solid rgba(75, 0, 130, 0.4);
            font-size:2rem;
            padding:1rem;
            cursor:pointer;
            border-radius:6px;
            width:50px;
            height:50px;
            z-index:10;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .3s;
            color: #fff;
        }
        .carousel-btn:hover {
            background:#7B2CBF;
            border-color: #7B2CBF;
            box-shadow: 0 4px 20px rgba(75, 0, 130, 0.7);
        }
        .carousel-btn.prev { left:20px; }
        .carousel-btn.next { right:20px; }
        .carousel-dots { display:flex; justify-content:center; gap:10px; margin-top:1.5rem; }
        .dot {
            width:10px;
            height:10px;
            border-radius:2px;
            background:rgba(255, 255, 255, 0.3);
            cursor:pointer;
            transition:all .3s;
            border: 1px solid rgba(75, 0, 130, 0.4);
        }
        .dot.active {
            background:#7B2CBF;
            width:35px;
            border-radius:2px;
            box-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }

        .products-section { margin-top:3rem; }
        .section-title {
            text-align:center;
            font-size:2.5rem;
            color:#fff;
            margin-bottom:2.5rem;
            text-shadow:0 0 20px rgba(75, 0, 130, 0.8);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .tabs-row { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
        .tab {
            padding:8px 14px;
            border-radius:999px;
            background: rgba(255,255,255,0.04);
            border:1px solid rgba(255,255,255,0.04);
            cursor:pointer;
            font-weight:700;
            color:#fff;
        }
        .tab.active { background: linear-gradient(135deg,#4B0082,#7B2CBF); box-shadow:0 8px 24px rgba(75,0,130,0.35); }

        .products-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
            gap:2rem;
            margin-bottom:3rem;
        }
        .product-card {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.3);
            border-radius:10px;
            overflow:hidden;
            box-shadow:0 8px 32px rgba(0, 0, 0, 0.6);
            transition:all .3s;
            cursor:pointer;
            position: relative;
        }
        .product-card:hover { transform:translateY(-8px); box-shadow:0 12px 40px rgba(75, 0, 130, 0.5); border-color: #7B2CBF; }
        .product-image { display:block; width:100%; height:380px; object-fit:contain; background:#0f0f0f; transition: transform .3s; }
        .product-card:hover .product-image { transform: scale(1.05); }
        .product-info { padding:1.5rem; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); }
        .product-title { font-size:1.15rem; color:#fff; margin-bottom:.5rem; font-weight: 700; }
        .product-price { font-size:1.4rem; color:#9D4EDD; font-weight:900; margin-bottom:0.8rem; text-shadow: 0 0 10px rgba(75, 0, 130, 0.5); }
        .stock-badge { display:inline-block; padding:6px 10px; border-radius:999px; background: #222; color:#fff; font-weight:800; margin-bottom:1rem; border: 1px solid rgba(255,255,255,0.06); }
        .product-actions { display:flex; gap:8px; align-items:center; margin-top:10px; }
        .qty-btn { padding:8px 12px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.04); border-radius:6px; cursor:pointer; color:#fff; font-weight:700; }
        .qty-display { min-width:36px; text-align:center; font-weight:800; font-size:1rem; color:#fff; padding:6px 8px; background: rgba(255,255,255,0.02); border-radius:6px; }
        .product-btn {
            margin-left:auto;
            padding:.9rem 1rem;
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            color:white; border:none; border-radius:6px; font-size:1rem; cursor:pointer;
            transition:all .3s; font-weight:700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(75, 0, 130, 0.5);
        }
        .product-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

        .load-more { text-align:center; margin:3rem 0; }
        .load-more-btn {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.5);
            color:white;
            padding:1.2rem 2.5rem;
            border-radius:8px;
            font-size:1.1rem;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            gap:.8rem;
            font-weight:700;
            transition:all .3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .load-more-btn:hover {
            background: rgba(75, 0, 130, 0.3);
            transform:translateY(-3px);
            border-color:#7B2CBF;
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.5);
        }
        .arrow-down { font-size:1.5rem; animation:bounce 2s infinite; }
        @keyframes bounce {
            0%,20%,50%,80%,100%{transform:translateY(0);}
            40%{transform:translateY(10px);}
            60%{transform:translateY(5px);}
        }

        footer {
            background: rgba(15, 15, 15, 0.95);
            padding:2.5rem;
            text-align:center;
            margin-top:4rem;
            border-top: 2px solid rgba(75, 0, 130, 0.5);
            position: relative;
            z-index: 1;
        }
        .footer-content { max-width:1400px; margin:0 auto; }
        .footer-links {
            display:flex;
            justify-content:center;
            gap:2.5rem;
            margin-bottom:1.5rem;
            flex-wrap:wrap;
        }
        .footer-links a {
            color:#9D4EDD;
            text-decoration:none;
            font-weight:600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
            transition: all .3s;
        }
        .footer-links a:hover {
            color:#7B2CBF;
            text-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }
        footer p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width:768px){
            .nav-links{display:none;}
            .carousel-item img{height:280px;}
            .carousel-btn{width:40px;height:40px;font-size:1.5rem;}
            .section-title{font-size:1.8rem;}
            .products-grid{grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem;}
            .product-image{height:320px;}
        }

        /* cart popup (simple overlay) */
        #cart-popup-overlay{ position: fixed; inset: 0; background: rgba(10,10,12,0.8); display:none; align-items:center; justify-content:center; z-index:10000; padding:20px; }
        #cart-popup{ background: linear-gradient(135deg, #0f0f10 0%, #161216 100%); border-radius:12px; padding:20px; width:420px; max-width:95%; color:#fff; border:1px solid rgba(255,255,255,0.04); box-shadow:0 30px 60px rgba(0,0,0,0.6); }
        #cart-items-container{ max-height:300px; overflow:auto; margin-bottom:10px; }
        .cart-item{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.02); }
        #cart-total{ font-weight:900; margin-top:8px; text-align:right; }
        #cart-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
        .btn-small{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
        .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#fff; }
        .btn-primary{ background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%); color:#fff; }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">WyvernStore</div>
            <ul class="nav-links">
                <!-- Botones "Inicio", "Productos" y "Ofertas" eliminados seg√∫n petici√≥n -->
            </ul>
            <!-- Usamos este bot√≥n como disparador del carrito -->
            <button id="cart-icon-btn" class="cart-icon" aria-label="Abrir carrito">Carrito (0)</button>
        </nav>
    </header>

    <div class="container">
        <div class="search-container">
            <input id="searchInput" class="search-bar" type="text" placeholder="üîç Buscar c√≥mics...">
            <button class="search-btn" onclick="searchProducts()" aria-label="Buscar"></button>
        </div>

        <section class="carousel-section">
            <h2 class="carousel-title">Destacados</h2>
            <div class="carousel-container">
                <button class="carousel-btn prev" onclick="moveCarousel(-1)">‚Äπ</button>
                <div class="carousel">
                    <!-- Carousel din√°mico: se llenar√° con populateCarouselFromProducts(...) -->
                </div>
                <button class="carousel-btn next" onclick="moveCarousel(1)">‚Ä∫</button>
            </div>
            <div id="carouselDots" class="carousel-dots"></div>
        </section>

        <section id="productos" class="products-section">
            <h2 class="section-title">Cat√°logo</h2>

            <!-- FILTROS / TABS: llenados por la API -->
            <div id="tabsRow" class="tabs-row">
              <!-- tabs din√°micos (DC, Marvel, Manga, Todos...) -->
            </div>

            <!-- Contenedor donde se renderizan los productos desde la API -->
            <div id="productsGrid" class="products-grid">
                <!-- los productos se inyectar√°n aqu√≠ -->
                <div id="loadingMessage" style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando productos...</div>
            </div>
        </section>

        <div class="load-more">
            <button class="load-more-btn" onclick="loadMore()">Ver m√°s <span class="arrow-down">‚Üì</span></button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="#sobre">Sobre Nosotros</a>
                <a href="#terminos">T√©rminos</a>
                <a href="#privacidad">Privacidad</a>
                <a href="#contacto">Contacto</a>
            </div>
            <p>&copy; 2025 WyvernStore. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- CART POPUP -->
    <div id="cart-popup-overlay" aria-hidden="true">
      <div id="cart-popup" role="dialog" aria-modal="true" aria-label="Carrito de compras">
        <h3 style="margin-bottom:8px">üõí Tu carrito</h3>
        <div id="cart-items-container"><p style="color:#999;text-align:center">Carrito vac√≠o</p></div>
        <div id="cart-total"></div>
        <div id="cart-actions">
          <button id="cart-close" class="btn-small btn-ghost">Cerrar</button>
          <button id="cart-confirm" class="btn-small btn-primary">Enviar por WhatsApp</button>
        </div>
      </div>
    </div>

    <!-- IMAGE MODAL (simple) -->
    <div id="img-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:20000;">
      <div style="max-width:90vw; max-height:90vh; padding:12px;">
        <img id="img-modal-img" src="" alt="" style="max-width:100%; max-height:90vh; border-radius:8px; display:block;" />
        <div style="text-align:center;margin-top:8px;">
          <button id="img-modal-close" class="btn-small btn-ghost">Cerrar</button>
        </div>
      </div>
    </div>
<script>
/********** CONFIG: cambia esto por tu worker/API (igual que en tu c√≥digo "Marrie") **********/
// Ejemplo: const API_URL = "https://d.thepersonmrt.workers.dev/";
// Reemplaza por tu endpoint. El worker debe soportar:
// GET / -> devuelve { sheets: [{ key: 'Marvel' }, { key: 'DC' }, ... ] }
// GET ?sheetKey=KEY -> devuelve { products: [{ row:'1', data: { Nombre, Precio, Stock, Descripcion, Icono, Img }}, ...] }
// POST {action:'decrement', sheetKey, row} -> decrementa stock y devuelve { newStock: N }
// POST {action:'set', sheetKey, row, value} -> fija stock y devuelve { newStock: N }
const API_URL = "https://a.thepersonmrt.workers.dev/"; // <-- cambia esto

/* ------------------ estado local ------------------ */
const tabsRow = document.getElementById('tabsRow');
const productsGrid = document.getElementById('productsGrid');
const loadingMessage = document.getElementById('loadingMessage');
let lastProductsCache = [];
let availableSheetKeys = [];
let lastLoadedSheetKey = null;

/* ---------- carrito ---------- */
const WHATSAPP_NUMBER = '573207378992'; // pon aqu√≠ tu n√∫mero si deseas
let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

const cartIconBtn = document.getElementById('cart-icon-btn');
const cartPopupOverlay = document.getElementById('cart-popup-overlay');
const cartItemsContainer = document.getElementById('cart-items-container');
const cartTotalEl = document.getElementById('cart-total');
const cartCloseBtn = document.getElementById('cart-close');
const cartConfirmBtn = document.getElementById('cart-confirm');

function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

/* ---------- utilidades (copiadas/modificadas de Marrie) ---------- */
function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function parsePriceNumber(v){
  if (v === undefined || v === null) return 0;
  if (typeof v === 'number' && !isNaN(v)) return v;
  let s = String(v).trim();
  if (s === '') return 0;
  s = s.replace(/\s+/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  s = s.replace(/[^0-9.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtPrice(v){
  if (v===undefined || v===null) return '-';
  const s = String(v).trim();
  if (s === '') return '-';
  const n = parsePriceNumber(s);
  return Number(n).toLocaleString('de-DE');
}
function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ---------- utils: crear modales si no existen (inserci√≥n autom√°tica) ---------- */
(function ensureModalsExist(){
  // image modal
  if(!document.getElementById('img-modal-overlay')){
    const overlay = document.createElement('div');
    overlay.id = 'img-modal-overlay';
    overlay.style = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:12000';
    overlay.innerHTML = '<img id="img-modal-img" src=\"\" alt=\"\" style=\"max-width:92%;max-height:92%\" /><button id=\"img-modal-close\" style=\"position:fixed;top:18px;right:18px;padding:8px;border-radius:8px;\">Cerrar</button>';
    document.body.appendChild(overlay);
  }
  // card payment modal
  if(!document.getElementById('card-modal-overlay')){
    const div = document.createElement('div');
    div.id = 'card-modal-overlay';
    div.style = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:20000';
    div.innerHTML = `
      <div id="card-modal" style="background:#0b0b0b;padding:16px;border-radius:12px;width:520px;max-width:96%;color:#eee">
        <h3>Pagar con tarjeta</h3>
        <div id="card-errors" style="color:#f66;margin-bottom:8px"></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label>Nombre completo<input id="card-name" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
          <label>Correo<input id="card-email" type="email" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
          <label>Tel√©fono<input id="card-phone" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
          <label>Direcci√≥n<textarea id="card-address" rows="2" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff"></textarea></label>
          <hr style="border:none;border-top:1px solid #222" />
          <label>N√∫mero de tarjeta<input id="card-number" placeholder="4242 4242 4242 4242" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
          <div style="display:flex;gap:8px">
            <label style="flex:1">MM/AA<input id="card-exp" placeholder="08/28" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
            <label style="width:120px">CVV<input id="card-cvv" placeholder="123" style="width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff" /></label>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="card-cancel" style="padding:8px;border-radius:6px;background:transparent;border:1px solid #333;color:#ddd">Cancelar</button>
            <button id="card-submit" style="padding:8px;border-radius:6px;background:#9D4EDD;color:#fff">Pagar ahora</button>
          </div>
          <div style="font-size:0.85rem;color:#aaa">En producci√≥n integra Stripe/Adyen y nunca almacenes CVV.</div>
        </div>
      </div>
    `;
    document.body.appendChild(div);
  }
  // OTP modal
  if(!document.getElementById('otp-modal-overlay')){
    const o = document.createElement('div');
    o.id = 'otp-modal-overlay';
    o.style = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:21000';
    o.innerHTML = `
      <div style="background:#0b0b0b;padding:16px;border-radius:12px;width:360px;color:#eee">
        <h4>3D Secure ‚Äî C√≥digo OTP</h4>
        <p style="color:#aaa">Ingresa el c√≥digo OTP (para pruebas usa <strong>123456</strong>).</p>
        <input id="otp-input" placeholder="C√≥digo OTP" style="padding:8px;border-radius:6px;background:#111;border:1px solid #222;color:#fff;width:100%" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="otp-cancel" style="padding:8px;border-radius:6px;background:transparent;border:1px solid #333;color:#ddd">Cancelar</button>
          <button id="otp-confirm" style="padding:8px;border-radius:6px;background:#9D4EDD;color:#fff">Confirmar</button>
        </div>
      </div>
    `;
    document.body.appendChild(o);
  }

  // INFO modal (Sobre, T√©rminos, Privacidad, Contacto) - crear si falta
  if(!document.getElementById('info-modal-overlay')){
    const im = document.createElement('div');
    im.id = 'info-modal-overlay';
    im.setAttribute('aria-hidden','true');
    im.style = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:20010;padding:20px';
    im.innerHTML = `
      <div id="info-modal" role="dialog" aria-modal="true" aria-label="Informaci√≥n" style="max-width:800px;width:100%;max-height:90vh;overflow:auto;background:linear-gradient(135deg,#0f0f10 0%,#161216 100%);border-radius:12px;padding:20px;color:#fff;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 60px rgba(0,0,0,0.6)">
        <button id="info-modal-close" style="float:right;background:transparent;border:none;color:#fff;font-weight:800;cursor:pointer;font-size:1.2rem">√ó</button>
        <div id="info-modal-content" style="clear:both;padding-top:8px"></div>
        <div style="margin-top:12px;text-align:right">
          <button id="info-modal-close-bottom" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff">Cerrar</button>
        </div>
      </div>
    `;
    document.body.appendChild(im);
  }
})();

/* ---------- lazy loading (simple) ---------- */
const lazyObserver = (function(){
  if (typeof IntersectionObserver === 'undefined') return null;
  return new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const img = entry.target;
      const src = img.dataset && img.dataset.src;
      if (src) {
        img.src = src;
        delete img.dataset.src;
      }
      obs.unobserve(img);
    });
  }, {
    rootMargin: '300px 0px',
    threshold: 0.01
  });
})();
function observeLazyImages(rootEl) {
  if (!lazyObserver) return;
  const imgs = (rootEl || document).querySelectorAll('img[data-src]');
  imgs.forEach(img => { if (document.contains(img)) lazyObserver.observe(img); });
}

/* ---------- makeImgEl: ahora carga la imagen directamente (lazy) y aplica object-fit ---------- */
function makeImgEl(raw, alt, className){
  const img = document.createElement('img');
  img.alt = alt || '';
  img.className = className || '';
  img.loading = 'lazy';
  try {
    // Preferimos llamar al proxy de tu worker si existe
    img.src = raw ? (API_URL + 'image-proxy?url=' + encodeURIComponent(raw)) : '';
    // tambi√©n guardamos dataset-src por si quieres usar observer fallback
    img.dataset.src = raw ? (API_URL + 'image-proxy?url=' + encodeURIComponent(raw)) : '';
  } catch(e) {
    img.src = '';
  }
  img.style.maxHeight = '380px';
  img.style.width = 'auto';
  img.style.objectFit = 'contain';
  img.onerror = () => { img.remove(); };
  return img;
}

/* ---------- STOCK sync helpers (MEJORADOS) ---------- */

/** Normaliza la clave de producto usada en dataset (evita colisiones entre sheets) */
function normalizeProductKey(sheetKey, row){
  return `${String(sheetKey||'').trim().toLowerCase()}::${String(row)}`;
}

/** mapToAvailableSheetKey: busca coincidencia en availableSheetKeys (igual que antes) */
function mapToAvailableSheetKey(input){
  if(!input) return null;
  const s = String(input).trim();
  if(availableSheetKeys && availableSheetKeys.length){
    const found = availableSheetKeys.find(k => String(k).toLowerCase() === s.toLowerCase());
    if(found) return found;
  }
  return s || null;
}

/** Mejora: intenta obtener stock del servidor y devolver Number|null */
async function fetchServerStock(sheetKeyRaw, row){
  try {
    const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
    if(!mappedKey) return null;
    const resp = await fetch(API_URL + '?sheetKey=' + encodeURIComponent(mappedKey), { cache: 'no-store' });
    if(!resp.ok) return null;
    const json = await resp.json().catch(()=>null);
    if(!json || !Array.isArray(json.products)) return null;
    const found = json.products.find(p => String(p.row) === String(row));
    if(!found) return null;
    const stockVal = firstKeyValue(found.data || {}, ['stock','cantidad','Stock']) || found.data && (found.data.Stock || found.data.cantidad) || 0;
    return Number(stockVal || 0);
  } catch (err) {
    console.warn('fetchServerStock error', err);
    return null;
  }
}

/*
  updateStockOnServer_decrement:
  - intenta petici√≥n at√≥mica con qty (si el worker lo soporta)
  - si no, hace N requests en paralelo (m√°s r√°pido que secuencial)
  - actualiza dataset.serverStock y dataset.origStock si el servidor devuelve newStock
  - devuelve true si todas las unidades fueron decrementadas correctamente
*/
async function updateStockOnServer_decrement(sheetKeyRaw, row, qty){
  if(!qty || qty <= 0) return false;
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw);
  if(!mappedKey){
    console.warn('updateStockOnServer_decrement: sheetKey no reconocido, no se enviar√° petici√≥n:', sheetKeyRaw);
    return false;
  }

  // helper para aplicar newStock al DOM (usa normalizeProductKey)
  function applyNewStockToDOM(newStock){
    const pk = normalizeProductKey(mappedKey, row);
    document.querySelectorAll('.product-card').forEach(card=>{
      if(card.dataset.productKey === pk){
        const reservedLocal = getReservedQty(mappedKey, row);
        card.dataset.serverStock = String(newStock);
        // origStock representa serverStock + reservedLocal (fuente de verdad visible)
        card.dataset.origStock = String(Math.max(0, Number(newStock) + Number(reservedLocal || 0)));
      }
    });
    refreshCardStockDisplay(mappedKey, row);
  }

  try {
    // Primer intento: pedir al worker un decrement at√≥mico con qty
    const respAtomic = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row), qty: Number(qty) })
    }).catch(()=>null);

    if(respAtomic && respAtomic.ok){
      const text = await respAtomic.text().catch(()=>null);
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }
      if(json && !json.error && (json.newStock !== undefined)){
        applyNewStockToDOM(Number(json.newStock));
        return true;
      }
      // si no tiene newStock o hay error seguiremos a fallback
    }

    // Fallback: si el worker no soporta qty, hacemos N requests en paralelo (m√°s r√°pido que secuencial)
    const promises = [];
    for(let i=0;i<qty;i++){
      promises.push(
        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row) })
        })
        .then(async r => {
          const txt = await r.text().catch(()=>null);
          let j = null;
          try { j = txt ? JSON.parse(txt) : null; } catch(e){ j = null; }
          return { ok: r.ok, json: j, status: r.status };
        })
        .catch(err => ({ ok: false, err }))
      );
    }

    const results = await Promise.all(promises);
    // contar exitosos y tomar el √∫ltimo newStock v√°lido que encontremos
    let successCount = 0;
    let lastNewStock;
    for(const res of results){
      if(res && res.ok && res.json && !res.json.error){
        successCount++;
        if(res.json.newStock !== undefined) lastNewStock = Number(res.json.newStock);
      }
    }

    if(lastNewStock !== undefined){
      applyNewStockToDOM(lastNewStock);
    } else {
      // si no hay newStock pero hubo √©xitos, forzamos un refresh desde el servidor (garantiza consistencia)
      if(successCount > 0){
        await refreshStockFromServerForItem(mappedKey, row);
        return successCount === qty;
      }
    }

    return successCount === qty;
  } catch (err){
    console.warn('updateStockOnServer_decrement fallo:', err);
    return false;
  }
}

/**
 * Setea stock en servidor y actualiza DOM con newStock (si worker devuelve newStock).
 */
async function updateStockOnServer_set(sheetKeyRaw, row, newStock){
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'set', sheetKey: mappedKey, row: String(row), value: String(newStock) })
    });

    const text = await resp.text().catch(()=>null);
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }

    if(resp.ok && json && !json.error){
      const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : Number(newStock);
      // aplicar a DOM (usar productKey)
      const pk = normalizeProductKey(mappedKey, row);
      document.querySelectorAll('.product-card').forEach(card=>{
        if(card.dataset.productKey === pk){
          const reservedLocal = getReservedQty(mappedKey, row);
          card.dataset.serverStock = String(confirmedStock);
          card.dataset.origStock = String(Math.max(0, confirmedStock + Number(reservedLocal || 0)));
        }
      });
      refreshCardStockDisplay(mappedKey, row);
      return true;
    } else {
      console.warn('updateStockOnServer_set: respuesta no OK', resp.status, text);
      return false;
    }
  } catch (err) {
    console.warn('updateStockOnServer_set fallo:', err);
    return false;
  }
}

/**
 * Obtiene el stock "original" que usa la UI.
 * Prioriza dataset.serverStock (valor confirmado por el servidor),
 * luego dataset.origStock y por √∫ltimo la cache local.
 */
function getOriginalStock(sheetKey, row){
  const pk = normalizeProductKey(sheetKey, row);
  // buscar tarjeta DOM con productKey exacto
  const card = Array.from(document.querySelectorAll('.product-card')).find(c => c.dataset.productKey === pk);
  if(card){
    if(card.dataset.serverStock !== undefined && card.dataset.serverStock !== '') return Number(card.dataset.serverStock || 0);
    if(card.dataset.origStock !== undefined && card.dataset.origStock !== '') return Number(card.dataset.origStock || 0);
  }

  // fallback a cache
  const p = findProductInCache(sheetKey, row);
  if (p){
    const d = p.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0;
    return Number(stock || 0);
  }

  // √∫ltimo recurso: buscar cualquier producto con misma row (menos deseable)
  const p2 = (Array.isArray(lastProductsCache) && lastProductsCache.find(pp=>String(pp.row)===String(row))) || null;
  if(p2){
    const d = p2.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || 0;
    return Number(stock || 0);
  }
  return 0;
}

function getReservedQty(sheetKey, row){
  return cart.filter(i => (i.sheetKey||'').toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
}

/**
 * Refresca el stock para un item: obtiene el stock real del servidor y lo aplica en DOM y cache.
 * Guarda dataset.serverStock y recalcula dataset.origStock sumando reservedLocal.
 */
async function refreshStockFromServerForItem(sheetKeyRaw, row){
  try {
    const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
    const serverStock = await fetchServerStock(mappedKey, row);
    if (serverStock === null || serverStock === undefined) return;

    const pk = normalizeProductKey(mappedKey, row);

    // Actualizar cards en DOM que coincidan por productKey
    document.querySelectorAll('.product-card').forEach(card => {
      if(card.dataset.productKey === pk){
        const reservedLocal = getReservedQty(mappedKey, row);
        card.dataset.serverStock = String(Number(serverStock));
        card.dataset.origStock = String(Math.max(0, Number(serverStock) + Number(reservedLocal || 0)));
      }
    });

    // Actualizar cache local si existe
    if (Array.isArray(lastProductsCache)){
      const p = lastProductsCache.find(pp => String(pp.row) === String(row) && (pp.sheetKey||'').toString().trim().toLowerCase() === mappedKey.toString().trim().toLowerCase());
      if (p){
        p.data = p.data || {};
        p.data.Stock = Number(serverStock);
        p.data.stock = Number(serverStock);
      }
    }

    // refrescar UI para ese item
    refreshCardStockDisplay(mappedKey, row);
  } catch (err){
    console.warn('refreshStockFromServerForItem error', err);
  }
}

/**
 * Refresca la visualizaci√≥n del stock en las tarjetas.
 * Usa dataset.productKey (clave √∫nica normalizada) para evitar colisiones.
 */
function refreshCardStockDisplay(sheetKey, row){
  const pk = normalizeProductKey(sheetKey, row);
  const cards = Array.from(document.querySelectorAll('.product-card')).filter(c => c.dataset.productKey === pk);
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey, row);
  const avail = Math.max(0, origStock - reserved);
  cards.forEach(card => {
    const stockSpan = card.querySelector('.stockval');
    if(stockSpan) stockSpan.innerText = avail;
    const orderBtn = card.querySelector('.product-btn');
    if(avail <= 0){
      card.classList.add('out');
      card.style.opacity = '0.45';
      if(orderBtn) orderBtn.disabled = true;
    } else {
      card.classList.remove('out');
      card.style.opacity = '';
      if(orderBtn) orderBtn.disabled = false;
    }
  });
}

/**
 * Finaliza la compra en servidor: paraleliza decrementos por item (cada item usa su qty),
 * devuelve array de items que fallaron.
 */
async function finalizePurchaseOnServer(items){
  const failures = [];
  if(!Array.isArray(items) || items.length === 0) return failures;

  // Ejecutar todos los decrementos en paralelo (uno por item)
  const promises = items.map(async (it) => {
    const qty = Number(it.qty || 0);
    if(!qty) return { ok: true, item: it };
    try {
      const ok = await updateStockOnServer_decrement(it.sheetKey, it.row, qty);
      return { ok, item: it };
    } catch (err){
      console.warn('finalizePurchaseOnServer item error', it, err);
      return { ok: false, item: it };
    }
  });

  const results = await Promise.all(promises);
  results.forEach(r => { if(!r.ok) failures.push(r.item); });

  return failures;
}

/* ---------- stock / UI helpers (resto) ---------- */
function findProductInCache(sheetKey, row){
  if(!Array.isArray(lastProductsCache)) return null;
  const targetSk = (sheetKey || '').toString().trim();
  return lastProductsCache.find(pp => {
    const sk = (pp.sheetKey || (pp.data && (pp.data.Categoria || pp.data.categoria)) || '').toString().trim();
    return String(pp.row) === String(row) && sk.toString().trim().toLowerCase() === targetSk.toLowerCase();
  }) || null;
}

/* ---------- updateCartUI ---------- */
function updateCartUI(){
  const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  if(cartIconBtn) cartIconBtn.innerText = `Carrito (${count})`;
  saveCart();
}

/* ---------- add / remove cart ---------- */
async function addToCartFromCard(card, qty){
  const sheetKey = (card && card.dataset.sheetKey) || lastLoadedSheetKey || 'UNKNOWN';
  const row = card && card.dataset.row;
  const name = card?.querySelector('.product-title')?.innerText || 'Sin nombre';
  const priceRaw = card?.dataset.price !== undefined ? card.dataset.price : (card?.querySelector('.product-price')?.innerText || '');
  const priceNum = parsePriceNumber(priceRaw);
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey,row);
  const available = Math.max(0, origStock - reserved);

  if(qty > available){
    alert('No hay suficiente stock disponible.');
    return;
  }

  const key = `${sheetKey}::${row}`;
  const existing = cart.find(i=>cartItemKey(i) === key);
  if(existing){
    existing.qty = Math.min(origStock, existing.qty + qty);
  } else {
    cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
  }

  refreshCardStockDisplay(sheetKey,row);
  updateCartUI();

  // nota: ya no decrementamos el stock al a√±adir al carrito.
  // El decremento se realizar√° cuando se confirme el pago por tarjeta o al enviar por WhatsApp.
  if(cartIconBtn){
    cartIconBtn.style.transform = 'scale(1.12)';
    setTimeout(()=> cartIconBtn.style.transform = '', 200);
  }
}

function removeFromCart(idx){
  if(idx >= 0 && idx < cart.length){
    const item = cart[idx];
    const sheetKey = item.sheetKey;
    const row = item.row;
    const removedQty = Number(item.qty || 0);

    cart.splice(idx, 1);
    refreshCardStockDisplay(sheetKey, row);
    updateCartUI();
    openCartPopup();

    // Ya no restauramos stock en el servidor aqu√≠ porque no lo decrementamos al a√±adir.
  }
}

/* ---------- env√≠o por WhatsApp (usa finalizePurchaseOnServer) ---------- */
async function sendToWhatsApp(){
  if(cart.length === 0){
    alert('El carrito est√° vac√≠o');
    return;
  }

  // Construir mensaje (usa saltos de l√≠nea reales \n)
  let message = '*Nuevo Pedido - WyvernStore*\n\n';
  let total = 0;
  cart.forEach(item => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    total += itemTotal;
    message += `*${item.name}*\n`;
    message += `   Cantidad: ${item.qty}\n`;
    message += `   Precio: ${Number(itemTotal).toLocaleString('de-DE')}\n\n`;
  });
  message += `*TOTAL: ${Number(total).toLocaleString('de-DE')}*\n\n`;
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

  // Intentar decrementar en servidor; si falla, refrescar stock y no limpiar el carrito
  let failures = [];
  try {
    failures = await finalizePurchaseOnServer(cart);
  } catch (e){
    console.warn('Error finalizando decrements antes de WhatsApp', e);
    failures = cart.slice();
  }

  if (failures.length === 0){
    // guardamos los items comprados para re-sync posterior
    const purchased = cart.slice();

    // pedir stock actualizado para cada item y actualizar la UI
    try {
      await Promise.all(cart.map(it => refreshStockFromServerForItem(it.sheetKey, it.row).catch(()=>{})));
    } catch(e){
      console.warn('Error refrescando stock tras decrementar (WA):', e);
    }

    // todo OK: abrir WhatsApp y limpiar carrito (UI ya refleja decremento)
    window.open(url, '_blank');

    // limpiar carrito local
    cart = [];
    updateCartUI();

    // RE-SYNC final: ahora que cart est√° vac√≠o, forzamos una lectura desde servidor
    try {
      await Promise.all(purchased.map(it => refreshStockFromServerForItem(it.sheetKey, it.row).catch(()=>{})));
    } catch(e){
      console.warn('Error re-sincronizando stock despu√©s de limpiar carrito (WA):', e);
    }

    refreshAllCardDisplays();
    closeCartPopup();
    return;
  } else {
    // fall√≥ alguna decrementaci√≥n: preguntar al usuario si quiere continuar
    const proceed = confirm('No fue posible actualizar el stock en el servidor para algunos productos. ¬øDeseas continuar y enviar el pedido por WhatsApp de todas maneras? (Si no, la p√°gina re-sincronizar√° el stock)');
    if (!proceed){
      // Resync only the failed items
      try {
        await Promise.all(failures.map(it => refreshStockFromServerForItem(it.sheetKey, it.row).catch(()=>{})));
      } catch(e){ console.warn('Error al refrescar stock tras fallo WhatsApp', e); }
      return;
    } else {
      // usuario decide continuar: abrir WhatsApp y limpiar carrito (posible inconsistencia)
      window.open(url, '_blank');
      cart = [];
      updateCartUI();
      refreshAllCardDisplays();
      closeCartPopup();
      return;
    }
  }
}

/* ---------- abrir/cerrar carrito (ahora inyecta bot√≥n pagar con tarjeta) ---------- */
function openCartPopup(){
  if(cart.length === 0){
    if(cartItemsContainer) cartItemsContainer.innerHTML = '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';
    if(cartTotalEl) cartTotalEl.innerHTML = '';
    // inyectar acciones si no existen
    ensureCartActions();
    if(cartPopupOverlay){ cartPopupOverlay.style.display = 'flex'; cartPopupOverlay.setAttribute('aria-hidden','false'); }
    document.body.style.overflow = 'hidden';
    return;
  }
  let html = '';
  cart.forEach((item, idx) => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    html += `
      <div class="cart-item" style="display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #111">
        <div style="flex:1">
          <div style="font-weight:800">${escapeHtml(item.name)}</div>
          <div style="font-size:0.9rem;color:#aaa">x${item.qty} ‚Äî ${Number(itemTotal).toLocaleString('de-DE')}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <button style="background:transparent;border:none;color:#f66;cursor:pointer;font-weight:800" onclick="removeFromCart(${idx})">‚úï</button>
        </div>
      </div>
    `;
  });
  if(cartItemsContainer) cartItemsContainer.innerHTML = html;
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  if(cartTotalEl) cartTotalEl.innerHTML = `üí∞ Total: <span style="color:#9D4EDD">${Number(total).toLocaleString('de-DE')}</span>`;

  // ensure actions/buttons exist
  ensureCartActions();
  if(cartPopupOverlay){ cartPopupOverlay.style.display = 'flex'; cartPopupOverlay.setAttribute('aria-hidden','false'); }
  document.body.style.overflow = 'hidden';
}
function closeCartPopup(){ if(cartPopupOverlay){ cartPopupOverlay.style.display = 'none'; cartPopupOverlay.setAttribute('aria-hidden','true'); } document.body.style.overflow = ''; }

if(cartIconBtn) cartIconBtn.addEventListener('click', openCartPopup);
if(cartCloseBtn) cartCloseBtn.addEventListener('click', closeCartPopup);
if(cartConfirmBtn) cartConfirmBtn.addEventListener('click', sendToWhatsApp);
if(cartPopupOverlay) cartPopupOverlay.addEventListener('click', (e)=>{ if(e.target === cartPopupOverlay) closeCartPopup(); });

/* ensureCartActions: agrega (o reutiliza) botones dentro del popup para WhatsApp + Pagar tarjeta */
function ensureCartActions(){
  if(!cartPopupOverlay) return;
  const popupInner = cartPopupOverlay.querySelector('.cart-popup') || cartPopupOverlay.firstElementChild;
  if(!popupInner) return;

  // buscar o crear fila de acciones (no absolute para evitar superposici√≥n)
  let actionsRow = popupInner.querySelector('.cart-actions-row');
  if(!actionsRow){
    actionsRow = document.createElement('div');
    actionsRow.className = 'cart-actions-row';
    actionsRow.style.cssText = 'display:flex;gap:8px;justify-content:flex-end;margin-top:12px;padding-top:8px;border-top:1px solid #111';
    popupInner.appendChild(actionsRow);
  }

  // -- Bot√≥n Cerrar (si no existe) --
  if(!actionsRow.querySelector('.close-btn')){
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.innerText = 'Cerrar';
    closeBtn.style.cssText = 'padding:8px;border-radius:8px;border:1px solid #333;background:transparent;color:#ddd';
    closeBtn.onclick = closeCartPopup;
    actionsRow.appendChild(closeBtn);
  }

  // -- Reusar bot√≥n WhatsApp existente si est√° en el DOM --
  let existingWaBtn = popupInner.querySelector('#cart-confirm') || document.getElementById('cart-confirm');
  if(existingWaBtn){
    if(existingWaBtn.parentElement !== actionsRow){
      actionsRow.appendChild(existingWaBtn);
      existingWaBtn.style.display = '';
      existingWaBtn.style.marginLeft = '6px';
    }
  } else {
    if(!actionsRow.querySelector('.wa-btn')){
      const waBtn = document.createElement('button');
      waBtn.className = 'wa-btn';
      waBtn.innerText = 'Enviar por WhatsApp';
      waBtn.style.cssText = 'padding:8px;border-radius:8px;background:#9D4EDD;color:#fff;border:none;margin-left:6px';
      waBtn.onclick = sendToWhatsApp;
      actionsRow.appendChild(waBtn);
    }
  }

  // -- Bot√≥n Pagar con tarjeta (solo crear si no existe) --
  if(!actionsRow.querySelector('#cart-paycard')){
    const payBtn = document.createElement('button');
    payBtn.id = 'cart-paycard';
    payBtn.innerText = 'Pagar con tarjeta';
    payBtn.style.cssText = 'padding:8px;border-radius:8px;background:#3b82f6;color:#fff;border:none;margin-left:6px';
    payBtn.onclick = openCardPaymentModal;
    actionsRow.appendChild(payBtn);
  }

  const payDuplicates = popupInner.querySelectorAll('#cart-paycard');
  if(payDuplicates.length > 1){
    for(let i = 1; i < payDuplicates.length; i++) payDuplicates[i].remove();
  }
}

/* ---------- render din√°mico de productos (MEJORADO) ---------- */
function renderProducts(products, sheetKey){
  if (!products || !products.length){
    productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">No hay productos</div>';
    // actualizar carrusel con cache si quieres
    populateCarouselFromProducts(lastProductsCache, 6);
    return;
  }

  // actualizar cache
  lastProductsCache = (products || []).map(p => {
    return {
      row: p.row,
      sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || '').toString(),
      data: p.data || {}
    };
  });

  productsGrid.innerHTML = '';
  const frag = document.createDocumentFragment();

  products.forEach((p, index) => {
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || d.Nombre || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','Precio']) || d.Precio || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0);
    const imgUrl = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';
    const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota','Nota']) || d.descripcion || '';

    // IMPORTANT: NO usar el sheetKey pasado como "ALL" como fallback.
    const productSheetKey = (p.sheetKey || d.Categoria || d.categoria || 'UNKNOWN').toString();

    const card = document.createElement('div');
    card.className = 'product-card';
    // dataset.origStock puede ser recalculado m√°s adelante desde serverStock
    card.dataset.origStock = String(stock);
    card.dataset.price = price;
    card.dataset.row = String(p.row);
    card.dataset.sheetKey = String(productSheetKey);
    // clave √∫nica consistente para todas las operaciones DOM
    card.dataset.productKey = normalizeProductKey(productSheetKey, p.row);

    // si la respuesta trajo Stock, guardarlo como serverStock para evitar usar valores antiguos
    if(d.Stock !== undefined) card.dataset.serverStock = String(Number(d.Stock || 0));

    card.innerHTML = `
      <div style="min-height:380px; display:flex; align-items:center; justify-content:center; background:#0f0f0f;">
        <div style="width:90%;text-align:center;padding:16px;">
          <div class="prod-img-placeholder" style="width:100%;height:300px;display:flex;align-items:center;justify-content:center;color:#888">üñºÔ∏è</div>
        </div>
      </div>
      <div class="product-info">
        <div class="product-title">${escapeHtml(name)}</div>
        <div><span class="product-price">${price ? ('$ ' + fmtPrice(price)) : '-'}</span></div>
        <div style="margin-top:8px"><span class="stock-badge">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></span></div>
        <div style="margin-top:10px;color:#bbb;font-size:0.95rem;max-height:60px;overflow:hidden">${escapeHtml(String(description || 'Sin descripci√≥n'))}</div>

        <div class="product-actions" style="margin-top:12px">
          <button class="qty-btn minus">‚àí</button>
          <div class="qty-display">1</div>
          <button class="qty-btn plus">+</button>
          <button class="product-btn">Agregar</button>
        </div>
      </div>
    `;

    // attach img (lazy/direct load)
    const placeholder = card.querySelector('.prod-img-placeholder');
    if (imgUrl && /^https?:\/\//i.test(imgUrl)){
      const imgEl = makeImgEl(imgUrl, name, 'product-image');
      // replace placeholder with img container
      const wrap = document.createElement('div');
      wrap.style.width = '100%';
      wrap.style.height = '380px';
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.justifyContent = 'center';
      wrap.style.background = '#0f0f0f';
      const imgContainer = imgEl;
      imgContainer.style.maxHeight = '380px';
      imgContainer.style.width = 'auto';
      wrap.appendChild(imgContainer);
      const top = card.firstElementChild;
      top.replaceWith(wrap);
      observeLazyImages(card);
      imgContainer.addEventListener('click', ()=> openImageModal(imgUrl, name));
    }

    frag.appendChild(card);
  });

  productsGrid.appendChild(frag);

  if (!productsGrid._hasDelegation) {
    productsGrid.addEventListener('click', function(e){
      const plus = e.target.closest('.plus');
      if (plus) {
        e.preventDefault();
        const card = plus.closest('.product-card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty-display');
        const current = Number(qtySpan?.innerText || '1');
        const orig = getOriginalStock(card.dataset.sheetKey, card.dataset.row);
        if (current < Math.max(0, orig - getReservedQty(card.dataset.sheetKey, card.dataset.row))){
          qtySpan.innerText = current + 1;
        }
        return;
      }

      const minus = e.target.closest('.minus');
      if (minus) {
        e.preventDefault();
        const card = minus.closest('.product-card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty-display');
        const current = Number(qtySpan?.innerText || '1');
        if (current > 1) qtySpan.innerText = current - 1;
        return;
      }

      const orderBtn = e.target.closest('.product-btn');
      if (orderBtn) {
        e.preventDefault();
        const card = orderBtn.closest('.product-card');
        if (!card) return;
        const qty = Number(card.querySelector('.qty-display')?.innerText || '1');
        addToCartFromCard(card, qty);
        return;
      }

      const img = e.target.closest('.product-image');
      if(img){
        return;
      }
    });
    productsGrid._hasDelegation = true;
  }

  // actualizar carrusel con las im√°genes de los productos renderizados
  populateCarouselFromProducts(products, 6);
}

function refreshAllCardDisplays(){
  document.querySelectorAll('.product-card').forEach(card => {
    refreshCardStockDisplay(card.dataset.sheetKey, card.dataset.row);
  });
}

/* ---------- categor√≠as y carga ---------- */
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida: espera { sheets: [] }");
    availableSheetKeys = (data.sheets || []).map(s => s.key).filter(Boolean);
    renderTabs(data.sheets);
  } catch(err){
    if(tabsRow) tabsRow.innerHTML = '<div style="color:#f88">Error cargando categor√≠as</div>';
    console.error(err);
  }
}

function renderTabs(sheets){
  if(!tabsRow) return;
  tabsRow.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "‚ú® Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsRow.appendChild(allBtn);

  sheets.forEach((s) => {
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsRow.appendChild(btn);
  });

  // cargar todo por defecto
  loadProductsAll();
}

async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando productos...</div>';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error: '+escapeHtml(data.message||'')+'</div>'; return; }
    const products = (data.products || []).map(p=> { if(!p.sheetKey) p.sheetKey = sheetKey; return p; });
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ console.error(err); productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error cargando productos</div>'; }
}

/* ----------------- loadProductsAll (MEJORADO): forzar sheetKey desde la data (evitar "ALL") ----------------- */
async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando todos los productos...</div>';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error: '+escapeHtml(data.message||'')+'</div>'; return; }
    let products = data.products || [];

    // Normalizar y asegurarse de que cada producto tiene su sheetKey real (no "ALL")
    products.forEach(p=>{
      p.data = p.data || {};
      // preferir Categoria desde los datos; si no existe, usar p.sheetKey si viene, si no 'UNKNOWN'
      const cat = p.data.Categoria || p.data.categoria || p.sheetKey || 'UNKNOWN';
      p.sheetKey = String(cat);
    });

    const cats = [...new Set(products.map(p => (p.data && (p.data.Categoria || p.data.categoria || p.sheetKey)) ).filter(Boolean))];

    const detailsPromises = cats.map(cat => fetch(API_URL+'?sheetKey='+encodeURIComponent(cat), {cache:'no-store'})
      .then(res=>res.json().catch(()=>({products:[]})))
      .then(json => ({ cat, products: json.products || [] }))
      .catch(()=>({cat, products:[]}))
    );

    const details = await Promise.all(detailsPromises);

    const detailMap = {};
    details.forEach(obj=>{
      const cat = obj.cat;
      (obj.products || []).forEach(pp=>{
        const key = `${cat}::${String(pp.row)}`;
        detailMap[key] = pp.data || pp;
        if(!pp.sheetKey) pp.sheetKey = cat;
      });
    });

    products = products.map(p=>{
      const d = p.data || {};
      const cat = p.sheetKey || d.Categoria || d.categoria || 'UNKNOWN';
      const key = `${cat}::${String(p.row)}`;
      const det = detailMap[key];
      if(det){
        if(!d.descripcion && (det.descripcion || det.Descripcion || det.description)) d.descripcion = firstKeyValue(det, ['descripcion','Descripcion','description','desc','nota','Nota']);
        if(!d.Icono && (det.Icono || det.icono || det.icon)) d.Icono = det.Icono || det.icono || det.icon;
        if(!d.Img && (det.Img || det.img || det.imagen || det.image)) d.Img = det.Img || det.img || det.imagen || det.image;
        if(!d.Categoria && det.Categoria) d.Categoria = det.Categoria;
      }
      p.sheetKey = p.sheetKey || d.Categoria || cat;
      p.data = d;
      return p;
    });

    lastProductsCache = products.map(p => {
      return {
        row: p.row,
        sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || 'UNKNOWN').toString(),
        data: p.data || {}
      };
    });

    renderProducts(lastProductsCache.map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey })), "ALL");
  } catch(err){
    console.error(err);
    productsGrid.innerHTML = '<div style="text-align:center;color:#f88">Error cargando productos</div>';
  }
}

/* ---------- util: abrir modal imagen ---------- */
const imgModalOverlay = document.getElementById('img-modal-overlay');
const imgModalImg = document.getElementById('img-modal-img');
const imgModalClose = document.getElementById('img-modal-close');
function openImageModal(url, alt){
  if(!url) return;
  imgModalImg.src = url;
  imgModalImg.alt = alt || '';
  if(imgModalOverlay) imgModalOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeImageModal(){ if(imgModalOverlay) imgModalOverlay.style.display = 'none'; if(imgModalImg) imgModalImg.src = ''; document.body.style.overflow = ''; }
if(imgModalClose) imgModalClose.addEventListener('click', closeImageModal);
if(imgModalOverlay) imgModalOverlay.addEventListener('click', (e)=>{ if(e.target === imgModalOverlay) closeImageModal(); });

/* ---------- INFO MODAL: textos basados en normativa colombiana (resumen) ---------- */
const infoTexts = {
  sobre: {
    title: 'Sobre Nosotros',
    html: `
      <p><strong>WyvernStore</strong> es una tienda de c√≥mics especializada en ventas a domicilio. Nuestro objetivo es ofrecer colecciones, novedades y ediciones especiales con entrega directa al domicilio del cliente.</p>
      <p class="muted">Operamos como vendedor minorista responsable por la oferta y entrega de los productos solicitados.</p>
    `
  },
  terminos: {
    title: 'T√©rminos y condiciones (resumen)',
    html: `
      <p><strong>√Åmbito y compra:</strong> Las compras realizadas en este sitio constituyen un contrato de compraventa entre usted (consumidor) y WyvernStore (proveedor). Los precios publicados incluyen IVA cuando aplique y se confirmar√°n en el proceso de pago.</p>

      <p><strong>Ventas a distancia y derecho de retracto:</strong> En las ventas a distancia usted cuenta con el derecho de retracto. El t√©rmino m√°ximo para ejercer este derecho es de <strong>cinco (5) d√≠as h√°biles</strong> contados a partir de la entrega del bien (o desde la celebraci√≥n del contrato, seg√∫n el caso). Si ejerce el retracto, el contrato se resolver√° y deber√° devolver el producto en las mismas condiciones en que lo recibi√≥; los costos de transporte para la devoluci√≥n ser√°n, en general, a cargo del consumidor salvo pacto distinto.</p>

      <p><strong>Devoluciones y reembolsos:</strong> En caso de retracto o devoluci√≥n procedente, WyvernStore realizar√° la devoluci√≥n de todas las sumas pagadas en los t√©rminos y conforme a la normativa vigente. La devoluci√≥n del dinero no podr√° exceder de <strong>treinta (30) d√≠as calendario</strong> desde la notificaci√≥n del ejercicio del retracto y la recepci√≥n del producto, salvo disposiciones especiales aplicables.</p>

      <p class="muted">(Resumen informativo; procederemos conforme a la normativa vigente aplicable a ventas a distancia y protecci√≥n del consumidor.)</p>
    `
  },
  privacidad: {
    title: 'Pol√≠tica de Privacidad (resumen)',
    html: `
      <p><strong>Datos que recolectamos:</strong> Para procesar pedidos a domicilio podemos solicitar nombre completo, tel√©fono, direcci√≥n de env√≠o, correo electr√≥nico y los datos necesarios para procesar el pago (por ejemplo, datos de tarjeta). <strong>No almacenamos n√∫meros completos de tarjeta de cr√©dito en nuestros servidores.</strong></p>

      <p><strong>Procesamiento de pagos:</strong> Los datos de pago son procesados por una pasarela de pagos segura (proveedor de pago). WyvernStore √∫nicamente utiliza la informaci√≥n necesaria para gestionar la compra y la entrega; los datos sensibles de pago se transmiten a un proveedor tercero especializado y no se guardan en texto completo en nuestros sistemas.</p>

      <p><strong>Finalidad y base legal:</strong> Los datos se usan para (i) ejecutar el contrato de compraventa (procesar el pedido y la entrega), (ii) facturaci√≥n y (iii) atenci√≥n al cliente. El tratamiento se realiza con su consentimiento y/o para el cumplimiento del contrato y obligaciones legales.</p>

      <p><strong>Derechos del titular:</strong> Usted tiene derecho a conocer, actualizar, rectificar y solicitar la supresi√≥n de sus datos personales, as√≠ como a revocar el consentimiento otorgado y presentar quejas ante la autoridad de protecci√≥n de datos (Superintendencia de Industria y Comercio, SIC). Para ejercer estos derechos, por favor contacte a: <strong>contacto@wyvernstore.com</strong> o al tel√©fono <strong>+57 300 000 0000</strong>.</p>

      <p class="muted">WyvernStore cumple con la normativa colombiana de protecci√≥n de datos personales y reglamentos aplicables.</p>
    `
  },
  contacto: {
    title: 'Contacto',
    html: `
      <p>¬øNecesitas ayuda con un pedido o quieres presentar una reclamaci√≥n? Cont√°ctanos:</p>
      <ul>
        <li><strong>Email:</strong> contacto@wyvernstore.com</li>
        <li><strong>Tel√©fono / WhatsApp:</strong> +57 300 000 0000</li>
        <li><strong>Horario de atenci√≥n:</strong> Lunes a viernes 09:00‚Äì18:00</li>
      </ul>
      <p>Si su reclamaci√≥n no es resuelta, tiene derecho a acudir a la Superintendencia de Industria y Comercio (SIC) para presentar su queja como consumidor.</p>
    `
  }
};

const infoOverlay = document.getElementById('info-modal-overlay');
const infoContentDiv = document.getElementById('info-modal-content');
const infoCloseBtn = document.getElementById('info-modal-close');
const infoCloseBottomBtn = document.getElementById('info-modal-close-bottom');

function openInfo(key){
  const entry = infoTexts[key];
  if(!entry) return;
  if(infoContentDiv) infoContentDiv.innerHTML = `<h2 style="color:#9D4EDD;margin-bottom:8px">${escapeHtml(entry.title || '')}</h2>${entry.html || ''}`;
  if(infoOverlay) { infoOverlay.style.display = 'flex'; infoOverlay.setAttribute('aria-hidden','false'); }
  document.body.style.overflow = 'hidden';
  // focus accesible
  const modal = document.getElementById('info-modal');
  if(modal) modal.focus && modal.focus();
}

function closeInfo(){
  if(infoOverlay) { infoOverlay.style.display = 'none'; infoOverlay.setAttribute('aria-hidden','true'); }
  if(infoContentDiv) infoContentDiv.innerHTML = '';
  document.body.style.overflow = '';
}

if(infoCloseBtn) infoCloseBtn.addEventListener('click', closeInfo);
if(infoCloseBottomBtn) infoCloseBottomBtn.addEventListener('click', closeInfo);
if(infoOverlay) infoOverlay.addEventListener('click', (e)=> { if(e.target === infoOverlay) closeInfo(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && infoOverlay && infoOverlay.style.display === 'flex') closeInfo(); });

/* ---------- b√∫squeda (simple) ---------- */
function searchProducts(){
  const searchTerm = document.getElementById('searchInput').value;
  if(!searchTerm.trim()){
    loadProductsAll();
    return;
  }
  const q = searchTerm.trim().toLowerCase();
  const found = lastProductsCache.filter(p => {
    const d = p.data || {};
    return (String(firstKeyValue(d, ['name','nombre','producto','Nombre']) || '').toLowerCase().includes(q) ||
            String(firstKeyValue(d, ['descripcion','Descripcion','description']) || '').toLowerCase().includes(q));
  }).map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey }));
  renderProducts(found, lastLoadedSheetKey || 'ALL');
}

const searchInputEl = document.getElementById('searchInput');
if(searchInputEl){
  searchInputEl.addEventListener('keypress', function(e){
    if(e.key === 'Enter') searchProducts();
  });
}

function loadMore(){
  alert('¬°Cargando m√°s c√≥mics!\n\nSi deseas, configura paginaci√≥n en el worker y aqu√≠ puedes hacer peticiones por p√°gina.');
}

/* ---------- inicializaci√≥n UI (carrusel + carga) ---------- */
let currentSlide = 0;
let totalSlides = document.querySelectorAll('.carousel .carousel-item').length || 1;
function initDots(){
  const dotsContainer = document.getElementById('carouselDots');
  if(!dotsContainer) return;
  dotsContainer.innerHTML = '';
  for(let i=0;i<totalSlides;i++){
      const dot = document.createElement('div');
      dot.className='dot';
      if(i===0) dot.classList.add('active');
      dot.onclick = ()=>goToSlide(i);
      dotsContainer.appendChild(dot);
  }
}
function moveCarousel(direction){
  currentSlide += direction;
  if(currentSlide < 0) currentSlide = totalSlides - 1;
  if(currentSlide >= totalSlides) currentSlide = 0;
  updateCarousel();
}
function goToSlide(index){ currentSlide = index; updateCarousel(); }
function updateCarousel(){
  const carousel = document.querySelector('.carousel');
  if(!carousel) return;
  carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
  const dots = document.querySelectorAll('.dot');
  dots.forEach((dot, idx)=> dot.classList.toggle('active', idx === currentSlide));
}
setInterval(()=> moveCarousel(1), 5000);

/* ------------------ Carrusel din√°mico desde productos ------------------ */
function getProductImageUrl(p){
  const d = p && p.data ? p.data : {};
  const img = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || d.imagen || d.image || '';
  return img && /^https?:\/\//i.test(img) ? img : null;
}

function populateCarouselFromProducts(products, maxSlides = 6){
  try {
    const carouselEl = document.querySelector('.carousel');
    const dotsContainer = document.getElementById('carouselDots');
    if(!carouselEl) return;

    // elegir hasta maxSlides productos que tengan imagen
    const slides = [];
    for (let i = 0; i < (products || []).length && slides.length < maxSlides; i++){
      const p = products[i];
      const img = getProductImageUrl(p);
      if(img) slides.push({
        img,
        title: firstKeyValue(p.data||{}, ['name','nombre','producto','Nombre']) || (p.data && (p.data.Nombre || '')),
        price: firstKeyValue(p.data||{}, ['price','precio','Precio']) || (p.data && p.data.Precio) || ''
      });
    }

    // Si no hay slides con imagen, no modificar
    if(!slides.length) return;

    // Vaciar y construir nuevos items
    carouselEl.innerHTML = '';
    slides.forEach(s => {
      const item = document.createElement('div');
      item.className = 'carousel-item';

      // wrapper cuadrado centrado
      const wrap = document.createElement('div');
      wrap.className = 'carousel-img-wrap';

      // crear imagen (usa proxy si existe)
      const imgEl = makeImgEl(s.img, s.title || 'Slide', 'carousel-img');
      // no forzamos cover; dejamos que la clase CSS (object-fit: contain) la gestione
      imgEl.loading = 'eager'; // cargar r√°pido para el carrusel

      // Append img to wrapper
      wrap.appendChild(imgEl);

      // caption
      const caption = document.createElement('div');
      caption.className = 'carousel-caption';
      caption.innerHTML = `<h3>${escapeHtml(s.title || '')}</h3><p>${s.price ? ('$ ' + fmtPrice(s.price)) : ''}</p>`;

      item.appendChild(wrap);
      item.appendChild(caption);
      carouselEl.appendChild(item);

      // hacer click en la imagen abre el modal (opcional)
      imgEl.addEventListener('click', ()=> openImageModal(s.img, s.title));
    });

    // recalcular totalSlides y reiniciar dots + estado del carousel
    totalSlides = document.querySelectorAll('.carousel .carousel-item').length || 1;

    // reiniciar los dots
    if(typeof initDots === 'function'){
      initDots();
    } else {
      if(dotsContainer){
        dotsContainer.innerHTML = '';
        for(let i=0;i<totalSlides;i++){
          const dot = document.createElement('div');
          dot.className = 'dot' + (i===0 ? ' active' : '');
          dot.onclick = ()=> goToSlide(i);
          dotsContainer.appendChild(dot);
        }
      }
    }

    // resetear √≠ndice y mostrar primer slide
    if(typeof goToSlide === 'function') goToSlide(0);
    else if(typeof updateCarousel === 'function') updateCarousel();

  } catch (err){
    console.warn('populateCarouselFromProducts error', err);
  }
}

/* ---------- boot ---------- */
(function(){
  updateCartUI();
  initDots();
  loadCategories();
})();

/* ----------------- PAGO CON TARJETA ----------------- */
const cardModalOverlay = document.getElementById('card-modal-overlay');
const otpModalOverlay = document.getElementById('otp-modal-overlay');
let _pendingPayment = null; // { items: [...], customer: {...}, amount }

function openCardPaymentModal(){
  if(cart.length === 0){
    alert('El carrito est√° vac√≠o');
    return;
  }
  // limpiar errores y campos (si existen)
  const errEl = document.getElementById('card-errors'); if(errEl) errEl.innerText = '';
  ['card-name','card-email','card-phone','card-address','card-number','card-exp','card-cvv'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.value = '';
  });
  if(cardModalOverlay) cardModalOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeCardPaymentModal(){ if(cardModalOverlay) cardModalOverlay.style.display = 'none'; document.body.style.overflow = ''; }

function luhnCheck(num){
  const s = String(num).replace(/\D/g,''); if(!s) return false;
  let sum = 0; let alt = false;
  for(let i = s.length - 1; i >= 0; i--){
    const ch = s.charAt(i); const d = Number(ch);
    if(Number.isNaN(d)) return false;
    let v = d;
    if(alt){ v = v * 2; if(v > 9) v = v - 9; }
    sum = sum + v;
    alt = !alt;
  }
  return (sum % 10) === 0;
}

function validateCardInputs(){
  const name = document.getElementById('card-name').value.trim();
  const email = document.getElementById('card-email').value.trim();
  const phone = document.getElementById('card-phone').value.trim();
  const addr = document.getElementById('card-address').value.trim();
  const number = document.getElementById('card-number').value.replace(/\s+/g,'');
  const exp = document.getElementById('card-exp').value.trim();
  const cvv = document.getElementById('card-cvv').value.trim();

  if(!name || !email || !phone || !addr) return 'Completa tus datos personales.';
  if(!number || number.length < 12) return 'N√∫mero de tarjeta inv√°lido.';
  if(!luhnCheck(number)) return 'N√∫mero de tarjeta no pasa Luhn (tarjeta inv√°lida de prueba).';
  if(!exp || !/^(0[1-9]|1[0-2])\/(\d{2})$/.test(exp)) return 'Formato MM/AA inv√°lido.';
  const parts = exp.split('/'); const mm = Number(parts[0]); const yy = Number(parts[1]);
  const now = new Date(); const yearFull = 2000 + yy; const expDate = new Date(yearFull, mm - 1, 1);
  if(expDate.getFullYear() < now.getFullYear() || (expDate.getFullYear() === now.getFullYear() && (mm - 1) < now.getMonth())){ return 'La tarjeta est√° vencida.'; }
  if(!cvv || cvv.length < 3) return 'CVV inv√°lido.';
  return null;
}

document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'card-submit'){ 
    const err = validateCardInputs();
    const errEl = document.getElementById('card-errors');
    if(err){ if(errEl) errEl.innerText = err; return; }
    const amount = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
    const customer = { name: document.getElementById('card-name').value.trim(), email: document.getElementById('card-email').value.trim(), phone: document.getElementById('card-phone').value.trim(), address: document.getElementById('card-address').value.trim() };
    _pendingPayment = { items: JSON.parse(JSON.stringify(cart)), customer, amount };
    // mostrar OTP modal
    if(otpModalOverlay) otpModalOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  if(e.target && e.target.id === 'card-cancel'){ closeCardPaymentModal(); }
});

if(document.getElementById('otp-confirm')){
  document.getElementById('otp-confirm').addEventListener('click', async ()=>{ 
    const code = (document.getElementById('otp-input') || {}).value || '';
    if(!code){ alert('Ingresa el c√≥digo OTP'); return; }
    if(code !== '123456'){
      alert('Pago fallido: OTP incorrecto.');
      if(otpModalOverlay) otpModalOverlay.style.display = 'none';
      if(cardModalOverlay) cardModalOverlay.style.display = 'none';
      document.body.style.overflow = '';
      return;
    }

    // Intentar decrementar en servidor; si falla, re-sincronizar los items fallidos
    const items = (_pendingPayment && _pendingPayment.items) || [];
    let failures = [];
    try {
      failures = await finalizePurchaseOnServer(items);
    } catch(e){
      console.warn('Error finalizando compra en servidor', e);
      failures = items.slice();
    }

    if (failures.length === 0){
      // refrescar stock real desde servidor para cada item comprado (asegura UI sincronizada)
      try {
        await Promise.all(items.map(it => refreshStockFromServerForItem(it.sheetKey, it.row).catch(()=>{})));
      } catch(e){
        console.warn('Error refrescando stock tras pago:', e);
      }

      const fakeToken = 'tok_' + Date.now();
      alert('Pago confirmado. Token: ' + fakeToken + '\nGracias por tu compra.');
      // limpiar carrito (ya se ha decrementado en el servidor)
      cart = [];
      saveCart();
      updateCartUI();
      refreshAllCardDisplays();
      if(otpModalOverlay) otpModalOverlay.style.display = 'none';
      if(cardModalOverlay) cardModalOverlay.style.display = 'none';
      closeCartPopup();
      document.body.style.overflow = '';
      return;
    } else {
      // hubo fallos: re-sincronizar el stock real para los items afectados
      alert('Hubo un problema actualizando el stock para algunos productos. La p√°gina se sincronizar√° con el stock real.');
      try {
        await Promise.all(failures.map(it => refreshStockFromServerForItem(it.sheetKey, it.row).catch(()=>{})));
      } catch(e){ console.warn('Error refrescando stock tras fallo', e); }
      // no limpiamos el carrito para que el usuario revise/edite
      if(otpModalOverlay) otpModalOverlay.style.display = 'none';
      if(cardModalOverlay) cardModalOverlay.style.display = 'none';
      document.body.style.overflow = '';
      return;
    }
  });
}
if(document.getElementById('otp-cancel')){
  document.getElementById('otp-cancel').addEventListener('click', ()=>{
    if(otpModalOverlay) otpModalOverlay.style.display = 'none';
    if(cardModalOverlay) cardModalOverlay.style.display = 'none';
    document.body.style.overflow = '';
  });
}

/* ----------------- fin pago ----------------- */
</script>
</body>
</html>

