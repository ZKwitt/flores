<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo ‚Äî Marrie</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg1: #fef6fa;
      --bg2: #f5f0ff;
      --primary: #ff6b9d;
      --secondary: #c66fbc;
      --accent: #66d9ef;
      --muted: #8b7f99;
      --card-bg: rgba(255,255,255,0.98);
      --soft-shadow: 0 20px 60px rgba(150,100,200,0.08);
      --hover-shadow: 0 25px 70px rgba(150,100,200,0.12);
      --gradient1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient3: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --gradient-soft: linear-gradient(135deg, rgba(255,107,157,0.1) 0%, rgba(102,217,239,0.1) 100%);
    }
    body{
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background:
        radial-gradient(ellipse at top left, rgba(255,182,193,0.3) 0%, transparent 50%),
        radial-gradient(ellipse at top right, rgba(221,160,221,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at bottom left, rgba(176,224,230,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(255,218,185,0.2) 0%, transparent 50%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height:100vh;
      padding:36px;
      color:#2a2438;
      position: relative;
      overflow-x: hidden;
    }
    /* animated gradient orbs */
    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.3;
      pointer-events: none;
      animation: float 20s ease-in-out infinite;
    }
    body::before { width: 600px; height: 600px; background: linear-gradient(135deg, #667eea, #ff6b9d); top: -200px; left: -200px; }
    body::after  { width: 500px; height: 500px; background: linear-gradient(135deg, #66d9ef, #f093fb); bottom: -150px; right: -150px; animation-delay: -10s; }
    @keyframes float { 0%,100%{transform:translate(0,0) scale(1)} 25%{transform:translate(30px,-30px) scale(1.05)} 50%{transform:translate(-20px,20px) scale(0.95)} 75%{transform:translate(-30px,-10px) scale(1.02)} }

    /* Emoji decorative background container (behind content) */
    .emoji-bg { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .emoji-bg .emoji { position: absolute; will-change: transform, opacity; opacity: 0.06; filter: blur(0.3px); animation: floatEmoji linear infinite; transform-origin: center; mix-blend-mode: screen; }
    @keyframes floatEmoji { 0% { transform: translateY(0) rotate(0deg) } 50% { transform: translateY(-40px) rotate(18deg) } 100% { transform: translateY(0) rotate(0deg) } }

    /* header */
    .header{ text-align:center; margin-bottom:30px; position:relative; z-index:1; animation: fadeInDown 0.8s ease; }
    .header h1{ font-size:2.8rem; font-weight:900; background: var(--gradient2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:8px; letter-spacing:-0.02em; filter: drop-shadow(2px 2px 20px rgba(255,107,157,0.3)); }
    .header p{ color:var(--muted); font-size:1.1rem; font-weight:500; letter-spacing:0.5px; }
    @keyframes fadeInDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
    /* tabs */
    #tabs{ display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin:20px 0 30px; z-index:1; position:relative; animation: fadeIn 1s ease 0.3s both; overflow:visible; }
    .tab{ background: var(--card-bg); padding:10px 20px; border-radius:999px; border:2px solid rgba(255,107,157,0.1); font-weight:600; cursor:pointer; color:#5a4a6b; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); box-shadow:0 4px 15px rgba(0,0,0,0.05); position:relative; overflow:visible; z-index:1; }
    .tab::before{ content:''; position:absolute; inset:0; background: var(--gradient-soft); opacity:0; transition:opacity 0.3s; border-radius:999px; }
    .tab:hover{ transform:translateY(-3px); box-shadow:0 8px 25px rgba(255,107,157,0.15); border-color:rgba(255,107,157,0.3); }
    .tab:hover::before{ opacity:1; }
    .tab.active{ background: var(--gradient2); color:#fff; border-color:transparent; box-shadow:0 10px 30px rgba(255,107,157,0.25); transform: translateY(-3px) scale(1.03); z-index:10; }
    .tab:focus-visible{ outline: 3px solid rgba(102,217,239,0.25); outline-offset:4px; }
    @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
    /* content */
    #content { max-width:1200px; margin:0 auto; min-height:160px; text-align:center; z-index:1; animation: fadeInUp 0.8s ease 0.5s both; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .loading{ text-align:center; padding:60px 0; color:var(--muted); font-weight:600; font-size:1.1rem; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(320px,1fr)); gap:25px; align-items:start; }
    /* card */
    .card{ position:relative; perspective:1000px; animation: cardEntry 0.6s ease both; animation-delay: calc(var(--card-index, 0) * 0.05s); transition: opacity 0.25s ease, transform 0.2s ease; }
    @keyframes cardEntry { from{opacity:0;transform:translateY(30px) scale(0.95)} to{opacity:1;transform:translateY(0) scale(1)} }
    .flip-inner{ position:relative; width:100%; min-height:440px; border-radius:24px; overflow:visible; transition:none; }
    .face{ position:absolute; inset:0; border-radius:24px; overflow:hidden; box-shadow: var(--soft-shadow); transition: all 0.4s cubic-bezier(0.4,0,0.2,1); background: var(--card-bg); border:1px solid rgba(255,255,255,0.8); display:flex; flex-direction:column; justify-content:space-between; padding-bottom:16px; backface-visibility:hidden; backdrop-filter: blur(10px); }
    .face::before{ content:''; position:absolute; inset:0; background: var(--gradient-soft); opacity:0.3; pointer-events:none; border-radius:24px; }
    .face.front{ opacity:1; transform: translateY(0) rotateX(0); visibility:visible; z-index:2; position:relative; }
    .face.back{ opacity:0; transform: translateY(10px) rotateX(-10deg); visibility:hidden; z-index:1; }
    .flip-inner.flipped .face.front{ opacity:0; transform: translateY(-10px) rotateX(10deg); visibility:hidden; z-index:1; }
    .flip-inner.flipped .face.back{ opacity:1; transform: translateY(0) rotateX(0); visibility:visible; z-index:2; }
    /* eye-toggle */
    .eye-toggle{ position:absolute; left:16px; top:16px; width:48px; height:48px; border-radius:16px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); border:2px solid rgba(255,107,157,0.15); cursor:pointer; z-index:10; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 8px 20px rgba(0,0,0,0.08); }
    .eye-toggle:hover{ transform:scale(1.1) rotate(5deg); box-shadow:0 12px 30px rgba(255,107,157,0.2); border-color:rgba(255,107,157,0.3); background: linear-gradient(135deg, #fff, rgba(255,107,157,0.1)); }
    .eye-toggle:active{ transform:scale(0.95); }
    /* front image */
    .front-image{ width:130px; height:130px; border-radius:50%; overflow:hidden; margin:30px auto 16px; box-shadow: 0 20px 40px rgba(255,107,157,0.15), 0 0 0 6px rgba(255,255,255,0.5), 0 0 0 12px rgba(255,107,157,0.1); background:linear-gradient(135deg,#fff,#fef0f5); display:flex; align-items:center; justify-content:center; font-size:52px; position:relative; z-index:1; transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
    .card:hover .front-image{ transform: scale(1.05) rotate(3deg); }
    .product-img{ width:100%; height:100%; object-fit:cover; display:block; }
    .name{ font-weight:700; text-align:center; margin-top:8px; font-size:1.15rem; color:#2a2438; padding:0 20px; position:relative; z-index:1; }
    .cat{ font-size:13px; color:var(--muted); text-align:center; margin-top:8px; font-weight:500; position:relative; z-index:1; }
    .meta{ padding:10px 20px 0; display:flex; flex-direction:column; gap:12px; align-items:center; position:relative; z-index:1; }
    .price{ font-size:1.6rem; font-weight:800; text-align:center; background: var(--gradient2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .stock{ font-size:.9rem; padding:8px 16px; border-radius:999px; color:#fff; font-weight:700; background: var(--gradient3); box-shadow:0 4px 15px rgba(255,107,157,0.2); }
    /* actions */
    .actions{ display:flex; gap:12px; align-items:center; justify-content:center; padding:12px 20px 10px; position:relative; z-index:1; }
    .small{ width:36px; height:36px; border-radius:12px; border:2px solid rgba(255,107,157,0.15); background:linear-gradient(135deg, #fff, rgba(255,107,157,0.05)); cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:700; color:#5a4a6b; transition:all 0.2s; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .small:hover{ transform:scale(1.1); border-color:rgba(255,107,157,0.3); box-shadow:0 6px 15px rgba(255,107,157,0.15); }
    /* improved selected/active visual state for small buttons */
    .small:active, .small.selected, .small:focus-visible { background: var(--gradient2); color:#fff; border-color:transparent; box-shadow: 0 10px 25px rgba(255,107,157,0.25); transform: translateY(-2px) scale(1.03); }
    .small.selected { border-radius:12px; }

    .qty{ min-width:36px; text-align:center; font-weight:800; font-size:1.1rem; color:#2a2438; }
    .btn.order{ background: var(--gradient2); color:#fff; padding:12px 24px; border-radius:999px; border:0; cursor:pointer; font-weight:700; font-size:0.95rem; letter-spacing:0.5px; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); box-shadow:0 8px 20px rgba(255,107,157,0.25); }
    .btn.order:hover:not([disabled]){ transform:translateY(-2px); box-shadow:0 12px 30px rgba(255,107,157,0.35); }
    .btn.order:active, .btn.order:focus-visible{ transform:translateY(-1px) scale(0.995); }
    .btn.order[disabled]{ opacity:.4; cursor:not-allowed; background: linear-gradient(135deg, #ccc, #999); }
    /* back */
    .back-image-wrap{ width:calc(100% - 24px); height:240px; border-radius:20px; overflow:hidden; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #fef0f5, #f0f4ff); margin:10px 12px 8px; position:relative; z-index:1; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
    .back-image{ width:100%; height:100%; object-fit:contain; display:block; cursor:zoom-in; transition: transform 0.3s; border-radius:20px; }
    .back-image:hover{ transform: scale(1.05); }
    .desc-box{ width:calc(100% - 24px); max-height:120px; overflow:auto; margin:0 12px 10px; padding:14px; border-radius:16px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,240,245,0.9)); border:1px solid rgba(255,107,157,0.1); font-size:0.95rem; color:#5a4a6b; line-height:1.6; position:relative; z-index:1; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .desc-box::-webkit-scrollbar{ width:6px; }
    .desc-box::-webkit-scrollbar-track{ background: rgba(255,107,157,0.05); border-radius:10px; }
    .desc-box::-webkit-scrollbar-thumb{ background: rgba(255,107,157,0.3); border-radius:10px; }
    .desc-box::-webkit-scrollbar-thumb:hover{ background: rgba(255,107,157,0.5); }
    /* cart + modal styles omitted for brevity (kept same as before) - they are included below unmodified */
    #cart-btn{ position: fixed; bottom: 30px; right: 30px; background: var(--gradient2); color: #fff; padding: 16px 24px; border-radius: 999px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1rem; box-shadow: 0 10px 30px rgba(255,107,157,0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; animation: cartBounce 2s ease infinite; }
    @keyframes cartBounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
    #cart-btn:hover{ transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 40px rgba(255,107,157,0.4); }
    #cart-icon{ font-size: 1.3rem; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
    #cart-count{ background: #fff; color: var(--primary); padding: 4px 10px; border-radius: 999px; font-size: 0.85rem; font-weight: 800; min-width: 24px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #cart-popup-overlay{ position: fixed; inset: 0; background: rgba(30,20,50,0.7); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; animation: fadeIn 0.3s ease; }
    #cart-popup{ background: linear-gradient(135deg, #fff 0%, #fef5f8 100%); border-radius: 24px; padding: 30px; max-width: 500px; width: 100%; max-height: 80vh; overflow: auto; box-shadow: 0 30px 60px rgba(255,107,157,0.2), 0 0 0 1px rgba(255,255,255,0.5); animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid rgba(255,107,157,0.1); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    #cart-popup h3{ font-size: 1.8rem; margin-bottom: 20px; background: var(--gradient2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-align: center; font-weight: 800; }
    #cart-items-container{ margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 16px; border: 1px solid rgba(255,107,157,0.1); max-height: 350px; overflow-y: auto; }
    .cart-item{ display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 10px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,240,245,0.9)); border-radius: 12px; border: 1px solid rgba(255,107,157,0.08); transition: all 0.2s; }
    .cart-item:hover{ transform: translateX(5px); box-shadow: 0 5px 15px rgba(255,107,157,0.1); }
    .cart-item-name{ font-weight: 600; color: #2a2438; flex: 1; }
    .cart-item-qty{ background: var(--gradient3); color: #fff; padding: 4px 12px; border-radius: 999px; font-weight: 700; font-size: 0.85rem; margin: 0 10px; }
    .cart-item-price{ font-weight: 700; color: var(--primary); }
    .cart-item-remove{ background: rgba(255,107,157,0.1); color: var(--primary); border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; margin-left: 10px; transition: all 0.2s; font-weight: 600; }
    .cart-item-remove:hover{ background: rgba(255,107,157,0.2); transform: scale(1.05); }
    #cart-total{ text-align: center; font-size: 1.3rem; font-weight: 800; padding: 15px; background: var(--gradient-soft); border-radius: 12px; margin-top: 15px; color: #2a2438; }
    #cart-confirm{ background: var(--gradient2); color: #fff; padding: 14px 28px; border-radius: 999px; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(255,107,157,0.25); transition: all 0.3s; font-size: 1rem; }
    #cart-confirm:hover{ transform: translateY(-2px); box-shadow: 0 12px 30px rgba(255,107,157,0.35); }
    /* cart-close updated to be a circular X button */
    #cart-close{ background: rgba(255,255,255,0.95); color: var(--muted); padding: 0; width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; border: 2px solid rgba(0,0,0,0.05); font-weight: 700; cursor: pointer; transition: all 0.2s; }
    #cart-close:hover{ border-color: rgba(255,107,157,0.2); background: var(--gradient2); color:#fff; }
    /* modal */
    #img-modal-overlay{ position:fixed; inset:0; display:none; background:rgba(30,20,50,0.85); backdrop-filter: blur(15px); align-items:center; justify-content:center; z-index:20000; padding:20px; animation: fadeIn 0.3s ease; }
    #img-modal{ max-width:95vw; max-height:95vh; overflow:auto; border-radius:20px; box-shadow:0 30px 80px rgba(255,107,157,0.3); background:linear-gradient(135deg, #fff, #fef5f8); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; border: 2px solid rgba(255,107,157,0.1); animation: zoomIn 0.4s cubic-bezier(0.4,0,0.2,1); }
    @keyframes zoomIn { from { opacity:0; transform:scale(0.8); } to { opacity:1; transform:scale(1); } }
    #img-modal img{ max-width:100%; max-height:80vh; object-fit:contain; display:block; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    #img-modal-close{ align-self:flex-end; margin-bottom:10px; background: linear-gradient(135deg, #fff, rgba(255,107,157,0.1)); color: var(--primary); padding: 10px 20px; border-radius: 999px; border: 2px solid rgba(255,107,157,0.2); font-weight: 600; cursor: pointer; transition: all 0.2s; }
    #img-modal-close:hover{ transform: scale(1.05); background: var(--gradient2); color:#fff; border-color:transparent; }
    /* responsive */
    @media (max-width:768px) { .header h1 { font-size: 2.2rem; } .grid { grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 20px; } #cart-btn { bottom: 20px; right: 20px; padding: 14px 20px; } }
    @media (max-width:520px) { body { padding: 20px; } .header h1 { font-size: 1.8rem; } .grid { grid-template-columns: 1fr; } .front-image { width: 110px; height: 110px; } .flip-inner { min-height: 400px; } .back-image-wrap { height: 200px; } #cart-popup { padding: 20px; } #cart-btn { bottom: 15px; right: 15px; padding: 12px 18px; font-size: 0.9rem; } }
    /* loading dots */
    .loading::after { content: '...'; animation: dots 1.5s steps(4,end) infinite; }
    @keyframes dots { 0%,20%{content:'.'} 40%{content:'..'} 60%,100%{content:'...'} }
  </style>
</head>
<body>
  <div class="header">
    <h1>üíÑ Marrie</h1>
    <p>Belleza suave ¬∑ calidad que perdura</p>
  </div>

  <div id="app" style="position:relative;z-index:1">
    <div id="tabs">Cargando categor√≠as...</div>
    <div id="content"><div class="loading">Cargando productos</div></div>
  </div>

  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">üõí</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay" style="display:none">
    <div id="cart-popup" role="dialog" aria-modal="true">
      <h3>‚ú® Confirmar pedido</h3>
      <div id="cart-items-container"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:20px;flex-wrap:wrap">
        <button id="cart-close" class="small">‚úï</button>
        <button id="cart-confirm" class="btn order">Enviar por WhatsApp üì±</button>
      </div>
    </div>
  </div>

  <!-- image modal -->
  <div id="img-modal-overlay" role="dialog" aria-hidden="true">
    <div id="img-modal">
      <button id="img-modal-close" class="small">‚úï Cerrar</button>
      <img id="img-modal-img" alt="Imagen completa">
    </div>
  </div>
  <script>
    const API_URL = "https://d.thepersonmrt.workers.dev/"; // tu worker
    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');
    let lastProductsCache = []; // almacenar√° productos (cada objeto incluye .sheetKey y .row)
    let lastLoadedSheetKey = null;
    let availableSheetKeys = []; // keys v√°lidas devueltas por GET /

    (function(){
      // create emoji decorative background
      const emojis = ['üíÑ','üíã','üå∏','‚ú®','ü©∑','üå∫'];
      const count = 14; // number of emoji elements
      const container = document.createElement('div');
      container.className = 'emoji-bg';

      for(let i=0;i<count;i++){
        const s = document.createElement('span');
        s.className = 'emoji';
        s.textContent = emojis[i % emojis.length];

        const size = Math.round((Math.random()*36)+20); // 20-56px
        s.style.fontSize = size + 'px';
        s.style.left = (Math.random()*100) + '%';
        s.style.top = (Math.random()*100) + '%';
        s.style.opacity = (Math.random()*0.06) + 0.03; // very low opacity
        s.style.animationDuration = (18 + Math.random()*32) + 's';
        s.style.animationDelay = (-Math.random()*20) + 's';
        s.style.transform = 'translate3d(0,0,0)';
        s.style.zIndex = '0';

        container.appendChild(s);
      }

      document.body.appendChild(container);

      // Fix interactive visuals: tabs, small button click states
      document.addEventListener('click', function(e){
        // tabs: toggle active class for visual
        if(e.target.matches('.tab')){
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
        }
        // small buttons: toggle a selected visual state (purely visual)
        if(e.target.matches('.small')){
          // some small buttons are quantity controls ‚Äî do not prevent native behavior, only toggle visual class briefly
          e.target.classList.toggle('selected');
        }
      });

      // Ensure cart-close is an accessible X button (already changed in HTML), but set aria-label
      const cartClose = document.getElementById('cart-close');
      if(cartClose){
        cartClose.setAttribute('aria-label','Cerrar carrito');
      }

      // keyboard users: add focus-visible helper
      document.addEventListener('keydown', function(e){ if(e.key === 'Tab') document.documentElement.classList.add('kbd'); });

      // optional: gently reposition emojis on resize so they don't overlap critical elements too often
      window.addEventListener('resize', function(){
        const els = document.querySelectorAll('.emoji-bg .emoji');
        els.forEach(el => {
          if(Math.random() < 0.35){ el.style.left = (Math.random()*100) + '%'; el.style.top = (Math.random()*100) + '%'; }
        });
      });

    })();
    
    function firstKeyValue(obj, keys){
      if (!obj) return undefined;
      const map = {};
      Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
      for (let key of keys){
        const v = map[key.toLowerCase()];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return undefined;
    }

    function fmtPrice(v){
      if (v===undefined || v===null) return '-';
      const s = String(v).trim();
      if (s === '') return '-';
      const n = parsePriceNumber(s);
      if (/^[\d\.\,]+$/.test(s)) {
        return Number(n).toLocaleString('de-DE');
      }
      return s;
    }

    function parsePriceNumber(v){
      if (v === undefined || v === null) return 0;
      if (typeof v === 'number' && !isNaN(v)) return v;
      let s = String(v).trim();
      if (s === '') return 0;
      s = s.replace(/\s+/g, '');
      s = s.replace(/\./g, '');
      s = s.replace(/,/g, '.');
      s = s.replace(/[^0-9.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* Carrito */
    const WHATSAPP_NUMBER = '573207378992';
    let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

    const cartBtn = document.getElementById('cart-btn');
    const cartCountEl = document.getElementById('cart-count');
    const cartSummaryEl = document.getElementById('cart-summary');
    const cartOverlay = document.getElementById('cart-popup-overlay');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCloseBtn = document.getElementById('cart-close');
    const cartConfirmBtn = document.getElementById('cart-confirm');

    function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
    function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

    // Buscar en lastProductsCache por row + sheetKey (evita ambig√ºedades en "ALL")
    function findProductInCache(sheetKey, row){
      if(!Array.isArray(lastProductsCache)) return null;
      // normalizar sheetKey
      const targetSk = (sheetKey || '').toString().trim();
      return lastProductsCache.find(pp => {
        const sk = (pp.sheetKey || (pp.data && (pp.data.Categoria || pp.data.Categoria || pp.data.categoria)) || '').toString().trim();
        return String(pp.row) === String(row) && sk.toString().trim().toLowerCase() === targetSk.toLowerCase();
      }) || null;
    }

    function getOriginalStock(sheetKey, row){
      // primero intentar desde el DOM (dataset), luego desde lastProductsCache con match sheetKey+row
      const card = Array.from(document.querySelectorAll('.card')).find(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk.toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
      });
      if (card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);

      const p = findProductInCache(sheetKey, row);
      if (p){
        const d = p.data || {};
        const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0;
        return Number(stock || 0);
      }

      // fallback: search by row only (legacy)
      const p2 = (Array.isArray(lastProductsCache) && lastProductsCache.find(pp=>String(pp.row)===String(row))) || null;
      if(p2){
        const d = p2.data || {};
        const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || 0;
        return Number(stock || 0);
      }
      return 0;
    }

    function getReservedQty(sheetKey, row){
      return cart.filter(i => (i.sheetKey||'').toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
    }

    function refreshCardStockDisplay(sheetKey, row){
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString().trim().toLowerCase();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
      });
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey, row);
      const avail = Math.max(0, origStock - reserved);
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan) stockSpan.innerText = avail;
        const orderBtn = card.querySelector('.order');
        if(avail <= 0){
          card.classList.add('out');
          card.style.opacity = '0.45'; // baja opacidad cuando no hay stock
          if(orderBtn) orderBtn.disabled = true;
        } else {
          card.classList.remove('out');
          card.style.opacity = ''; // restaurar opacidad
          if(orderBtn) orderBtn.disabled = false;
        }
      });
    }

    function updateCartUI(){
      const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
      const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
      cartCountEl.innerText = count;
      cartSummaryEl.innerText = count > 0 ? 'Carrito' : 'Carrito vac√≠o';
      if(cartBtn) cartBtn.style.display = count > 0 ? 'flex' : 'none';
      if(cartBtn) cartBtn.title = count ? `${count} item(s) en carrito ‚Äî Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vac√≠o';
      saveCart();
    }

    /**
     * updateStockOnServer_decrement
     * - Usa action: "decrement" (AppsScript hace newStock = current - 1).
     * - Llama tantas veces como qty (serial) para decrementar exactamente la cantidad.
     * - Confirma la respuesta y actualiza dataset.origStock si el server devuelve ok.
     */
    async function updateStockOnServer_decrement(sheetKeyRaw, row, qty){
      if(!qty || qty <= 0) return;
      // Mapear sheetKeyRaw a uno v√°lido (case-insensitive) si tenemos availableSheetKeys
      const mappedKey = mapToAvailableSheetKey(sheetKeyRaw);
      if(!mappedKey){
        console.warn('updateStockOnServer_decrement: sheetKey no reconocido, no se enviar√° petici√≥n:', sheetKeyRaw);
        return;
      }

      for(let i=0;i<qty;i++){
        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row) })
          });
          const text = await resp.text().catch(()=>null);
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }

          if(resp.ok && json && !json.error){
            // AppsScript responde {status:'ok', oldStock, newStock}
            const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : undefined;
            if(confirmedStock !== undefined){
              // actualizar todas las tarjetas que coincidan
              document.querySelectorAll('.card').forEach(card=>{
                const csk = (card.dataset.sheetKey||'').toString().trim();
                const rw = card.dataset.row;
                if(String(rw) === String(row) && (csk.toLowerCase() === mappedKey.toLowerCase() || csk.toLowerCase() === sheetKeyRaw.toString().trim().toLowerCase())){
                  card.dataset.origStock = String(confirmedStock);
                }
              });
              refreshCardStockDisplay(mappedKey, row);
            }
            // continuar al siguiente decremento
          } else {
            console.warn('Decrement fallo o respuesta inesperada:', resp.status, text);
            break; // romper el loop si el servidor fall√≥
          }
        } catch (err){
          console.warn('Decrement petici√≥n fall√≥:', err);
          break;
        }
      }
    }

    function mapToAvailableSheetKey(input){
      if(!input) return null;
      const s = String(input).trim();
      if(availableSheetKeys && availableSheetKeys.length){
        const found = availableSheetKeys.find(k => String(k).toLowerCase() === s.toLowerCase());
        if(found) return found;
      }
      // fallback: devolver input si parece v√°lido (no ideal)
      return s || null;
    }

    /**
     * fetchServerStock(sheetKey, row)
     * - lee desde API (GET ?sheetKey=...) y devuelve el stock num√©rico o null
     */
    async function fetchServerStock(sheetKeyRaw, row){
      try {
        const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
        if(!mappedKey) return null;
        const resp = await fetch(API_URL + '?sheetKey=' + encodeURIComponent(mappedKey), { cache: 'no-store' });
        if(!resp.ok) return null;
        const json = await resp.json().catch(()=>null);
        if(!json || !Array.isArray(json.products)) return null;
        const found = json.products.find(p => String(p.row) === String(row));
        if(!found) return null;
        const stockVal = firstKeyValue(found.data || {}, ['stock','cantidad','Stock']) || found.data && (found.data.Stock || found.data.cantidad) || 0;
        return Number(stockVal || 0);
      } catch (err) {
        console.warn('fetchServerStock error', err);
        return null;
      }
    }

    /**
     * updateStockOnServer_set
     * - setea un nuevo stock (acci√≥n 'set' del AppsScript)
     * - usa respuesta para confirmar dataset.origStock; si falla hace fallback optimistic
     */
    async function updateStockOnServer_set(sheetKeyRaw, row, newStock){
      const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'set', sheetKey: mappedKey, row: String(row), value: String(newStock) })
        });

        const text = await resp.text().catch(()=>null);
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }

        if(resp.ok && json && !json.error){
          const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : Number(newStock);
          document.querySelectorAll('.card').forEach(card=>{
            const csk = (card.dataset.sheetKey||'').toString().trim();
            const rw = card.dataset.row;
            if(String(rw) === String(row) && (csk.toLowerCase() === mappedKey.toLowerCase() || csk.toLowerCase() === sheetKeyRaw.toString().trim().toLowerCase())){
              card.dataset.origStock = String(confirmedStock);
            }
          });
          refreshCardStockDisplay(mappedKey, row);
        } else {
          console.warn('updateStockOnServer_set: respuesta no OK', resp.status, text);
        }
      } catch (err) {
        console.warn('updateStockOnServer_set fallo:', err);
      }
    }

    /**
     * updateStockOnServer_increaseViaSet(sheetKey, row, delta)
     * - lee stock en servidor y hace set = serverStock + delta
     * - sirve para restaurar stock al eliminar items del carrito sin hacer over-increment
     */
    async function updateStockOnServer_increaseViaSet(sheetKeyRaw, row, delta){
      if(!delta || delta <= 0) return;
      const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
      if(!mappedKey){
        console.warn('No sheetKey mapeable a availableSheetKeys, abortando increase/set:', sheetKeyRaw);
        return;
      }

      try {
        const serverStock = await fetchServerStock(mappedKey, row);
        const baseStock = (serverStock !== null && serverStock !== undefined) ? Number(serverStock) : Number(getOriginalStock(mappedKey, row) || 0);
        const newStock = Math.max(0, baseStock + Number(delta));

        // realizar set
        await updateStockOnServer_set(mappedKey, row, newStock);
      } catch (err){
        console.warn('updateStockOnServer_increaseViaSet error', err);
      }
    }

    async function addToCart(card, qty){
      const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
      const row = card.dataset.row;
      const name = card.querySelector('.name')?.innerText || 'Sin nombre';
      const priceRaw = card.dataset.price !== undefined ? card.dataset.price : (card.querySelector('.price')?.innerText || '');
      const priceNum = parsePriceNumber(priceRaw);
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey,row);
      const available = Math.max(0, origStock - reserved);

      if(qty > available){
        alert('No hay suficiente stock disponible.');
        return;
      }

      const key = `${sheetKey}::${row}`;
      const existing = cart.find(i=>cartItemKey(i) === key);
      if(existing){
        existing.qty = Math.min(origStock, existing.qty + qty);
      } else {
        cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
      }

      // actualizar visual (reserva local)
      refreshCardStockDisplay(sheetKey,row);
      updateCartUI();

      // intentar decrementar en servidor (usar decrement repetido)
      updateStockOnServer_decrement(sheetKey, row, qty).catch(e=>console.warn('updateStockOnServer_decrement error', e));

      // Animaci√≥n
      if(cartBtn){
        cartBtn.style.animation = 'none';
        setTimeout(() => {
          cartBtn.style.animation = 'cartBounce 0.5s ease';
        }, 10);
      }
    }

    /* Cart popup functions */
    function openCartPopup(){
      let html = '';
      if(cart.length === 0){
        cartItemsContainer.innerHTML = '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';
        cartTotalEl.innerHTML = '';
        cartOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        return;
      }

      cart.forEach((item, idx) => {
        const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
        html += `
          <div class="cart-item">
            <span class="cart-item-name">${escapeHtml(item.name)}</span>
            <span class="cart-item-qty">x${item.qty}</span>
            <span class="cart-item-price">${Number(itemTotal).toLocaleString('de-DE')}</span>
            <button class="cart-item-remove" onclick="removeFromCart(${idx})">‚úï</button>
          </div>
        `;
      });

      cartItemsContainer.innerHTML = html || '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';

      const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
      cartTotalEl.innerHTML = `üí∞ Total: <span style="color:var(--primary)">${Number(total).toLocaleString('de-DE')}</span>`;

      cartOverlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeCartPopup(){ cartOverlay.style.display = 'none'; document.body.style.overflow = ''; }

    function removeFromCart(idx){
      if(idx >= 0 && idx < cart.length){
        const item = cart[idx];
        const sheetKey = item.sheetKey;
        const row = item.row;
        const removedQty = Number(item.qty || 0);

        // eliminar del carrito (optimistic)
        cart.splice(idx, 1);

        // actualizar UI local
        refreshCardStockDisplay(sheetKey, row);
        updateCartUI();
        openCartPopup(); // refresca popup (mostrar√° carrito vac√≠o cuando corresponda)

        // sincronizar con servidor: aumentar stock de forma segura
        // usa read-server + set-server para evitar over-increment
        updateStockOnServer_increaseViaSet(sheetKey, row, removedQty).catch(e => {
          console.warn('updateStockOnServer_increaseViaSet error', e);
        });
      }
    }

    function sendToWhatsApp(){
      if(cart.length === 0){
        alert('El carrito est√° vac√≠o');
        return;
      }

      let message = '‚ú® *Nuevo Pedido - Marrie* ‚ú®\n\n';
      let total = 0;

      cart.forEach(item => {
        const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
        total += itemTotal;
        message += `üì¶ *${item.name}*\n`;
        message += `   Cantidad: ${item.qty}\n`;
        message += `   Precio: ${Number(itemTotal).toLocaleString('de-DE')}\n\n`;
      });

      message += `üí∞ *TOTAL: ${Number(total).toLocaleString('de-DE')}*\n\n`;
      message += 'üìç Por favor, confirma tu direcci√≥n de env√≠o.';

      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');

      // Clear cart after sending
      cart = [];
      updateCartUI();
      closeCartPopup();
    }

    // Cart event listeners
    cartBtn.addEventListener('click', openCartPopup);
    cartCloseBtn.addEventListener('click', closeCartPopup);
    cartConfirmBtn.addEventListener('click', sendToWhatsApp);
    cartOverlay.addEventListener('click', (e) => { if(e.target === cartOverlay) closeCartPopup(); });

    // Make removeFromCart global
    window.removeFromCart = removeFromCart;

    /* Modal image handlers */
    const imgModalOverlay = document.getElementById('img-modal-overlay');
    const imgModalImg = document.getElementById('img-modal-img');
    const imgModalClose = document.getElementById('img-modal-close');
    function openImageModal(url, alt){
      if(!url) return;
      imgModalImg.src = proxiedUrl(url);
      imgModalImg.alt = alt || '';
      imgModalOverlay.style.display = 'flex';
      imgModalOverlay.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeImageModal(){ imgModalOverlay.style.display = 'none'; imgModalOverlay.setAttribute('aria-hidden','true'); imgModalImg.src = ''; document.body.style.overflow = ''; }
    imgModalClose.addEventListener('click', closeImageModal);
    imgModalOverlay.addEventListener('click', (e)=>{ if(e.target === imgModalOverlay) closeImageModal(); });

    /* utilities */
    function escapeHtml(str){
      if(str === undefined || str === null) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function proxiedUrl(raw){
      if(!raw || typeof raw !== 'string') return '';
      return API_URL + 'image-proxy?url=' + encodeURIComponent(raw);
    }
    function makeImgEl(raw, alt, className){
      const img = document.createElement('img');
      img.alt = alt || '';
      img.className = className || '';
      try { img.src = proxiedUrl(raw); } catch(e){ img.src = ''; }
      img.onerror = () => { img.remove(); };
      return img;
    }

    /* Render products ‚Äî maneja distintos nombres de campos (Nombre/Precio/Stock/Icono/Img/descripcion) */
    function renderProducts(products, sheetKey){
      if (!products || !products.length){
        if(contentEl) contentEl.innerHTML = '<div class="loading">No hay productos</div>';
        return;
      }
      const grid = document.createElement('div');
      grid.className='grid';

      products.forEach((p, index)=>{
        const d = p.data || {};
        const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || d.Nombre || 'Sin nombre';
        const price = firstKeyValue(d, ['price','precio','Precio']) || d.Precio || '';
        const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0);

        const emojiIcon = firstKeyValue(d, ['icono','Icono','icon','emoji']) || d.Icono || 'üõçÔ∏è';
        const imgUrl = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';

        const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota','Nota']) || d.descripcion || d.Descripcion || '';
        const productSheetKey = (p.sheetKey || d.Categoria || sheetKey || 'UNKNOWN').toString();

        const cardWrap = document.createElement('div');
        cardWrap.className = 'card';
        cardWrap.dataset.origStock = String(stock);
        cardWrap.dataset.price = price;
        cardWrap.dataset.row = String(p.row);
        cardWrap.dataset.sheetKey = String(productSheetKey);
        cardWrap.style.setProperty('--card-index', index);

        const inner = document.createElement('div');
        inner.className = 'flip-inner';

        const front = document.createElement('div');
        front.className = 'face front';
        front.innerHTML = `
          <div style="position:relative;padding:12px;">
            <button class="eye-toggle" aria-pressed="false" title="Ver imagen y descripci√≥n" type="button" aria-label="Ver imagen y descripci√≥n">
              <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="#ff6b9d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#ff6b9d" stroke-width="2"/>
              </svg>
            </button>

            <div class="front-image"></div>

            <div class="meta">
              <div class="name">${escapeHtml(name)}</div>
              <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px">
                <div class="price">$ ${fmtPrice(price)}</div>
                <div class="stock">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></div>
              </div>
            </div>
          </div>

          <div style="padding:0 16px 16px">
            <div class="actions">
              <button class="small minus">‚àí</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        `;

        const back = document.createElement('div');
        back.className = 'face back';
        back.innerHTML = `
          <div style="position:relative;padding:12px">
            <button class="eye-toggle" aria-pressed="true" title="Volver" type="button" aria-label="Volver">
              <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5" stroke="#ff6b9d" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 19l-7-7 7-7" stroke="#ff6b9d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="back-image-wrap"></div>
          <div style="padding:12px">
            <div class="desc-box">${escapeHtml(description || 'Sin descripci√≥n disponible')}</div>
          </div>

          <div style="height:12px"></div>
        `;

        inner.appendChild(front);
        inner.appendChild(back);
        cardWrap.appendChild(inner);
        grid.appendChild(cardWrap);

        // populate front circle with emojiIcon (if it's not a URL)
        const frontImageWrap = front.querySelector('.front-image');
        if (emojiIcon && typeof emojiIcon === 'string' && !/^(https?:)?\/\//i.test(emojiIcon)) {
          const span = document.createElement('div');
          span.style.fontSize = '52px';
          span.style.lineHeight = '1';
          span.innerText = emojiIcon;
          frontImageWrap.appendChild(span);
        } else if (emojiIcon && typeof emojiIcon === 'string') {
          const smallImg = makeImgEl(emojiIcon, name, 'product-img');
          frontImageWrap.appendChild(smallImg);
        }

        // back image: only from imgUrl
        const backImageWrap = back.querySelector('.back-image-wrap');
        if (imgUrl && typeof imgUrl === 'string' && /^(https?:)?\/\//i.test(imgUrl)) {
          const imgLarge = makeImgEl(imgUrl, name, 'back-image');
          imgLarge.addEventListener('click', (e)=>{ e.stopPropagation(); openImageModal(imgUrl, name); });
          backImageWrap.appendChild(imgLarge);
        } else {
          backImageWrap.innerHTML = `<div style="padding:30px;color:#bbb;font-size:3rem">üñºÔ∏è</div>`;
        }

        // toggles (only click)
        const eyeFront = front.querySelector('.eye-toggle');
        const eyeBack = back.querySelector('.eye-toggle');

        function showBack(){ inner.classList.add('flipped'); }
        function showFront(){ inner.classList.remove('flipped'); }

        eyeFront.addEventListener('click', (e)=>{ e.stopPropagation(); showBack(); });
        eyeBack.addEventListener('click', (e)=>{ e.stopPropagation(); showFront(); });

        // close back if click outside content area inside the card
        cardWrap.addEventListener('click', (ev) => {
          if (inner.classList.contains('flipped')) {
            const targetIsInsideBack = back.contains(ev.target);
            if (!targetIsInsideBack) showFront();
          }
        });

        // quantity controls
        const minusBtns = cardWrap.querySelectorAll('.minus');
        const plusBtns = cardWrap.querySelectorAll('.plus');
        const qtySpans = cardWrap.querySelectorAll('.qty');
        minusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const current = Number(qtySpans[0].innerText || '1');
          if(current > 1){ qtySpans.forEach(s=>s.innerText = current - 1); }
        }));
        plusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const orig = getOriginalStock(cardWrap.dataset.sheetKey, cardWrap.dataset.row);
          const current = Number(qtySpans[0].innerText || '1');
          if(current < Math.max(0, orig - getReservedQty(cardWrap.dataset.sheetKey, cardWrap.dataset.row))){
            qtySpans.forEach(s=>s.innerText = current + 1);
          }
        }));

        // order buttons (only front)
        const orderBtns = cardWrap.querySelectorAll('.order');
        orderBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const qty = Number(cardWrap.querySelector('.qty').innerText || '1');
          addToCart(cardWrap, qty);
        }));

        showFront();
      });

      if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
    }

    /* load categories / tabs (usa worker tal cual) */
    async function loadCategories(){
      try {
        const r = await fetch(API_URL, {cache:'no-store'});
        const data = await r.json();
        if (!data.sheets) throw new Error("Respuesta inv√°lida");
        // data.sheets = [{ key, sheetName }]
        availableSheetKeys = (data.sheets || []).map(s => s.key).filter(Boolean);
        renderTabs(data.sheets);
      } catch(err){
        if(tabsEl) tabsEl.innerHTML = 'Error cargando categor√≠as';
        console.error(err);
      }
    }

    function renderTabs(sheets){
      if(!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.className = 'tab active';
      allBtn.innerText = "‚ú® Todos";
      allBtn.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        allBtn.classList.add('active');
        loadProductsAll();
      };
      tabsEl.appendChild(allBtn);

      sheets.forEach((s)=>{
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.innerText = s.key;
        btn.dataset.key = s.key;
        btn.onclick = ()=> {
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          loadProductsFor(s.key);
        };
        tabsEl.appendChild(btn);
      });

      loadProductsAll();
    }

    async function loadProductsFor(sheetKey){
      lastLoadedSheetKey = sheetKey;
      if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando productos</div>';
      try {
        const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = (data.products || []).map(p=> {
          if(!p.sheetKey) p.sheetKey = sheetKey;
          return p;
        });
        lastProductsCache = products;
        renderProducts(products, sheetKey);
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='<div class="loading">Error cargando productos</div>'; }
    }

    /**
     * loadProductsAll:
     * - pide all=1
     * - detecta categor√≠as (Categoria) de cada producto y hace peticiones por categor√≠a para obtener filas completas
     * - mergea por clave composta: `${categoria}::${row}` ‚Äî evita colisiones de row entre hojas
     */
    async function loadProductsAll(){
      lastLoadedSheetKey = "ALL";
      if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando todos los productos</div>';
      try {
        const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        let products = data.products || [];

        // Asegurar que cada product tenga data.Categoria consistente
        products.forEach(p=>{
          p.data = p.data || {};
          if(!p.data.Categoria) p.data.Categoria = p.data.Categoria || p.data.categoria || p.data.Categoria || 'UNKNOWN';
        });

        // detectar categor√≠as presentes en "all"
        const cats = [...new Set(products.map(p => (p.data && (p.data.Categoria || p.data.categoria)) ).filter(Boolean))];

        // pedir detalle por categor√≠a (sheetKey) para obtener filas completas
        const detailsPromises = cats.map(cat => fetch(API_URL+'?sheetKey='+encodeURIComponent(cat), {cache:'no-store'})
          .then(res=>res.json().catch(()=>({products:[]})))
          .then(json => ({ cat, products: json.products || [] }))
          .catch(()=>({cat, products:[]}))
        );

        const details = await Promise.all(detailsPromises);

        // construir mapa por clave compuesta cat::row para lookup preciso
        const detailMap = {}; // key: `${cat}::${row}` -> data
        details.forEach(obj=>{
          const cat = obj.cat;
          (obj.products || []).forEach(pp=>{
            const key = `${cat}::${String(pp.row)}`;
            detailMap[key] = pp.data || pp;
            // tambi√©n aseguramos que pp.sheetKey est√© presente
            if(!pp.sheetKey) pp.sheetKey = cat;
          });
        });

        // Merge: por cada producto en "all", buscamos detalle por categoria+row y mezclamos sin sobreescribir
        products = products.map(p=>{
          const d = p.data || {};
          const cat = d.Categoria || d.categoria || 'UNKNOWN';
          const key = `${cat}::${String(p.row)}`;
          const det = detailMap[key];
          if(det){
            // mezclar campos √∫tiles si faltan
            if(!d.descripcion && (det.descripcion || det.Descripcion || det.description)) d.descripcion = firstKeyValue(det, ['descripcion','Descripcion','description','desc','nota','Nota']);
            if(!d.Icono && (det.Icono || det.icono || det.icon)) d.Icono = det.Icono || det.icono || det.icon;
            if(!d.Img && (det.Img || det.img || det.imagen || det.image)) d.Img = det.Img || det.img || det.imagen || det.image;
            if(!d.Categoria && det.Categoria) d.Categoria = det.Categoria;
          }
          // asegurar sheetKey expl√≠cito para evitar ambig√ºedad
          p.sheetKey = p.sheetKey || d.Categoria || cat;
          p.data = d;
          return p;
        });

        // Guardar cache con sheetKey claro (clave compuesta)
        lastProductsCache = products.map(p => {
          return {
            row: p.row,
            sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || 'UNKNOWN').toString(),
            data: p.data || {}
          };
        });

        // Renderizar (cada card tendr√° dataset.sheetKey con la categoria/hoja)
        renderProducts(lastProductsCache.map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey })), "ALL");
      } catch(err){
        console.error(err);
        if(contentEl) contentEl.innerHTML = '<div class="loading">Error cargando productos</div>';
      }
    }

    // init
    loadCategories();
    updateCartUI();
  </script>
</body>
</html>
