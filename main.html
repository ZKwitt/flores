<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KukoroShop ‚Äî Catalogo</title>
  <style>
    /* (mantuve tu CSS - recortado aqu√≠ por brevedad en la respuesta, usa el CSS que ya tienes) */
    /* Copia exactamente el CSS que ten√≠as; en este bloque asumo que lo pegaste arriba. */
  </style>
</head>
<body>
  <!-- --- HEADER / NAV (igual que antes) --- -->
  <header> ... </header>

  <div class="container">
    <!-- search + carousel same as before -->
    <div class="search-container">
      <input id="searchInput" class="search-bar" type="text" placeholder="üîç Buscar c√≥mics...">
      <button class="search-btn" onclick="searchProducts()" aria-label="Buscar"></button>
    </div>

    <section class="carousel-section">
      <h2 class="carousel-title">Destacados</h2>
      <div class="carousel-container">
        <button class="carousel-btn prev" onclick="moveCarousel(-1)">‚Äπ</button>
        <div class="carousel" id="carouselInner">
          <!-- items ser√°n inyectados desde JS -->
        </div>
        <button class="carousel-btn next" onclick="moveCarousel(1)">‚Ä∫</button>
      </div>
      <div id="carouselDots" class="carousel-dots"></div>
    </section>

    <section id="productos" class="products-section">
      <h2 class="section-title">üåü Cat√°logo</h2>
      <div id="tabsRow" class="tabs-row"></div>
      <div id="productsGrid" class="products-grid">
        <div id="loadingMessage" style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando productos...</div>
      </div>
    </section>

    <div class="load-more">
      <button class="load-more-btn" onclick="loadMore()">Ver m√°s <span class="arrow-down">‚Üì</span></button>
    </div>
  </div>

  <footer> ... </footer>

  <!-- CART POPUP -->
  <div id="cart-popup-overlay" aria-hidden="true">
    <div id="cart-popup" role="dialog" aria-modal="true" aria-label="Carrito de compras">
      <h3 style="margin-bottom:8px">üõí Tu carrito</h3>
      <div id="cart-items-container"><p style="color:#999;text-align:center">Carrito vac√≠o</p></div>
      <div id="cart-total"></div>
      <div id="cart-actions">
        <button id="cart-close" class="btn-small btn-ghost">Cerrar</button>
        <button id="cart-confirm" class="btn-small btn-primary">Enviar por WhatsApp</button>
        <button id="cart-pay-card" class="btn-small btn-primary" style="background: linear-gradient(135deg,#1a73e8,#2b8ef6)">Pagar con tarjeta</button>
      </div>
    </div>
  </div>

  <!-- IMAGE MODAL -->
  <div id="img-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:20000;">
    <div style="max-width:90vw; max-height:90vh; padding:12px;">
      <img id="img-modal-img" src="" alt="" style="max-width:100%; max-height:90vh; border-radius:8px; display:block;" />
      <div style="text-align:center;margin-top:8px;">
        <button id="img-modal-close" class="btn-small btn-ghost">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- PAYMENT MODAL (SIMULADO) -->
  <div id="payment-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:30000;">
    <div style="width:420px; max-width:95%; background:#0f0f12; padding:18px; border-radius:10px; color:#fff; border:1px solid rgba(255,255,255,0.04);">
      <h3 style="margin:0 0 8px 0;">Pago con tarjeta (simulado)</h3>
      <p style="color:#bbb;font-size:0.9rem;margin:0 0 12px 0;">
        Este pago es una **simulaci√≥n** para pruebas UI. No env√≠es datos reales aqu√≠. Para pagos reales integra Stripe/PayU/PG.
      </p>
      <form id="payment-form" autocomplete="off">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="pay-name" placeholder="Nombre completo" required style="flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="pay-email" placeholder="Email" type="email" required style="flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="pay-phone" placeholder="Tel√©fono" required style="flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>
        <div style="margin-bottom:8px">
          <input id="pay-address" placeholder="Direcci√≥n (Calle, ciudad, postal)" required style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin:8px 0" />

        <div style="margin-bottom:8px">
          <input id="card-number" placeholder="N√∫mero de tarjeta (simulado)" maxlength="19" required style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="card-exp" placeholder="MM/AA" maxlength="5" required style="flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
          <input id="card-cvv" placeholder="CVV" maxlength="4" required style="width:100px;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#0b0b0b;color:#fff" />
        </div>

        <div id="payment-feedback" style="min-height:24px;color:#f88;margin-bottom:8px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" id="payment-cancel" class="btn-small btn-ghost">Cancelar</button>
          <button type="submit" id="payment-submit" class="btn-small btn-primary">Pagar (simulado)</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ---------- CONFIG: reemplaza por tu endpoint ---------- */
const API_URL = "https://a.thepersonmrt.workers.dev/"; // <-- cambia por tu worker

/* ---------- Estado ---------- */
const tabsRow = document.getElementById('tabsRow');
const productsGrid = document.getElementById('productsGrid');
const carouselInner = document.getElementById('carouselInner');
const carouselDots = document.getElementById('carouselDots');
let carouselItems = [];
let currentSlide = 0;

let lastProductsCache = [];
let availableSheetKeys = [];
let lastLoadedSheetKey = null;

/* ---------- carrito (igual) ---------- */
const WHATSAPP_NUMBER = '573207378992';
let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');
const cartIconBtn = document.getElementById('cart-icon-btn') || document.querySelector('#cart-icon-btn') || document.querySelector('.cart-icon');
const cartPopupOverlay = document.getElementById('cart-popup-overlay');
const cartItemsContainer = document.getElementById('cart-items-container');
const cartTotalEl = document.getElementById('cart-total');
const cartCloseBtn = document.getElementById('cart-close');
const cartConfirmBtn = document.getElementById('cart-confirm');
const cartPayCardBtn = document.getElementById('cart-pay-card');

function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

/* ---------- utilidades ---------- */
function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function parsePriceNumber(v){
  if (v === undefined || v === null) return 0;
  if (typeof v === 'number' && !isNaN(v)) return v;
  let s = String(v).trim();
  if (s === '') return 0;
  s = s.replace(/\s+/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  s = s.replace(/[^0-9.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtPrice(v){
  if (v===undefined || v===null) return '-';
  const s = String(v).trim();
  if (s === '') return '-';
  const n = parsePriceNumber(s);
  return Number(n).toLocaleString('de-DE');
}
function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ---------- lazy observer ---------- */
const lazyObserver = (function(){
  if (typeof IntersectionObserver === 'undefined') return null;
  return new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const img = entry.target;
      const src = img.dataset && img.dataset.src;
      if (src) {
        img.src = src;
        delete img.dataset.src;
      }
      obs.unobserve(img);
    });
  }, {
    rootMargin: '400px 0px',
    threshold: 0.01
  });
})();
function observeLazyImages(rootEl) {
  if (!lazyObserver) return;
  const imgs = (rootEl || document).querySelectorAll('img[data-src]');
  imgs.forEach(img => { if (document.contains(img)) lazyObserver.observe(img); });
}

/* ---------- makeImgEl ahora carga la imagen inmediatamente (loading=lazy) ---------- */
function makeImgEl(raw, alt, className){
  const img = document.createElement('img');
  img.alt = alt || '';
  img.className = className || '';
  img.loading = 'lazy';
  try {
    const proxied = raw ? (API_URL + 'image-proxy?url=' + encodeURIComponent(raw)) : '';
    // asignamos src directo para que sea visible; mantenemos dataset.src si prefieres lazy via observer
    img.src = proxied || '';
    // fallback: si quisieras usar lazy observer, comenta la l√≠nea anterior y usa:
    // img.dataset.src = proxied;
  } catch(e) {
    img.src = '';
  }
  img.onerror = () => {
    // fallback gr√°fico
    const box = document.createElement('div');
    box.style.width = '100%';
    box.style.height = '100%';
    box.style.display = 'flex';
    box.style.alignItems = 'center';
    box.style.justifyContent = 'center';
    box.style.color = '#888';
    box.style.fontSize = '2rem';
    box.innerText = 'üñºÔ∏è';
    img.replaceWith(box);
  };
  return img;
}

/* ---------- STOCK sync helpers (igual que ten√≠as) ---------- */
function mapToAvailableSheetKey(input){
  if(!input) return null;
  const s = String(input).trim();
  if(availableSheetKeys && availableSheetKeys.length){
    const found = availableSheetKeys.find(k => String(k).toLowerCase() === s.toLowerCase());
    if(found) return found;
  }
  return s || null;
}
async function fetchServerStock(sheetKeyRaw, row){
  try {
    const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
    if(!mappedKey) return null;
    const resp = await fetch(API_URL + '?sheetKey=' + encodeURIComponent(mappedKey), { cache: 'no-store' });
    if(!resp.ok) return null;
    const json = await resp.json().catch(()=>null);
    if(!json || !Array.isArray(json.products)) return null;
    const found = json.products.find(p => String(p.row) === String(row));
    if(!found) return null;
    const stockVal = firstKeyValue(found.data || {}, ['stock','cantidad','Stock']) || found.data && (found.data.Stock || found.data.cantidad) || 0;
    return Number(stockVal || 0);
  } catch (err) {
    console.warn('fetchServerStock error', err);
    return null;
  }
}
async function updateStockOnServer_decrement(sheetKeyRaw, row, qty){
  if(!qty || qty <= 0) return;
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw);
  if(!mappedKey){ console.warn('sheetKey no reconocido', sheetKeyRaw); return; }
  for(let i=0;i<qty;i++){
    try {
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row) })
      });
      const text = await resp.text().catch(()=>null);
      let json = null;
      try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }
      if(resp.ok && json && !json.error){
        const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : undefined;
        if(confirmedStock !== undefined){
          const reservedLocal = getReservedQty(mappedKey, row);
          document.querySelectorAll('.product-card').forEach(card=>{
            const csk = (card.dataset.sheetKey||'').toString().trim().toLowerCase();
            const rw = card.dataset.row;
            if(String(rw) === String(row) && (csk.toLowerCase() === mappedKey.toLowerCase() || csk.toLowerCase() === sheetKeyRaw.toString().trim().toLowerCase())){
              card.dataset.origStock = String(Math.max(0, confirmedStock + reservedLocal));
            }
          });
          refreshCardStockDisplay(mappedKey, row);
        }
      } else {
        console.warn('Decrement fallo o respuesta inesperada:', resp.status, text);
        break;
      }
    } catch (err){
      console.warn('Decrement petici√≥n fall√≥:', err);
      break;
    }
  }
}
async function updateStockOnServer_set(sheetKeyRaw, row, newStock){
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'set', sheetKey: mappedKey, row: String(row), value: String(newStock) })
    });
    const text = await resp.text().catch(()=>null);
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch(e){ json = null; }
    if(resp.ok && json && !json.error){
      const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : Number(newStock);
      const reservedLocal = getReservedQty(mappedKey, row);
      document.querySelectorAll('.product-card').forEach(card=>{
        const csk = (card.dataset.sheetKey||'').toString().trim().toLowerCase();
        const rw = card.dataset.row;
        if(String(rw) === String(row) && (csk.toLowerCase() === mappedKey.toLowerCase() || csk.toLowerCase() === sheetKeyRaw.toString().trim().toLowerCase())){
          card.dataset.origStock = String(Math.max(0, confirmedStock + reservedLocal));
        }
      });
      refreshCardStockDisplay(mappedKey, row);
    } else {
      console.warn('updateStockOnServer_set: respuesta no OK', resp.status, text);
    }
  } catch (err) {
    console.warn('updateStockOnServer_set fallo:', err);
  }
}
async function updateStockOnServer_increaseViaSet(sheetKeyRaw, row, delta){
  if(!delta || delta <= 0) return;
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  if(!mappedKey){ console.warn('No sheetKey mapeable', sheetKeyRaw); return; }
  try {
    const serverStock = await fetchServerStock(mappedKey, row);
    const baseStock = (serverStock !== null && serverStock !== undefined) ? Number(serverStock) : Number(getOriginalStock(mappedKey, row) || 0);
    const newStock = Math.max(0, baseStock + Number(delta));
    await updateStockOnServer_set(mappedKey, row, newStock);
  } catch (err){
    console.warn('updateStockOnServer_increaseViaSet error', err);
  }
}

/* ---------- stock UI helpers ---------- */
function findProductInCache(sheetKey, row){
  if(!Array.isArray(lastProductsCache)) return null;
  const targetSk = (sheetKey || '').toString().trim();
  return lastProductsCache.find(pp => {
    const sk = (pp.sheetKey || (pp.data && (pp.data.Categoria || pp.data.categoria)) || '').toString().trim();
    return String(pp.row) === String(row) && sk.toString().trim().toLowerCase() === targetSk.toLowerCase();
  }) || null;
}
function getOriginalStock(sheetKey, row){
  const card = Array.from(document.querySelectorAll('.product-card')).find(c => {
    const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
    const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
    return sk.toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
  });
  if (card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);
  const p = findProductInCache(sheetKey, row);
  if (p){
    const d = p.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0;
    return Number(stock || 0);
  }
  const p2 = (Array.isArray(lastProductsCache) && lastProductsCache.find(pp=>String(pp.row)===String(row))) || null;
  if(p2){
    const d = p2.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || 0;
    return Number(stock || 0);
  }
  return 0;
}
function getReservedQty(sheetKey, row){
  return cart.filter(i => (i.sheetKey||'').toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
}
function refreshCardStockDisplay(sheetKey, row){
  const cards = Array.from(document.querySelectorAll('.product-card')).filter(c => {
    const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString().trim().toLowerCase();
    const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
    return sk === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
  });
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey, row);
  const avail = Math.max(0, origStock - reserved);
  cards.forEach(card => {
    const stockSpan = card.querySelector('.stockval');
    if(stockSpan) stockSpan.innerText = avail;
    const orderBtn = card.querySelector('.product-btn');
    if(avail <= 0){
      card.classList.add('out');
      card.style.opacity = '0.45';
      if(orderBtn) orderBtn.disabled = true;
    } else {
      card.classList.remove('out');
      card.style.opacity = '';
      if(orderBtn) orderBtn.disabled = false;
    }
  });
}
function updateCartUI(){
  const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  const cartTextBtn = document.querySelector('#cart-icon-btn') || document.querySelector('.cart-icon');
  if(cartTextBtn) cartTextBtn.innerText = `Carrito (${count})`;
  saveCart();
}

/* ---------- add/remove cart ---------- */
async function addToCartFromCard(card, qty){
  const sheetKey = (card && card.dataset.sheetKey) || lastLoadedSheetKey || 'UNKNOWN';
  const row = card && card.dataset.row;
  const name = card?.querySelector('.product-title')?.innerText || 'Sin nombre';
  const priceRaw = card?.dataset.price !== undefined ? card.dataset.price : (card?.querySelector('.product-price')?.innerText || '');
  const priceNum = parsePriceNumber(priceRaw);
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey,row);
  const available = Math.max(0, origStock - reserved);
  if(qty > available){ alert('No hay suficiente stock disponible.'); return; }
  const key = `${sheetKey}::${row}`;
  const existing = cart.find(i=>cartItemKey(i) === key);
  if(existing){ existing.qty = Math.min(origStock, existing.qty + qty); }
  else { cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty }); }
  refreshCardStockDisplay(sheetKey,row);
  updateCartUI();
  // decrementar en servidor (as√≠ncrono)
  updateStockOnServer_decrement(sheetKey, row, qty).catch(e=>console.warn('updateStockOnServer_decrement error', e));
  cartIconBtn.style.transform = 'scale(1.12)';
  setTimeout(()=> cartIconBtn.style.transform = '', 200);
}
function removeFromCart(idx){
  if(idx >= 0 && idx < cart.length){
    const item = cart[idx];
    const sheetKey = item.sheetKey;
    const row = item.row;
    const removedQty = Number(item.qty || 0);
    cart.splice(idx, 1);
    refreshCardStockDisplay(sheetKey, row);
    updateCartUI();
    openCartPopup();
    updateStockOnServer_increaseViaSet(sheetKey, row, removedQty).catch(e=>console.warn('increaseViaSet error', e));
  }
}

/* ---------- WhatsApp order (igual) ---------- */
function sendToWhatsApp(){
  if(cart.length === 0){ alert('El carrito est√° vac√≠o'); return; }
  let message = '*Nuevo Pedido - KukoroShop*\n\n';
  let total = 0;
  cart.forEach(item => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    total += itemTotal;
    message += `*${item.name}*\n   Cantidad: ${item.qty}\n   Precio: ${Number(itemTotal).toLocaleString('de-DE')}\n\n`;
  });
  message += `*TOTAL: ${Number(total).toLocaleString('de-DE')}*\n\n`;
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
  // Clear cart after sending (si quieres mantenerlo, quita esto)
  cart = [];
  updateCartUI();
  refreshAllCardDisplays();
  closeCartPopup();
}

/* ---------- cart popup ---------- */
function openCartPopup(){
  if(cart.length === 0){
    cartItemsContainer.innerHTML = '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';
    cartTotalEl.innerHTML = '';
    cartPopupOverlay.style.display = 'flex';
    cartPopupOverlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    return;
  }
  let html = '';
  cart.forEach((item, idx) => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    html += `
      <div class="cart-item">
        <div style="flex:1">
          <div style="font-weight:800">${escapeHtml(item.name)}</div>
          <div style="font-size:0.9rem;color:#aaa">x${item.qty} ‚Äî ${Number(itemTotal).toLocaleString('de-DE')}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <button style="background:transparent;border:none;color:#f66;cursor:pointer;font-weight:800" onclick="removeFromCart(${idx})">‚úï</button>
        </div>
      </div>
    `;
  });
  cartItemsContainer.innerHTML = html;
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  cartTotalEl.innerHTML = `üí∞ Total: <span style="color:#9D4EDD">${Number(total).toLocaleString('de-DE')}</span>`;
  cartPopupOverlay.style.display = 'flex';
  cartPopupOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}
function closeCartPopup(){ cartPopupOverlay.style.display = 'none'; cartPopupOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

/* ---------- image modal ---------- */
const imgModalOverlay = document.getElementById('img-modal-overlay');
const imgModalImg = document.getElementById('img-modal-img');
const imgModalClose = document.getElementById('img-modal-close');
function openImageModal(url, alt){
  if(!url) return;
  imgModalImg.src = url;
  imgModalImg.alt = alt || '';
  imgModalOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeImageModal(){ imgModalOverlay.style.display = 'none'; imgModalImg.src = ''; document.body.style.overflow = ''; }
imgModalClose.addEventListener('click', closeImageModal);
imgModalOverlay.addEventListener('click', (e)=>{ if(e.target === imgModalOverlay) closeImageModal(); });

/* ---------- render productos y tarjetas (modificado para insertar imagenes) ---------- */
function renderProducts(products, sheetKey){
  if (!products || !products.length){
    productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">No hay productos</div>';
    return;
  }
  lastProductsCache = (products || []).map(p => ({ row: p.row, sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || sheetKey || 'UNKNOWN').toString(), data: p.data || {} }));
  productsGrid.innerHTML = '';
  const frag = document.createDocumentFragment();
  products.forEach((p) => {
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || d.Nombre || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','Precio']) || d.Precio || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0);
    const imgUrl = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';
    const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota','Nota']) || d.descripcion || '';
    const productSheetKey = (p.sheetKey || d.Categoria || sheetKey || 'UNKNOWN').toString();
    const card = document.createElement('div');
    card.className = 'product-card';
    card.dataset.origStock = String(stock);
    card.dataset.price = price;
    card.dataset.row = String(p.row);
    card.dataset.sheetKey = String(productSheetKey);
    // image area
    const topWrap = document.createElement('div');
    topWrap.style.minHeight = '380px';
    topWrap.style.display = 'flex';
    topWrap.style.alignItems = 'center';
    topWrap.style.justifyContent = 'center';
    topWrap.style.background = '#0f0f0f';
    topWrap.style.position = 'relative';
    if (imgUrl && /^https?:\/\//i.test(imgUrl)){
      const imgEl = makeImgEl(imgUrl, name, 'product-image');
      imgEl.style.maxHeight = '380px';
      imgEl.style.width = 'auto';
      imgEl.style.cursor = 'zoom-in';
      imgEl.addEventListener('click', ()=> openImageModal(imgUrl, name));
      topWrap.appendChild(imgEl);
      // also observe if needed
      observeLazyImages(topWrap);
    } else {
      const ph = document.createElement('div');
      ph.style.width = '100%';
      ph.style.height = '100%';
      ph.style.display = 'flex';
      ph.style.alignItems = 'center';
      ph.style.justifyContent = 'center';
      ph.style.color = '#888';
      ph.style.fontSize = '2rem';
      ph.innerText = 'üñºÔ∏è';
      topWrap.appendChild(ph);
    }
    const info = document.createElement('div');
    info.className = 'product-info';
    info.innerHTML = `
      <div class="product-title">${escapeHtml(name)}</div>
      <div><span class="product-price">${price ? ('$ ' + fmtPrice(price)) : '-'}</span></div>
      <div style="margin-top:8px"><span class="stock-badge">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></span></div>
      <div style="margin-top:10px;color:#bbb;font-size:0.95rem;max-height:60px;overflow:hidden">${escapeHtml(String(description || 'Sin descripci√≥n'))}</div>
      <div class="product-actions" style="margin-top:12px">
        <button class="qty-btn minus">‚àí</button>
        <div class="qty-display">1</div>
        <button class="qty-btn plus">+</button>
        <button class="product-btn">Agregar</button>
      </div>
    `;
    card.appendChild(topWrap);
    card.appendChild(info);
    frag.appendChild(card);
  });
  productsGrid.appendChild(frag);

  if (!productsGrid._hasDelegation) {
    productsGrid.addEventListener('click', function(e){
      const plus = e.target.closest('.plus');
      if (plus) {
        e.preventDefault();
        const card = plus.closest('.product-card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty-display');
        const current = Number(qtySpan?.innerText || '1');
        const orig = getOriginalStock(card.dataset.sheetKey, card.dataset.row);
        if (current < Math.max(0, orig - getReservedQty(card.dataset.sheetKey, card.dataset.row))){
          qtySpan.innerText = current + 1;
        }
        return;
      }
      const minus = e.target.closest('.minus');
      if (minus) {
        e.preventDefault();
        const card = minus.closest('.product-card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty-display');
        const current = Number(qtySpan?.innerText || '1');
        if (current > 1) qtySpan.innerText = current - 1;
        return;
      }
      const orderBtn = e.target.closest('.product-btn');
      if (orderBtn) {
        e.preventDefault();
        const card = orderBtn.closest('.product-card');
        if (!card) return;
        const qty = Number(card.querySelector('.qty-display')?.innerText || '1');
        addToCartFromCard(card, qty);
        return;
      }
    });
    productsGrid._hasDelegation = true;
  }
}

/* ---------- carousel: construir a partir de productos ---------- */
function populateCarouselFromProducts(allProducts){
  // elegir hasta 4 productos con imagen v√°lida (preferibles que tengan img)
  const withImg = (allProducts || []).filter(p => {
    const d = p.data || {};
    const img = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';
    return img && /^https?:\/\//i.test(img);
  });
  const chosen = withImg.slice(0, 4);
  // si menos de 4, completar con otros productos
  if (chosen.length < 4){
    const missing = 4 - chosen.length;
    const rest = (allProducts || []).filter(p => chosen.indexOf(p) === -1).slice(0, missing);
    chosen.push(...rest);
  }
  carouselItems = chosen.map(p => {
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || d.Nombre || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','Precio']) || d.Precio || '';
    const img = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';
    return { name, price, img, sheetKey: p.sheetKey, row: p.row };
  });

  // render carouselInner
  carouselInner.innerHTML = '';
  carouselItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'carousel-item';
    const img = document.createElement('img');
    if (item.img && /^https?:\/\//i.test(item.img)){
      img.src = API_URL + 'image-proxy?url=' + encodeURIComponent(item.img);
      img.alt = item.name;
    } else {
      img.src = '';
      img.alt = '';
    }
    const caption = document.createElement('div');
    caption.className = 'carousel-caption';
    caption.innerHTML = `<h3>${escapeHtml(item.name)}</h3><p>${item.price ? ('$ '+fmtPrice(item.price)) : '-'}</p>`;
    div.appendChild(img);
    div.appendChild(caption);
    carouselInner.appendChild(div);
  });

  initCarouselDots();
  updateCarousel();
}

/* ---------- carousel controls ---------- */
function initCarouselDots(){
  const total = carouselItems.length || 1;
  carouselDots.innerHTML = '';
  for(let i=0;i<total;i++){
    const dot = document.createElement('div');
    dot.className='dot';
    if(i===0) dot.classList.add('active');
    dot.onclick = ()=>{ currentSlide = i; updateCarousel(); };
    carouselDots.appendChild(dot);
  }
}
function moveCarousel(direction){
  const total = Math.max(carouselItems.length, 1);
  currentSlide += direction;
  if(currentSlide < 0) currentSlide = total - 1;
  if(currentSlide >= total) currentSlide = 0;
  updateCarousel();
}
function updateCarousel(){
  const carousel = carouselInner;
  carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
  const dots = document.querySelectorAll('.dot');
  dots.forEach((dot, idx)=> dot.classList.toggle('active', idx === currentSlide));
}
setInterval(()=> moveCarousel(1), 5000);

/* ---------- categories & carga ---------- */
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida: espera { sheets: [] }");
    availableSheetKeys = (data.sheets || []).map(s => s.key).filter(Boolean);
    renderTabs(data.sheets);
  } catch(err){
    tabsRow.innerHTML = '<div style="color:#f88">Error cargando categor√≠as</div>';
    console.error(err);
  }
}
function renderTabs(sheets){
  tabsRow.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "‚ú® Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsRow.appendChild(allBtn);

  sheets.forEach((s) => {
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsRow.appendChild(btn);
  });

  loadProductsAll();
}

async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando productos...</div>';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error: '+escapeHtml(data.message||'')+'</div>'; return; }
    const products = (data.products || []).map(p=> { if(!p.sheetKey) p.sheetKey = sheetKey; return p; });
    lastProductsCache = products;
    renderProducts(products, sheetKey);
    // actualizar carousel con estos productos (si prefieres que el carrusel cambie por categoria)
    populateCarouselFromProducts(products);
  } catch(err){ console.error(err); productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error cargando productos</div>'; }
}

async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  productsGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando todos los productos...</div>';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ productsGrid.innerHTML='<div style="text-align:center;color:#f88">Error: '+escapeHtml(data.message||'')+'</div>'; return; }
    let products = data.products || [];
    products.forEach(p=>{ p.data = p.data || {}; if(!p.data.Categoria) p.data.Categoria = p.data.Categoria || p.data.categoria || 'UNKNOWN'; });

    // opcional: pedir detalles por categoria (igual que antes)
    const cats = [...new Set(products.map(p => (p.data && (p.data.Categoria || p.data.categoria)) ).filter(Boolean))];
    const detailsPromises = cats.map(cat => fetch(API_URL+'?sheetKey='+encodeURIComponent(cat), {cache:'no-store'})
      .then(res=>res.json().catch(()=>({products:[]})))
      .then(json => ({ cat, products: json.products || [] }))
      .catch(()=>({cat, products:[]}))
    );
    const details = await Promise.all(detailsPromises);
    const detailMap = {};
    details.forEach(obj=>{
      const cat = obj.cat;
      (obj.products || []).forEach(pp=>{
        const key = `${cat}::${String(pp.row)}`;
        detailMap[key] = pp.data || pp;
        if(!pp.sheetKey) pp.sheetKey = cat;
      });
    });
    products = products.map(p=>{
      const d = p.data || {};
      const cat = d.Categoria || d.categoria || 'UNKNOWN';
      const key = `${cat}::${String(p.row)}`;
      const det = detailMap[key];
      if(det){
        if(!d.descripcion && (det.descripcion || det.Descripcion || det.description)) d.descripcion = firstKeyValue(det, ['descripcion','Descripcion','description','desc','nota','Nota']);
        if(!d.Icono && (det.Icono || det.icono || det.icon)) d.Icono = det.Icono || det.icono || det.icon;
        if(!d.Img && (det.Img || det.img || det.imagen || det.image)) d.Img = det.Img || det.img || det.imagen || det.image;
        if(!d.Categoria && det.Categoria) d.Categoria = det.Categoria;
      }
      p.sheetKey = p.sheetKey || d.Categoria || cat;
      p.data = d;
      return p;
    });

    lastProductsCache = products.map(p => ({ row: p.row, sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || 'UNKNOWN').toString(), data: p.data || {} }));
    renderProducts(lastProductsCache.map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey })), "ALL");

    // important: populate main carousel from all products (this is what you asked)
    populateCarouselFromProducts(lastProductsCache.map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey })));
  } catch(err){
    console.error(err);
    productsGrid.innerHTML = '<div style="text-align:center;color:#f88">Error cargando productos</div>';
  }
}

/* ---------- search ---------- */
function searchProducts(){
  const searchTerm = document.getElementById('searchInput').value;
  if(!searchTerm.trim()){ loadProductsAll(); return; }
  const q = searchTerm.trim().toLowerCase();
  const found = lastProductsCache.filter(p => {
    const d = p.data || {};
    return (String(firstKeyValue(d, ['name','nombre','producto','Nombre']) || '').toLowerCase().includes(q) ||
            String(firstKeyValue(d, ['descripcion','Descripcion','description']) || '').toLowerCase().includes(q));
  }).map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey }));
  renderProducts(found, lastLoadedSheetKey || 'ALL');
}

/* ---------- helpers ------- */
function refreshAllCardDisplays(){
  document.querySelectorAll('.product-card').forEach(card => {
    refreshCardStockDisplay(card.dataset.sheetKey, card.dataset.row);
  });
}

/* ---------- CART UI wiring ---------- */
document.querySelectorAll('.cart-icon, #cart-icon-btn').forEach(btn=>{
  btn && btn.addEventListener('click', openCartPopup);
});
cartCloseBtn && cartCloseBtn.addEventListener('click', closeCartPopup);
cartConfirmBtn && cartConfirmBtn.addEventListener('click', sendToWhatsApp);
cartPayCardBtn && cartPayCardBtn.addEventListener('click', openPaymentModal);

/* ---------- PAYMENT MODAL (simulaci√≥n) ---------- */
const paymentModal = document.getElementById('payment-modal-overlay');
const paymentForm = document.getElementById('payment-form');
const paymentFeedback = document.getElementById('payment-feedback');
const paymentCancel = document.getElementById('payment-cancel');

function openPaymentModal(){
  if(cart.length === 0){ alert('El carrito est√° vac√≠o'); return; }
  paymentModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  paymentFeedback.innerText = '';
}
function closePaymentModal(){ paymentModal.style.display = 'none'; document.body.style.overflow = ''; paymentForm.reset(); paymentFeedback.innerText = ''; }

paymentCancel.addEventListener('click', closePaymentModal);

function luhnCheck(cardNumber){
  const s = cardNumber.replace(/\D/g,'');
  let sum = 0;
  let toggle = false;
  for (let i = s.length - 1; i >= 0; i--){
    let d = parseInt(s.charAt(i), 10);
    if (toggle){ d = d * 2; if (d > 9) d -= 9; }
    sum += d;
    toggle = !toggle;
  }
  return (sum % 10) === 0;
}

function maskCardNumber(n){
  const s = n.replace(/\s+/g,'').replace(/.(?=.{4})/g, '*');
  // pretty print groups of 4
  return s.replace(/(.{4})/g,'$1 ').trim();
}

paymentForm.addEventListener('submit', async function(e){
  e.preventDefault();
  paymentFeedback.style.color = '#f88';
  paymentFeedback.innerText = '';
  const name = document.getElementById('pay-name').value.trim();
  const email = document.getElementById('pay-email').value.trim();
  const phone = document.getElementById('pay-phone').value.trim();
  const address = document.getElementById('pay-address').value.trim();
  const cardNumber = document.getElementById('card-number').value.trim();
  const cardExp = document.getElementById('card-exp').value.trim();
  const cardCvv = document.getElementById('card-cvv').value.trim();

  if(!name || !email || !phone || !address){ paymentFeedback.innerText = 'Completa tus datos personales.'; return; }
  if(!cardNumber || !cardExp || !cardCvv){ paymentFeedback.innerText = 'Completa los datos de la tarjeta.'; return; }
  if(!/^\d{2}\/\d{2}$/.test(cardExp)){ paymentFeedback.innerText = 'Formato de expiraci√≥n inv√°lido (MM/AA).'; return; }
  // expiry check (simple)
  const [mm, yy] = cardExp.split('/').map(x=>parseInt(x,10));
  if(mm < 1 || mm > 12){ paymentFeedback.innerText = 'Mes inv√°lido.'; return; }
  const now = new Date();
  const expYear = 2000 + yy;
  const expDate = new Date(expYear, mm);
  if(expDate <= now){ paymentFeedback.innerText = 'La tarjeta est√° vencida.'; return; }
  if(!/^\d{3,4}$/.test(cardCvv)){ paymentFeedback.innerText = 'CVV inv√°lido.'; return; }
  // Luhn check for demo - only if numeric length >= 12
  const digits = cardNumber.replace(/\D/g,'');
  if(digits.length >= 12 && !luhnCheck(digits)){ paymentFeedback.innerText = 'N√∫mero de tarjeta inv√°lido (Luhn).'; return; }

  // Simulaci√≥n de procesamiento
  paymentFeedback.style.color = '#ddd';
  paymentFeedback.innerText = 'Procesando pago (simulado)‚Ä¶';
  document.getElementById('payment-submit').disabled = true;

  // Simular delay
  await new Promise(r => setTimeout(r, 2000));

  // Simular resultado exitoso
  const transactionId = 'TX-' + Math.random().toString(36).slice(2, 10).toUpperCase();
  paymentFeedback.style.color = '#8f8';
  paymentFeedback.innerHTML = `Pago simulado aprobado ‚Äî ID: <strong>${transactionId}</strong><br>Tarjeta: ${escapeHtml(maskCardNumber(digits))}`;

  // Aqu√≠: normalmente enviar√≠as el pedido y confirmar con el backend / pasarela.
  // Para la simulaci√≥n, vaciamos el carrito y actualizamos UI (solo cliente).
  cart = [];
  saveCart();
  updateCartUI();
  refreshAllCardDisplays();

  // Cerrar modal despu√©s de unos segundos
  setTimeout(()=>{ closePaymentModal(); closeCartPopup(); alert('Pago simulado realizado. Gracias.'); }, 1100);
});

/* ---------- boot ---------- */
(function boot(){
  updateCartUI();
  loadCategories();
})();
</script>
</body>
</html>
