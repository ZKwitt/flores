<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda din√°mica (Sheets)</title>
  <style>
    body{font-family:system-ui,Arial;padding:18px;max-width:1100px;margin:0 auto}
    header{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;border:1px solid #ddd;cursor:pointer;background:white}
    .tab.active{background:#111;color:white}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:8px}
    .icon{font-size:26px}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .stock{font-weight:600}
    .disabled{opacity:.5;pointer-events:none}
    #debug{background:#f5f5f5;padding:8px;border-radius:6px;white-space:pre-wrap; margin-top:12px;}
  </style>
</head>
<body>
  <h1>Tienda</h1>
  <div id="tabs">Cargando categor√≠as...</div>
  <div style="margin-top:12px;">
    <button id="refresh">Refrescar actual</button>
    <span id="currentInfo" style="margin-left:12px;color:#666"></span>
  </div>

  <div id="content" style="margin-top:14px">‚Äî</div>

  <div id="debug"></div>

<script>
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgOTapx48zcAKW4A3Ng4eWIQ23CjzY91Z8kie6YAEmw2mysKtFZFy2HPJYQfiUUNXYBo7cFduFD0YCR-eFrN2BmecZVdrRp8uif05QmePE9MqxWdbfX7KxAX2bHmJG_hKz0mve_XtKEpMH3EoNNHAjq8hN1x2hp9anKg6zmfisYelEwcxWHAwC3cBvR-426VvE1tSZzdRMMbCnOIOExSz-rZURKDz0szMnpbq9wPSG-g6vPYp8mKgWMaQvXEFn9XSMp2lWRu91nieDC6AOPIrSbsOb7hj6_bdrLLTnY&lib=MVvKytvcgtkEcfJU0h31CPln6dGmfhwj8"; // <-- pega aqu√≠ tu URL del Web App

const $ = id => document.getElementById(id);
const tabsEl = $('tabs');
const contentEl = $('content');
const debugEl = $('debug');
const refreshBtn = $('refresh');
const currentInfo = $('currentInfo');

function dbg(t){ debugEl.innerText = t; }

async function fetchJSON(url, opts){
  const r = await fetch(url, opts);
  const text = await r.text();
  try { return JSON.parse(text); }
  catch(e){ throw new Error("Respuesta no JSON: " + text); }
}

// Cargar lista de hojas (keys)
async function loadSheetsList(){
  try {
    const data = await fetchJSON(API_URL);
    if (data.error) throw new Error(data.message || "Error al listar sheets");
    renderTabs(data.sheets || []);
  } catch(err) {
    tabsEl.innerText = "No se pudieron cargar categor√≠as. Revisa deploy y permisos.";
    dbg("Error loadSheetsList: " + err);
  }
}

function renderTabs(sheets){
  tabsEl.innerHTML = '';
  sheets.forEach((s, i) => {
    const b = document.createElement('button');
    b.className = 'tab';
    b.innerText = s.key;
    b.dataset.key = s.key;
    b.dataset.sheetName = s.sheetName;
    b.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      loadProductsFor(s.key);
    });
    tabsEl.appendChild(b);
    if (i===0) { b.classList.add('active'); } // seleccionar futuro
  });
  // auto-select primer tab si existe:
  const first = document.querySelector('.tab.active');
  if (first) loadProductsFor(first.dataset.key);
}

// Cargar productos para una sheetKey
async function loadProductsFor(sheetKey){
  contentEl.innerHTML = 'Cargando productos...';
  currentInfo.innerText = 'Cargando ' + sheetKey + '...';
  try {
    const data = await fetchJSON(API_URL + '?sheetKey=' + encodeURIComponent(sheetKey));
    if (data.error) throw new Error(data.message || "error GET");
    renderProducts(data.products || [], sheetKey, data.headers || []);
    currentInfo.innerText = 'Categoria: ' + sheetKey + ' (' + (data.products.length) + ' items)';
    dbg('GET OK: sheetKey=' + sheetKey + '\nHeaders: ' + JSON.stringify(data.headers || []));
  } catch(err) {
    contentEl.innerHTML = 'Error cargando productos.';
    dbg('Error loadProductsFor: ' + err);
    currentInfo.innerText = '';
  }
}

// Render de productos flex (busca campos comunes: name, price, stock, icon, category)
function renderProducts(products, sheetKey, headers){
  if (!products.length) { contentEl.innerHTML = '<div style="color:#777">No hay productos</div>'; return; }
  const grid = document.createElement('div');
  grid.className = 'grid';
  products.forEach(p => {
    // p: { row: N, data: {header1: value1, ...} }
    const d = p.data;
    // intentamos sacar campos t√≠picos con tolerancia a nombres
    const name = firstKeyValue(d, ['name','producto','nombre','title']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','cost']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad','qty','existencias']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || '';
    const category = firstKeyValue(d, ['category','categoria']) || '';
    const card = document.createElement('div');
    card.className = 'card' + (stock<=0 ? ' disabled' : '');
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <div class="icon">${escapeHTML(icon)}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHTML(name)}</div>
          <div style="color:#666;font-size:13px">${escapeHTML(category)}</div>
        </div>
      </div>
      <div class="meta">
        <div>$ ${price !== '' ? Number(price).toLocaleString() : '-'}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-order" ${stock<=0 ? 'disabled' : ''}>Pedir</button>
        <button class="btn-refresh" title="Refrescar producto">üîÅ</button>
      </div>
    `;
    // attach buttons
    card.querySelector('.btn-order').addEventListener('click', () => pedido(sheetKey, p.row, card));
    card.querySelector('.btn-refresh').addEventListener('click', () => refreshRow(sheetKey, p.row, card));
    grid.appendChild(card);
  });
  contentEl.innerHTML = '';
  contentEl.appendChild(grid);
}

// Buscar primer valor en objeto con los posibles nombres de clave (case-insensitive)
function firstKeyValue(obj, keys) {
  var map = {};
  for (var k in obj) map[k.toString().toLowerCase()] = obj[k];
  for (var i=0;i<keys.length;i++){
    var v = map[keys[i].toLowerCase()];
    if (v !== undefined) return v;
  }
  // si no coincidi√≥, intentar retornar la primera propiedad √∫til
  var any = Object.keys(obj).length ? obj[Object.keys(obj)[0]] : undefined;
  return any;
}

async function pedido(sheetKey, row, cardEl) {
  const stockSpan = cardEl.querySelector('.stockval');
  const before = Number(stockSpan.innerText || 0);
  if (before <= 0) { alert('Stock agotado'); return; }

  dbg('POST decrement row=' + row + ' sheet=' + sheetKey);
  try {
    const form = new URLSearchParams();
    form.append('action','decrement');
    form.append('sheetKey', sheetKey);
    form.append('row', String(row));

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: form.toString()
    });

    const text = await res.text();
    dbg('POST status: ' + res.status + '\n\n' + text);
    const json = JSON.parse(text);
    if (json.error) { alert('Error: ' + json.message); return; }

    const newStock = Number(json.newStock);
    stockSpan.innerText = newStock;
    if (newStock <= 0) {
      cardEl.classList.add('disabled');
      cardEl.querySelector('.btn-order').disabled = true;
    }
  } catch(err) {
    dbg('Error pedido: ' + err);
    alert('No se pudo procesar el pedido. Revisa la consola/debug.');
  }
}

// refrescar una fila espec√≠fica (vuelve a GET la hoja y actualiza s√≥lo la tarjeta)
async function refreshRow(sheetKey, row, cardEl) {
  dbg('Refrescando fila ' + row + ' de ' + sheetKey);
  try {
    const data = await fetchJSON(API_URL + '?sheetKey=' + encodeURIComponent(sheetKey));
    // buscar product con la misma row
    const prod = (data.products || []).find(p => Number(p.row) === Number(row));
    if (!prod) { dbg('Fila no encontrada'); return; }
    const stock = Number(firstKeyValue(prod.data, ['stock','cantidad','qty']) || 0);
    cardEl.querySelector('.stockval').innerText = stock;
    if (stock <= 0) {
      cardEl.classList.add('disabled');
      cardEl.querySelector('.btn-order').disabled = true;
    } else {
      cardEl.classList.remove('disabled');
      cardEl.querySelector('.btn-order').disabled = false;
    }
    dbg('Refrescar OK row=' + row + ' stock=' + stock);
  } catch(err) {
    dbg('Error refreshRow: ' + err);
  }
}

refreshBtn.addEventListener('click', () => {
  const active = document.querySelector('.tab.active');
  if (active) loadProductsFor(active.dataset.key);
});

function escapeHTML(s){ return String(s||''); } // b√°sico

// init
loadSheetsList();
</script>
</body>
</html>
