<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo Marrie ‚Äî Pastel</title>
  <style>
    :root{
      --bg-1: #fff7fb;
      --bg-2: #fff2f6;
      --card-bg: rgba(255,255,255,0.98);
      --accent-1: #ffa7c4;
      --accent-2: #bdebf6;
      --muted: #9aa0a6;
      --shadow: 0 12px 30px rgba(25,20,30,0.06);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, #fff7fb 0%, #fff2f6 100%);
      min-height:100vh;
      padding:28px;
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .header{ text-align:center;margin-bottom:26px; }
    .header h1{
      font-size:2.6rem;
      letter-spacing:-0.02em;
      background: linear-gradient(90deg,#ff9ab3,#c3eaf6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .header p{ color:var(--muted); }

    /* Tabs */
    #tabs{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:28px; }
    .tab{
      background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.95));
      padding:8px 18px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);
      font-weight:600;color:#666;cursor:pointer;transition:.25s;
      box-shadow: 0 4px 14px rgba(200,180,200,0.04);
    }
    .tab.active{ background:linear-gradient(90deg,#ffc6dd,#c6f6ff); color:#111; transform:translateY(-4px); }

    /* Grid */
    #content{ min-height:200px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:20px; align-items:start; }

    /* Card */
    .card{
      background: var(--card-bg);
      border-radius:18px;
      padding:18px;
      box-shadow: var(--shadow);
      transition: transform .28s ease, box-shadow .28s ease;
      position:relative; overflow:visible;
      display:flex; flex-direction:column; gap:12px;
      border: 1px solid rgba(200,180,200,0.08);
      min-height: 260px;
    }
    .card:hover{ transform: translateY(-6px); box-shadow: 0 18px 40px rgba(20,20,30,0.08); }

    /* media / overlay */
    .media{ position:relative; width:100%; display:flex; justify-content:center; }
    .media-reserved{ width:100%; height:160px; border-radius:14px; background:linear-gradient(180deg, rgba(250,245,250,0.6), rgba(255,255,255,0.85)); box-shadow: inset 0 -8px 18px rgba(200,180,200,0.02); }
    .media-overlay{
      position:absolute; inset:0; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:flex-start;
      padding:12px; pointer-events:none; opacity:0; transition:opacity .28s ease;
    }
    .card.show-media .media-overlay{ opacity:1; pointer-events:auto; }
    .media-overlay .image-wrap{ width:100%; max-width:100%; height:160px; border-radius:14px; overflow:hidden; box-shadow: 0 8px 24px rgba(25,20,30,0.08); }
    .product-img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* description only in overlay */
    .media-overlay .desc{
      width:100%; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
      padding:12px; border-radius:10px; font-size:0.95rem; color:#333; box-shadow: 0 6px 20px rgba(0,0,0,0.03);
      max-height:120px; overflow:auto;
    }

    /* Eye button */
    .eye-btn{
      position:absolute; left:12px; top:8px; z-index:40;
      width:38px; height:38px; border-radius:10px; border:0; background:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06); cursor:pointer; transition:transform .18s ease;
    }
    .eye-btn:active{ transform:scale(.96) }

    /* Name + category + price */
    .name{ font-weight:800; font-size:1.05rem; text-align:center; line-height:1.15; color:#111; margin-top:4px; }
    .cat{ text-align:center; font-size:0.9rem; color:var(--muted); margin-bottom:6px; }
    .meta{ display:flex; justify-content:center; align-items:center; gap:12px; flex-direction:column; }
    .price{ font-weight:800; font-size:1.45rem; background:linear-gradient(90deg,#ff6b9f,#7ad3e6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .stock{ font-size:0.85rem; padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#c6f6ff,#e7ffef); color:#075; font-weight:700; }

    /* actions */
    .actions{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:6px; }
    .small{ padding:8px 10px; border-radius:999px; border:1px solid rgba(0,0,0,0.06); background:#fff; cursor:pointer; }
    .order{ background:#111; color:#fff; padding:8px 14px; border-radius:10px; border:0; cursor:pointer; box-shadow: 0 8px 20px rgba(17,17,17,0.08); }

    /* cart (floating) */
    #cart-btn{ position:fixed; right:18px; bottom:18px; background:linear-gradient(90deg,#7ad3e6,#ffa7c4); color:#111; border:0; padding:12px 14px; border-radius:12px; box-shadow:0 12px 40px rgba(20,20,30,0.12); z-index:9999; display:flex; gap:10px; align-items:center; }

    /* small responsive tweaks */
    @media (max-width:520px){
      .media-reserved{ height:140px }
      .card{ min-height: 280px }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üíÑ Marrie</h1>
    <p>Belleza que inspira, calidad que perdura</p>
  </div>

  <div id="app">
    <div id="tabs">Cargando categor√≠as...</div>
    <div id="content">Cargando productos...</div>
  </div>

  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">üõí</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay" style="display:none">
    <!-- (Mant√©n tu modal existente o implem√©ntalo) -->
  </div>

  <script>
    const API_URL = "https://d.thepersonmrt.workers.dev/";
    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');

    function firstKeyValue(obj, keys){
      if (!obj) return undefined;
      const map = {};
      Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
      for (let key of keys){
        const v = map[key.toLowerCase()];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return undefined;
    }
    function escapeHtml(str){
      if(str === undefined || str === null) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    /* helper: crea el elemento de imagen apuntando al proxy del worker */
    function createImageElementProxy(rawIcon, alt){
      const img = document.createElement('img');
      img.className = 'product-img';
      img.alt = alt || 'imagen';
      img.src = API_URL + 'image-proxy?url=' + encodeURIComponent(rawIcon);
      img.referrerPolicy = 'no-referrer';
      return img;
    }

    /* renderProducts (usa sheetKey real del producto) */
    function renderProducts(products, sheetKey){
      if (!products || !products.length){
        if(contentEl) contentEl.innerHTML = 'No hay productos';
        return;
      }
      const grid = document.createElement('div');
      grid.className='grid';

      products.forEach(p=>{
        const d = p.data || {};
        const name = firstKeyValue(d, ['nombre','nombre producto','name','producto','Nombre']) || 'Sin nombre';
        const price = firstKeyValue(d, ['precio','price','Precio']) || '';
        const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || 0);
        const rawIcon = firstKeyValue(d, ['icono','icon','emoji','imagen','image','img','url']) || 'üõçÔ∏è';
        const descripcion = firstKeyValue(d, ['descripcion','description','desc']) || '';
        // calcular sheetKey real: prefer p.sheetKey si est√° (ya tu worker puede enviarla)
        const productSheetKey = p.sheetKey || d.sheetKey || sheetKey;

        const card = document.createElement('div');
        card.className = 'card' + (stock <= 0 ? ' out' : '');
        card.dataset.origStock = stock;
        card.dataset.price = price;
        card.dataset.row = p.row;
        card.dataset.sheetKey = productSheetKey;

        // estructura HTML ‚Äî reservamos espacio para evitar reflow
        card.innerHTML = `
          <div class="media">
            <div class="media-reserved"></div>
            <div class="media-overlay" aria-hidden="true">
              <div class="image-wrap"></div>
              <div class="desc"></div>
            </div>
            <button class="eye-btn" aria-pressed="false" title="Ver imagen">
              <!-- ojo abierto SVG -->
              <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
              <!-- ojo cerrado SVG (hidden by default) -->
              <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a20.2 20.2 0 0 1 5.19-5.58"/><path d="M1 1l22 22"/></svg>
            </button>
          </div>

          <div style="flex:1">
            <div class="name">${escapeHtml(name)}</div>
            <div class="cat">${escapeHtml(productSheetKey || firstKeyValue(d, ['categoria','category']) || '')}</div>
          </div>

          <div class="meta">
            <div class="price">$ ${escapeHtml(String(price))}</div>
            <div class="stock">Stock: ${escapeHtml(String(stock))}</div>
          </div>

          <div class="actions">
            <button class="small minus">-</button>
            <span class="qty">1</span>
            <button class="small plus">+</button>
            <button class="order">Pedir</button>
          </div>
        `;

        // rellenar overlay imagen + descripci√≥n (no modifica tama√±o)
        const overlay = card.querySelector('.media-overlay');
        const imageWrap = overlay.querySelector('.image-wrap');
        const descEl = overlay.querySelector('.desc');

        // solo insertar la imagen si rawIcon parece URL, si no, dejar fallback emoji en el overlay (pero no empuja)
        if (typeof rawIcon === 'string' && /^(https?:)?\/\//i.test(rawIcon)) {
          const img = createImageElementProxy(rawIcon, name);
          imageWrap.appendChild(img);
        } else {
          // mostrar emoji grande centrado
          const emo = document.createElement('div');
          emo.style.fontSize = '42px';
          emo.style.height = '160px';
          emo.style.display = 'flex';
          emo.style.alignItems = 'center';
          emo.style.justifyContent = 'center';
          emo.innerText = rawIcon || 'üõçÔ∏è';
          imageWrap.appendChild(emo);
        }

        // descripci√≥n solo dentro del overlay
        descEl.innerText = descripcion || 'Sin descripci√≥n';

        // eye button toggle (click only)
        const eyeBtn = card.querySelector('.eye-btn');
        const eyeOpenSvg = eyeBtn.querySelector('.eye-open');
        const eyeClosedSvg = eyeBtn.querySelector('.eye-closed');

        function openOverlay(){
          card.classList.add('show-media');
          overlay.setAttribute('aria-hidden', 'false');
          eyeBtn.setAttribute('aria-pressed','true');
          eyeOpenSvg.style.display = 'none';
          eyeClosedSvg.style.display = 'inline';
        }
        function closeOverlay(){
          card.classList.remove('show-media');
          overlay.setAttribute('aria-hidden','true');
          eyeBtn.setAttribute('aria-pressed','false');
          eyeOpenSvg.style.display = 'inline';
          eyeClosedSvg.style.display = 'none';
        }
        eyeBtn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if(card.classList.contains('show-media')) closeOverlay();
          else openOverlay();
        });

        // cerrar al hacer click fuera del overlay dentro de la tarjeta (por accesibilidad)
        card.addEventListener('click', (ev) => {
          // si se hace click fuera del overlay y ya est√° abierto, lo cerramos
          if (card.classList.contains('show-media')) {
            const isInsideOverlay = overlay.contains(ev.target) || eyeBtn.contains(ev.target);
            if (!isInsideOverlay) closeOverlay();
          }
        });

        // acciones +/- y pedir (mismo comportamiento que tu l√≥gica previa; puedes conectar al carrito)
        const qtyEl = card.querySelector('.qty');
        const minus = card.querySelector('.minus');
        const plus = card.querySelector('.plus');
        const orderBtn = card.querySelector('.order');
        let qty = 1;
        minus.onclick = (e) => { e.stopPropagation(); if(qty>1){ qty--; qtyEl.innerText = qty; } };
        plus.onclick = (e) => { e.stopPropagation(); if(qty < stock){ qty++; qtyEl.innerText = qty; } };
        orderBtn.onclick = (e) => { e.stopPropagation(); /* aqu√≠ llama a addToCart si tienes la funci√≥n; placeholder: */ alert('Pedir: ' + name + ' x' + qty); };

        grid.appendChild(card);
      });

      if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
    }

    /* Cargar categor√≠as (tu worker responde con "sheets") */
    async function loadCategories(){
      try {
        const r = await fetch(API_URL, {cache:'no-store'});
        const data = await r.json();
        if (!data.sheets) throw new Error("Respuesta inv√°lida");
        renderTabs(data.sheets);
      } catch(err){
        if(tabsEl) tabsEl.innerHTML = 'Error cargando categor√≠as';
      }
    }

    function renderTabs(sheets){
      if(!tabsEl) return;
      tabsEl.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'tab active';
      allBtn.innerText = "Todos";
      allBtn.onclick = () => { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); allBtn.classList.add('active'); loadProductsAll(); };
      tabsEl.appendChild(allBtn);

      sheets.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.innerText = s.key;
        btn.dataset.key = s.key;
        btn.onclick = ()=> { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); loadProductsFor(s.key); };
        tabsEl.appendChild(btn);
      });
      loadProductsAll();
    }

    async function loadProductsFor(sheetKey){
      if(contentEl) contentEl.innerHTML = 'Cargando...';
      try {
        const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        renderProducts(products, sheetKey);
      } catch(err){ if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    async function loadProductsAll(){
      if(contentEl) contentEl.innerHTML = 'Cargando todos los productos...';
      try {
        const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        renderProducts(products, "ALL");
      } catch(err){ if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    // inicio
    loadCategories();
  </script>
</body>
</html>
