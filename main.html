<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo — Marrie</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg1: #fff5fb;
      --bg2: #fef7f0;
      --accent1: #f7c6d6;
      --accent2: #cfe7ff;
      --accent3: #e9f7ef;
      --muted: #7a7a85;
      --soft-shadow: 0 14px 40px rgba(34,34,60,0.06);
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255,230,240,0.7), transparent 10%),
                  radial-gradient(800px 400px at 90% 80%, rgba(230,245,255,0.6), transparent 10%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:32px;
      color:#111;
    }

    /* subtle animated background blobs */
    .bg-blob{
      position:fixed;pointer-events:none;z-index:0;
      filter: blur(40px); opacity:.14;
      animation: floatBlob 10s ease-in-out infinite;
    }
    .bg-blob.b1{ width:420px;height:420px;background:linear-gradient(135deg,#ffd1e8,#ffd6b3); left:-80px; top:-60px; transform:rotate(20deg); }
    .bg-blob.b2{ width:360px;height:360px;background:linear-gradient(135deg,#cfe7ff,#c9ffd9); right:-90px; bottom:-80px; animation-delay:3s; transform:rotate(-10deg) }
    @keyframes floatBlob{ 0% {transform: translateY(0) scale(1)} 50% {transform: translateY(-18px) scale(1.02)} 100% {transform: translateY(0) scale(1)} }

    /* Header */
    .header{text-align:center;margin-bottom:28px;position:relative;z-index:1}
    .header h1{
      font-size:2.4rem;
      background:linear-gradient(90deg,#ff9ab3,#9ad1ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .header p{color:var(--muted);font-size:1rem;margin-bottom:2px}

    /* Tabs */
    #tabs{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:16px 0 22px;z-index:1;position:relative}
    .tab{
      background:rgba(255,255,255,0.9);
      padding:8px 14px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);
      font-weight:700;cursor:pointer;color:#444;transition:all .25s;
      box-shadow:0 6px 18px rgba(26,22,66,0.03);
    }
    .tab:hover{transform:translateY(-3px)}
    .tab.active{background:linear-gradient(90deg,#ffd1e8,#cfe7ff); color:#222; box-shadow:0 12px 30px rgba(102,126,234,0.08)}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:22px;z-index:1;position:relative}

    /* Card container (handles fade) */
    .card { position:relative; perspective:800px; }

    .flip-inner {
      position:relative;
      width:100%;
      min-height:380px;
      border-radius:18px;
      overflow:visible;
      transition: none;
    }

    .face {
      position:relative;
      border-radius:18px;
      min-height:340px;
      overflow:hidden;
      box-shadow: var(--soft-shadow);
      transition: opacity .32s ease, transform .32s ease, visibility .32s;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
      border:1px solid rgba(0,0,0,0.035);
      display:flex;flex-direction:column;justify-content:space-between;
    }

    .card .face.front{ opacity:1; transform: translateY(0) scale(1); visibility:visible; z-index:2; }
    .card .face.back{ opacity:0; transform: translateY(6px) scale(.995); visibility:hidden; z-index:1; }

    .flip-inner.flipped .face.front{ opacity:0; transform: translateY(-6px) scale(.995); visibility:hidden; z-index:1; }
    .flip-inner.flipped .face.back{ opacity:1; transform: translateY(0) scale(1); visibility:visible; z-index:2; }

    /* Eye toggle */
    .eye-toggle {
      position:absolute; left:12px; top:12px;
      width:44px;height:44px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,0.95);
      border:1px solid rgba(0,0,0,0.06);
      cursor:pointer; z-index:10;
      transition: transform .12s ease, background .18s;
      box-shadow:0 8px 22px rgba(34,34,60,0.06);
    }
    .eye-toggle:active{ transform:scale(.96) }

    /* front small image (now icon circle) */
    .front-image {
      width:110px;height:110px;border-radius:50%;overflow:hidden;margin:22px auto 12px;
      box-shadow:0 14px 36px rgba(34,34,60,0.06);
      border:8px solid rgba(255,255,255,0.95);
      background:linear-gradient(135deg,#fff,#fff);
      display:flex;align-items:center;justify-content:center;
      font-size:40px;
    }
    .product-img{ width:100%; height:100%; object-fit:cover; display:block }

    .name { font-weight:900; text-align:center; margin-top:6px; font-size:1.05rem; color:#222 }
    .meta { padding:12px 18px 0; display:flex;flex-direction:column; gap:8px; align-items:center }

    .price { font-size:1.35rem; font-weight:900; text-align:center; color:#333 }
    .stock { font-size:.85rem; padding:7px 14px; border-radius:20px; color:#fff; font-weight:800; background: linear-gradient(90deg,#9ad1ff,#b9ffd4) }

    .actions{display:flex;gap:10px;align-items:center;justify-content:center;padding:14px 18px 18px}
    .small{padding:8px 10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
    .qty{min-width:26px;text-align:center;font-weight:800}
    .btn.order { background:#111;color:#fff;padding:10px 14px;border-radius:14px;border:0;cursor:pointer; font-weight:900 }
    .btn.order[disabled]{opacity:.5;cursor:not-allowed}

    /* back face specifics */
    .back-image-wrap { width:100%; height:220px; border-radius:12px; overflow:hidden; display:flex;align-items:center;justify-content:center; background: linear-gradient(180deg,#fff,#fbfbff) }
    .back-image { width:100%; height:100%; object-fit:cover; display:block }
    .desc-box { width:100%; max-height:120px; overflow:auto; padding:12px; border-radius:12px; background: linear-gradient(180deg,#fff,#fff); border:1px solid rgba(0,0,0,0.04); font-size:0.95rem; color:#333 }

    .card:hover .face{ transform: translateY(-6px); transition: transform .28s ease, opacity .28s; }

    @media (max-width:520px){
      .grid{gap:14px}
      .back-image-wrap{height:160px}
      .front-image{width:92px;height:92px;font-size:34px;border-width:6px}
    }

    /* cart */
    #cart-btn { position: fixed; right: 18px; bottom: 18px; background: linear-gradient(90deg,#9ad1ff,#ffd1e8); color: #111; border: none; padding: 12px 14px; border-radius: 14px; box-shadow: 0 12px 30px rgba(34,34,60,0.12); cursor: pointer; display:flex; gap:10px; align-items:center; z-index:9999; }
    #cart-btn .badge { background:#111; color:#fff; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.9rem }
    #cart-popup-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.36); display:none; align-items:center; justify-content:center; z-index:10000 }
    #cart-popup { background:white; width:92%; max-width:620px; border-radius:12px; padding:18px; box-shadow:0 14px 44px rgba(34,34,60,0.18); max-height:80vh; overflow:auto }
    .cart-item { display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid #f0f0f0; }
    .empty-msg { text-align:center; color:#666; padding:18px 0; }

    /* center loading text */
    #content { min-height:160px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:700; }
  </style>
</head>
<body>
  <!-- pastel blobs -->
  <div class="bg-blob b1" aria-hidden="true"></div>
  <div class="bg-blob b2" aria-hidden="true"></div>

  <div class="header">
    <h1>💄 Marrie</h1>
    <p>Belleza suave · pedidos rápidos</p>
  </div>

  <div id="app" style="position:relative;z-index:1">
    <div id="tabs">Cargando categorías...</div>
    <div id="content">Cargando productos...</div>
  </div>

  <button id="cart-btn" title="Abrir carrito" style="display:none">
    <span id="cart-icon">🛒</span>
    <span id="cart-summary">Carrito</span>
    <span class="badge" id="cart-count">0</span>
  </button>

  <div id="cart-popup-overlay" style="display:none">
    <div id="cart-popup" role="dialog" aria-modal="true">
      <h3>Confirmar pedido</h3>
      <div id="cart-items-container"></div>
      <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="cart-close" class="small">Seguir comprando</button>
        <button id="cart-confirm" class="btn order">Confirmar y enviar por WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://d.thepersonmrt.workers.dev/";
    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');
    let lastProductsCache = [];
    let lastLoadedSheetKey = null;

    function firstKeyValue(obj, keys){
      if (!obj) return undefined;
      const map = {};
      Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
      for (let key of keys){
        const v = map[key.toLowerCase()];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return undefined;
    }

    function fmtPrice(v){
      if (v===undefined || v===null) return '-';
      const s = String(v).trim();
      if (s === '') return '-';
      const n = parsePriceNumber(s);
      if (/^[\d\.\,]+$/.test(s)) {
        return Number(n).toLocaleString('de-DE');
      }
      return s;
    }

    function parsePriceNumber(v){
      if (v === undefined || v === null) return 0;
      if (typeof v === 'number' && !isNaN(v)) return v;
      let s = String(v).trim();
      if (s === '') return 0;
      s = s.replace(/\s+/g, '');
      s = s.replace(/\./g, '');
      s = s.replace(/,/g, '.');
      s = s.replace(/[^0-9.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    /* Carrito */
    const WHATSAPP_NUMBER = '573207378992';
    let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

    const cartBtn = document.getElementById('cart-btn');
    const cartCountEl = document.getElementById('cart-count');
    const cartSummaryEl = document.getElementById('cart-summary');
    const cartOverlay = document.getElementById('cart-popup-overlay');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCloseBtn = document.getElementById('cart-close');
    const cartConfirmBtn = document.getElementById('cart-confirm');

    function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
    function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

    function getOriginalStock(sheetKey, row){
      const card = Array.from(document.querySelectorAll('.card')).find(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      if(card && card.dataset.origStock !== undefined) return Number(card.dataset.origStock || 0);
      if(window.lastProductsCache && Array.isArray(window.lastProductsCache)){
        const p = window.lastProductsCache.find(pp => String(pp.row) === String(row));
        if(p){
          const d = p.data || {};
          const stock = firstKeyValue(d, ['stock','cantidad']) || 0;
          return Number(stock || 0);
        }
      }
      return 0;
    }

    function getReservedQty(sheetKey, row){
      return cart.filter(i => i.sheetKey === sheetKey && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
    }

    function refreshCardStockDisplay(sheetKey, row){
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === (sheetKey||'') && rrow === (row||'').toString();
      });
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey, row);
      const avail = Math.max(0, origStock - reserved);
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan) stockSpan.innerText = avail;
        const orderBtn = card.querySelector('.order');
        if(avail <= 0){
          card.classList.add('out');
          if(orderBtn) orderBtn.disabled = true;
        } else {
          card.classList.remove('out');
          if(orderBtn) orderBtn.disabled = false;
        }
      });
    }

    function updateCartUI(){
      const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
      const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
      cartCountEl.innerText = count;
      cartSummaryEl.innerText = `Carrito ${count>0? '• ' + count + ' items':''}`;
      if(cartBtn) cartBtn.style.display = 'flex';
      if(cartBtn) cartBtn.title = count ? `${count} item(s) en carrito — Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vacío';
      saveCart();
    }

    function addToCart(card, qty){
      const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
      const row = card.dataset.row;
      const name = card.querySelector('.name')?.innerText || 'Sin nombre';
      const priceRaw = card.dataset.price !== undefined ? card.dataset.price : (card.querySelector('.price')?.innerText || '');
      const priceNum = parsePriceNumber(priceRaw);
      const origStock = getOriginalStock(sheetKey, row);
      const reserved = getReservedQty(sheetKey,row);
      const available = Math.max(0, origStock - reserved);

      if(qty > available){
        alert('No hay suficiente stock disponible.');
        return;
      }

      const key = `${sheetKey}::${row}`;
      const existing = cart.find(i=>cartItemKey(i) === key);
      if(existing){
        existing.qty = Math.min(origStock, existing.qty + qty);
      } else {
        cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
      }

      refreshCardStockDisplay(sheetKey,row);
      updateCartUI();
    }

    /* Cart modal functions */
    function renderCartModal(){
      cartItemsContainer.innerHTML = '';
      if(cart.length === 0){
        cartItemsContainer.innerHTML = `<div class="empty-msg">El carrito está vacío</div>`;
        cartTotalEl.innerText = '';
        return;
      }

      cart.forEach((it, index) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        const left = document.createElement('div');
        left.className = 'left';
        left.innerHTML = `<strong>${it.name}</strong><div style="font-size:13px;color:#666">Precio: $ ${fmtPrice(it.price)} · Nota: ${it.sheetKey}</div>`;

        const right = document.createElement('div');
        right.className = 'right';
        const controls = document.createElement('div');
        controls.style.display = 'flex';
        controls.style.flexDirection = 'column';
        controls.style.alignItems = 'flex-end';
        controls.innerHTML = `
          <div style="display:flex;gap:6px;align-items:center">
            <button class="small-btn cart-minus" data-idx="${index}">-</button>
            <span class="cart-qty" data-idx="${index}">${it.qty}</span>
            <button class="small-btn cart-plus" data-idx="${index}">+</button>
          </div>
          <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
            <div style="font-weight:700">$ ${Number(parsePriceNumber(it._priceNum !== undefined ? it._priceNum : it.price) * Number(it.qty)).toLocaleString('de-DE')}</div>
            <button class="small-btn cart-remove" data-idx="${index}">Eliminar</button>
          </div>
        `;
        right.appendChild(controls);
        div.appendChild(left); div.appendChild(right);
        cartItemsContainer.appendChild(div);
      });

      const total = cart.reduce((s,i)=>s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)),0);
      cartTotalEl.innerText = 'Total: $ ' + Number(total).toLocaleString();

      Array.from(cartItemsContainer.querySelectorAll('.cart-minus')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          if(cart[idx].qty > 1){
            cart[idx].qty = cart[idx].qty - 1;
            refreshCardStockDisplay(cart[idx].sheetKey, cart[idx].row);
            saveCart(); updateCartUI(); renderCartModal();
          } else {
            const it = cart[idx];
            cart.splice(idx,1);
            refreshCardStockDisplay(it.sheetKey, it.row);
            saveCart(); updateCartUI(); renderCartModal();
          }
        };
      });

      Array.from(cartItemsContainer.querySelectorAll('.cart-plus')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          const it = cart[idx];
          const orig = getOriginalStock(it.sheetKey, it.row);
          if(Number(it.qty) < orig){
            it.qty = Number(it.qty) + 1;
            refreshCardStockDisplay(it.sheetKey, it.row);
            saveCart(); updateCartUI(); renderCartModal();
          } else {
            alert('No hay más stock disponible para aumentar la cantidad.');
          }
        };
      });
      Array.from(cartItemsContainer.querySelectorAll('.cart-remove')).forEach(btn=>{
        btn.onclick = (e)=>{
          const idx = Number(btn.dataset.idx);
          if(isNaN(idx)) return;
          const it = cart[idx];
          cart.splice(idx,1);
          refreshCardStockDisplay(it.sheetKey, it.row);
          saveCart(); updateCartUI(); renderCartModal();
        };
      });
    }

    function openCartModal(){
      if(cart.length === 0){
        alert('El carrito está vacío');
        return;
      }
      renderCartModal();
      if(cartOverlay) cartOverlay.style.display = 'flex';
    }
    function closeCartModal(){ if(cartOverlay) cartOverlay.style.display = 'none'; }

    async function sendOrderAndWhatsapp(){
      if(cart.length === 0) return alert('Carrito vacío');
      cartConfirmBtn.disabled = true;
      cartConfirmBtn.innerText = 'Procesando...';

      try{
        const promises = cart.map(it => {
          const form = new URLSearchParams();
          form.append('action','decrement');
          form.append('sheetKey', it.sheetKey);
          form.append('row', it.row);
          form.append('amount', it.qty);
          return fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form })
            .then(r=>r.json())
            .then(res => {
              if(res.error) throw new Error(res.message || 'Error API');
              return { ok:true, ...res, item: it };
            });
        });

        const results = await Promise.all(promises);

        results.forEach(r => {
          const it = r.item;
          const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
            const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
            const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
            return sk === it.sheetKey && rrow === it.row.toString();
          });
          cards.forEach(card => {
            const stockSpan = card.querySelector('.stockval');
            if(stockSpan && typeof r.newStock !== 'undefined'){
              card.dataset.origStock = Number(r.newStock);
              stockSpan.innerText = Number(r.newStock);
              const orderBtn = card.querySelector('.order');
              if(Number(r.newStock) <= 0){
                card.classList.add('out');
                if(orderBtn) orderBtn.disabled = true;
              } else {
                card.classList.remove('out');
                if(orderBtn) orderBtn.disabled = false;
              }
            }
          });
        });

        let msg = 'buenas noches, me interesaria comprar:%0A';
        cart.forEach(it => {
          msg += `- ${it.name}, precio: $ ${fmtPrice(it.price)}, cantidad: ${it.qty}%0A`;
        });
        msg += '%0Amuchas gracias';

        if(!WHATSAPP_NUMBER || WHATSAPP_NUMBER.includes('WHATSAPP_NUMBER_HERE')){
          alert('Por favor reemplaza WHATSAPP_NUMBER_HERE por el número de destino en el script.');
        } else {
          const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
          window.open(waUrl, '_blank');
        }

        cart = [];
        saveCart();
        updateCartUI();
        closeCartModal();
      }catch(err){
        alert('Error al procesar el pedido: ' + (err.message || err));
      }finally{
        cartConfirmBtn.disabled = false;
        cartConfirmBtn.innerText = 'Confirmar y enviar por WhatsApp';
      }
    }

    if(cartCloseBtn) cartCloseBtn.onclick = closeCartModal;
    if(cartConfirmBtn) cartConfirmBtn.onclick = sendOrderAndWhatsapp;
    if(cartBtn) cartBtn.onclick = openCartModal;

    updateCartUI();

    /* Load categories & products */
    async function loadCategories(){
      try {
        const r = await fetch(API_URL, {cache:'no-store'});
        const data = await r.json();
        if (!data.sheets) throw new Error("Respuesta inválida");
        renderTabs(data.sheets);
      } catch(err){
        if(tabsEl) tabsEl.innerHTML = 'Error cargando categorías';
        console.error(err);
      }
    }

    function renderTabs(sheets){
      if(!tabsEl) return;
      tabsEl.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.className = 'tab active';
      allBtn.innerText = "Todos";
      allBtn.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        allBtn.classList.add('active');
        loadProductsAll();
      };
      tabsEl.appendChild(allBtn);

      sheets.forEach((s)=>{
        const btn = document.createElement('button');
        btn.className = 'tab';
        btn.innerText = s.key;
        btn.dataset.key = s.key;
        btn.onclick = ()=> {
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          loadProductsFor(s.key);
        };
        tabsEl.appendChild(btn);
      });

      loadProductsAll();
    }

    async function loadProductsFor(sheetKey){
      lastLoadedSheetKey = sheetKey;
      if(contentEl) contentEl.innerHTML = 'Cargando...';
      try {
        const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, sheetKey);
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    async function loadProductsAll(){
      lastLoadedSheetKey = "ALL";
      if(contentEl) contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
      try {
        const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
        const data = await r.json();
        if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
        const products = data.products || [];
        lastProductsCache = products;
        renderProducts(products, "ALL");
      } catch(err){ console.error(err); if(contentEl) contentEl.innerHTML='Error cargando productos'; }
    }

    function escapeHtml(str){
      if(str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function proxiedUrl(raw){
      if(!raw || typeof raw !== 'string') return '';
      return API_URL + 'image-proxy?url=' + encodeURIComponent(raw);
    }

    function makeImgEl(raw, alt, className){
      const img = document.createElement('img');
      img.alt = alt || '';
      img.className = className || '';
      try {
        img.src = proxiedUrl(raw);
      } catch(e){
        img.src = '';
      }
      img.onerror = () => { img.remove(); };
      return img;
    }

    /* Render products — now: Icono (emoji/text) -> front circle; Img (url) -> back image */
    function renderProducts(products, sheetKey){
      if (!products || !products.length){
        if(contentEl) contentEl.innerHTML = 'No hay productos';
        return;
      }
      const grid = document.createElement('div');
      grid.className='grid';

      products.forEach(p=>{
        const d = p.data || {};
        const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || 'Sin nombre';
        const price = firstKeyValue(d, ['price','precio','Precio']) || '';
        const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || 0);

        // NUEVO: Icono = emoji/text; Img = URL de imagen grande
        const iconText = firstKeyValue(d, ['Icono','icono','icon','emoji']) || '🛍️';
        const imgUrl   = firstKeyValue(d, ['Img','img','imagen','image','foto']) || '';

        const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota']) || '';

        const productSheetKey = p.sheetKey || d.sheetKey || d.SheetKey || (sheetKey === "ALL" ? (d.Descripcion || d.descripcion || d.Categoria || d.categoria || d.category || 'UNKNOWN') : sheetKey);

        const cardWrap = document.createElement('div');
        cardWrap.className = 'card';
        cardWrap.dataset.origStock = stock;
        cardWrap.dataset.price = price;
        cardWrap.dataset.row = p.row;
        cardWrap.dataset.sheetKey = productSheetKey;

        const inner = document.createElement('div');
        inner.className = 'flip-inner';

        const front = document.createElement('div');
        front.className = 'face front';
        front.innerHTML = `
          <div style="position:relative;padding:12px;">
            <button class="eye-toggle" aria-pressed="false" title="Ver imagen y descripción" type="button" aria-label="Ver imagen y descripción">
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="#333" stroke-width="1.2"/>
              </svg>
            </button>

            <div class="front-image"></div>

            <div class="meta">
              <div class="name">${escapeHtml(name)}</div>
              <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px">
                <div class="price">$ ${fmtPrice(price)}</div>
                <div class="stock">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></div>
              </div>
            </div>
          </div>

          <div style="padding:0 14px 14px">
            <div class="actions">
              <button class="small minus">-</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        `;

        const back = document.createElement('div');
        back.className = 'face back';
        back.innerHTML = `
          <div style="position:relative;padding:10px 12px 6px">
            <button class="eye-toggle" aria-pressed="true" title="Volver" type="button" aria-label="Volver">
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3l18 18" stroke="#333" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12s4-7 10-7 10 7 10 7" stroke="#333" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="back-image-wrap"></div>
          <div style="padding:12px">
            <div class="desc-box">${escapeHtml(description || 'Sin descripción')}</div>
          </div>

          <div style="height:12px"></div>
        `;

        inner.appendChild(front);
        inner.appendChild(back);
        cardWrap.appendChild(inner);
        grid.appendChild(cardWrap);

        // populate front circle with iconText (emoji or short text)
        const frontImageWrap = front.querySelector('.front-image');
        // prefer showing the iconText as-is (emoji/text). If iconText unexpectedly is a URL and imgUrl is empty, fall back to trying to show that as image.
        if (typeof iconText === 'string' && iconText.trim() !== '' && !/^(https?:)?\/\//i.test(iconText)) {
          const span = document.createElement('div');
          span.style.fontSize = '40px';
          span.style.lineHeight = '1';
          span.style.textAlign = 'center';
          span.style.userSelect = 'none';
          span.innerText = iconText;
          frontImageWrap.appendChild(span);
        } else if (imgUrl) {
          // If iconText is a URL or empty but we have an imgUrl, show a small image in the circle
          const imgSmall = makeImgEl(imgUrl, name, 'product-img');
          imgSmall.style.width = '100%';
          imgSmall.style.height = '100%';
          frontImageWrap.appendChild(imgSmall);
        } else {
          const span = document.createElement('div');
          span.style.fontSize = '34px';
          span.innerText = '🛍️';
          frontImageWrap.appendChild(span);
        }

        // populate back with big image from imgUrl (Img field)
        const backImageWrap = back.querySelector('.back-image-wrap');
        if (imgUrl && typeof imgUrl === 'string' && /^(https?:)?\/\//i.test(imgUrl)) {
          const imgLarge = makeImgEl(imgUrl, name, 'back-image');
          backImageWrap.appendChild(imgLarge);
        } else {
          backImageWrap.innerHTML = `<div style="padding:20px;color:#999">Imagen no disponible</div>`;
        }

        // eye toggles: only open/close on click (no hover)
        const eyeFront = front.querySelector('.eye-toggle');
        const eyeBack = back.querySelector('.eye-toggle');

        function showBack(){
          inner.classList.add('flipped');
        }
        function showFront(){
          inner.classList.remove('flipped');
        }

        eyeFront.addEventListener('click', (e)=>{
          e.stopPropagation();
          showBack();
        });
        eyeBack.addEventListener('click', (e)=>{
          e.stopPropagation();
          showFront();
        });

        // also close back if user clicks outside content but inside card area (keeps page stable)
        cardWrap.addEventListener('click', (ev) => {
          if (inner.classList.contains('flipped')) {
            const targetIsInsideBack = back.contains(ev.target);
            const targetIsEye = back.querySelector('.eye-toggle') && back.querySelector('.eye-toggle').contains(ev.target);
            if (!targetIsInsideBack || targetIsEye) {
              if (!targetIsInsideBack) showFront();
            }
          }
        });

        // quantity controls
        const minusBtns = cardWrap.querySelectorAll('.minus');
        const plusBtns = cardWrap.querySelectorAll('.plus');
        const qtySpans = cardWrap.querySelectorAll('.qty');
        minusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const current = Number(qtySpans[0].innerText || '1');
          if(current > 1){
            qtySpans.forEach(s=>s.innerText = current - 1);
          }
        }));
        plusBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const orig = getOriginalStock(cardWrap.dataset.sheetKey, cardWrap.dataset.row);
          const current = Number(qtySpans[0].innerText || '1');
          if(current < Math.max(0, orig - getReservedQty(cardWrap.dataset.sheetKey, cardWrap.dataset.row))){
            qtySpans.forEach(s=>s.innerText = current + 1);
          }
        }));

        // order buttons (only front)
        const orderBtns = cardWrap.querySelectorAll('.order');
        orderBtns.forEach(btn => btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const qty = Number(cardWrap.querySelector('.qty').innerText || '1');
          addToCart(cardWrap, qty);
        }));

        // ensure front visible initially (no flip)
        showFront();
      });

      if(contentEl){ contentEl.innerHTML=''; contentEl.appendChild(grid); }
    }

    loadCategories();
  </script>
</body>
</html>

</body>
</html>
