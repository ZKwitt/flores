<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda din√°mica (Google Sheets)</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --muted:#666; --accent:#111;
      --success:#1a7f37; --danger:#c0392b;
      --radius:10px;
    }
    body{font-family:Inter, system-ui, Arial; margin:0; padding:18px; background:var(--bg); color:#111}
    h1{margin:6px 0 14px 0}
    #app{max-width:1100px;margin:0 auto}
    #tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{background:#fff;border:1px solid #e6e6e6;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}
    #controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    #refresh{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    #content{min-height:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #eee;border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 6px rgba(20,20,20,0.03)}
    .card.out{opacity:.5}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .icon{font-size:28px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#f4f4f4}
    .name{font-weight:700}
    .cat{font-size:12px;color:var(--muted)}
    .price{font-weight:700}
    .stock{font-weight:600}
    .actions{display:flex;gap:8px;margin-top:6px}
    button.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    button.order{background:#111;color:#fff}
    button.order[disabled]{opacity:.5;cursor:not-allowed}
    button.small{padding:6px 8px;border:1px solid #ddd;background:#fff}
    #debug{margin-top:14px;background:#fff;padding:10px;border-radius:8px;border:1px solid #eee;white-space:pre-wrap;font-size:13px;color:#222}
    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px}
    .search{padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff;min-width:220px}
    .hint{font-size:13px;color:var(--muted)}
    @media (max-width:520px){
      .grid{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Tienda din√°mica</h1>
    <div class="topbar">
      <div id="tabs">Cargando categor√≠as...</div>
      <div style="flex:1"></div>
      <input id="search" class="search" placeholder="Buscar producto..." />
      <button id="refresh" title="Refrescar categor√≠a actual">üîÅ Refrescar</button>
    </div>

    <div id="controls" style="align-items:center">
      <div class="hint">Selecciona una categor√≠a (las hojas configuradas en el Apps Script)</div>
      <div id="currentInfo" style="margin-left:auto;color:var(--muted)"></div>
    </div>

    <div id="content">Cargando productos...</div>

    <div id="debug">Debug: ‚Äî</div>
  </div>

<script>
/* ========== CONFIG (reemplaza solo API_URL) ========== */
const API_URL = "https://d.thepersonmrt.workers.dev/"; // <-- Pega la URL del Web App (https://script.google.com/macros/s/AKfy.../exec)
/* ==================================================== */

const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const debugEl = document.getElementById('debug');
const refreshBtn = document.getElementById('refresh');
const searchInput = document.getElementById('search');
const currentInfo = document.getElementById('currentInfo');

function dbg(txt){ debugEl.innerText = txt; console.log(txt); }

// Util: safe JSON fetch with text read
async function fetchText(url, opts){ const r = await fetch(url, opts); const text = await r.text(); return {status: r.status, text}; }

// Generic fetchJSON with fallback to JSONP (for GET)
async function fetchJSONWithFallback(url, {jsonpCallbackIfFail=true} = {}) {
  try {
    const r = await fetch(url, { method: 'GET', cache: 'no-store' });
    const text = await r.text();
    // try parse JSON
    try { return JSON.parse(text); } catch(e) { 
      // if not JSON and JSONP allowed, try JSONP if server supports callback param
      if (jsonpCallbackIfFail) {
        return await jsonpGet(url);
      }
      throw new Error("Respuesta no JSON: " + text);
    }
  } catch (err) {
    // fallback to JSONP
    if (jsonpCallbackIfFail) {
      return await jsonpGet(url);
    }
    throw err;
  }
}

// JSONP helper: appends callback=... to url
function jsonpGet(url){
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const u = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    const script = document.createElement('script');
    window[cb] = function(data){
      resolve(data);
      cleanup();
    };
    script.src = u;
    script.onerror = function(e){ cleanup(); reject(new Error('JSONP load error')); };
    document.body.appendChild(script);
    function cleanup(){
      try{ delete window[cb]; }catch(e){}
      script.remove();
    }
    // safety timeout
    setTimeout(()=>{ if (window[cb]) { cleanup(); reject(new Error('JSONP timeout')); } }, 7000);
  });
}

/* ========== Helpers para nombres de columnas flexibles ========== */
function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => { map[k.toLowerCase()] = obj[k]; });
  for (let i=0;i<keys.length;i++){
    const v = map[keys[i].toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  // fallback: any non-empty field
  for (let k in obj) if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return obj[k];
  return undefined;
}
function fmtPrice(v){ return (v===null||v===undefined||v==='') ? '-' : Number(v).toLocaleString(); }
function escapeHTML(s){ return String(s===undefined||s===null ? '' : s); }

/* ========== UI - cargar lista de sheets (categor√≠as) ========== */
async function loadCategories(){
  tabsEl.innerHTML = 'Cargando categor√≠as...';
  try {
    const data = await fetchJSONWithFallback(API_URL);
    if (!data || !data.sheets) throw new Error('Respuesta invalida (esperaba {sheets: [...]})');
    renderTabs(data.sheets);
    dbg('Categorias cargadas: ' + JSON.stringify(data.sheets.map(s=>s.key)));
  } catch (err) {
    tabsEl.innerHTML = 'Error cargando categor√≠as';
    dbg('Error loadCategories: ' + err);
  }
}

function renderTabs(sheets){
  tabsEl.innerHTML = '';
  sheets.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.title = s.sheetName || s.key;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    });
    tabsEl.appendChild(btn);
    if (i === 0) btn.classList.add('active'); // marcar primera
  });
  // auto-select first
  const first = document.querySelector('.tab.active');
  if (first) loadProductsFor(first.dataset.key);
}

/* ========== UI - cargar productos de una sheetKey ========== */
let lastLoadedSheetKey = null;
let lastProductsCache = []; // cache for filter/search

async function loadProductsFor(sheetKey){
  contentEl.innerHTML = 'Cargando productos...';
  currentInfo.innerText = 'Cargando ' + sheetKey + '...';
  lastLoadedSheetKey = sheetKey;
  try {
    const url = API_URL + '?sheetKey=' + encodeURIComponent(sheetKey);
    const data = await fetchJSONWithFallback(url);
    if (data.error) throw new Error(data.message || JSON.stringify(data));
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey, data.headers || []);
    currentInfo.innerText = `Categor√≠a: ${sheetKey} ‚Äî ${products.length} items`;
    dbg('GET OK sheetKey=' + sheetKey + ' products=' + products.length);
  } catch (err) {
    contentEl.innerHTML = '<div style="color:#c0392b">Error cargando productos. Revisa debug.</div>';
    dbg('Error loadProductsFor: ' + err);
    currentInfo.innerText = '';
  }
}

function renderProducts(products, sheetKey, headers){
  if (!products || !products.length) {
    contentEl.innerHTML = '<div style="color:#666">No hay productos en esta categor√≠a</div>';
    return;
  }
  // render grid
  const grid = document.createElement('div');
  grid.className = 'grid';
  // apply current search filter
  const q = (searchInput.value || '').trim().toLowerCase();

  products.forEach(p => {
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto','title']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','cost']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad','qty','existencias']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || '';
    const category = firstKeyValue(d, ['category','categoria']) || '';

    if (q) {
      const hay = (String(name)+String(category)+String(icon)).toLowerCase();
      if (!hay.includes(q)) return; // skip
    }

    const card = document.createElement('div');
    card.className = 'card' + (stock <= 0 ? ' out' : '');
    card.dataset.row = p.row;
    card.dataset.sheetKey = sheetKey;

    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div class="icon">${escapeHTML(icon || 'üõçÔ∏è')}</div>
        <div style="flex:1">
          <div class="name">${escapeHTML(name)}</div>
          <div class="cat">${escapeHTML(category)}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div class="actions">
        <button class="btn order" ${stock<=0 ? 'disabled' : ''}>Pedir</button>
        <button class="btn small refresh">üîÅ</button>
        <button class="btn small details">Detalles</button>
      </div>
    `;
    // bind buttons
    const orderBtn = card.querySelector('.order');
    const refreshBtnCard = card.querySelector('.refresh');
    orderBtn.addEventListener('click', () => handleOrder(card));
    refreshBtnCard.addEventListener('click', () => refreshRow(sheetKey, p.row, card));

    grid.appendChild(card);
  });

  contentEl.innerHTML = '';
  contentEl.appendChild(grid);
}

/* ========== Ordenar / Pedir producto (POST form-urlencoded) ========== */
async function handleOrder(cardEl){
  const sheetKey = cardEl.dataset.sheetKey;
  const row = Number(cardEl.dataset.row);
  const stockSpan = cardEl.querySelector('.stockval');
  const before = Number(stockSpan.innerText || 0);
  if (before <= 0) { alert('Stock agotado'); return; }

  // disable UI while procesando
  const orderBtn = cardEl.querySelector('.order');
  orderBtn.disabled = true;
  orderBtn.innerText = 'Procesando...';

  try {
    const form = new URLSearchParams();
    form.append('action','decrement');
    form.append('sheetKey', sheetKey);
    form.append('row', String(row));

    const r = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: form.toString()
    });
    const text = await r.text();
    dbg('POST status: ' + r.status + '\n' + text);
    let json;
    try { json = JSON.parse(text); } catch(e){ throw new Error('Respuesta POST inv√°lida: ' + text); }

    if (json.error) { throw new Error(json.message || 'Error servidor'); }

    const newStock = Number(json.newStock);
    stockSpan.innerText = newStock;
    if (newStock <= 0) {
      cardEl.classList.add('out');
      orderBtn.disabled = true;
    } else {
      orderBtn.disabled = false;
    }
    orderBtn.innerText = 'Pedir';
    dbg(`Pedido OK row=${row} old=${json.oldStock} new=${json.newStock}`);
  } catch (err) {
    console.error(err);
    dbg('Error handleOrder: ' + err);
    alert('No se pudo completar el pedido. Revisa debug.');
    // re-enable
    orderBtn.disabled = false;
    orderBtn.innerText = 'Pedir';
  }
}

/* ========== Refrescar fila espec√≠fica (GET + actualizar tarjeta) ========== */
async function refreshRow(sheetKey, row, cardEl){
  dbg('Refrescando fila ' + row + ' de ' + sheetKey + ' ...');
  try {
    const data = await fetchJSONWithFallback(API_URL + '?sheetKey=' + encodeURIComponent(sheetKey));
    const prod = (data.products || []).find(p => Number(p.row) === Number(row));
    if (!prod) { dbg('Fila no encontrada al refrescar'); return; }
    const stock = Number(firstKeyValue(prod.data, ['stock','cantidad','qty','existencias']) || 0);
    const stockSpan = cardEl.querySelector('.stockval');
    stockSpan.innerText = stock;
    if (stock <= 0) {
      cardEl.classList.add('out');
      cardEl.querySelector('.order').disabled = true;
    } else {
      cardEl.classList.remove('out');
      cardEl.querySelector('.order').disabled = false;
    }
    dbg('Refresh OK row=' + row + ' stock=' + stock);
  } catch (err) {
    dbg('Error refreshRow: ' + err);
  }
}

/* ========== Utilities: refresh active category, search ======= */
async function refreshActive(){
  const active = document.querySelector('.tab.active');
  if (active) loadProductsFor(active.dataset.key);
}

refreshBtn.addEventListener('click', refreshActive);
searchInput.addEventListener('input', () => {
  // re-render from lastProductsCache; simple debounce
  if (!lastProductsCache) return;
  renderProducts(lastProductsCache, lastLoadedSheetKey);
});

/* ========== Init ========== */
loadCategories();
dbg('Inicializando tienda. API_URL=' + API_URL + '\nConsejo: si GET falla por CORS, prueba JSONP fallback (ya habilitado). Para POST se usa application/x-www-form-urlencoded.).');

</script>
</body>
</html>
