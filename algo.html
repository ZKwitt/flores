<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo Bonnie Makeup</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,Arial;
      background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
      min-height:100vh;
      padding:20px;
      overflow-x:hidden;
      color:#111;
    }

    /* Header */
    .header{text-align:center;margin-bottom:30px;position:relative}
    .header::before{
      content:'';position:absolute;top:-20px;left:50%;
      transform:translateX(-50%);
      width:100px;height:4px;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);
      border-radius:2px;
    }
    .header h1{
      font-size:3rem;
      background:linear-gradient(45deg,#667eea,#764ba2,#ff6b6b);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 4px 20px rgba(0,0,0,0.1);
      margin-bottom:8px;
    }
    .header p{font-size:1.1rem;color:#555;font-style:italic}

    /* Tabs (categorías) */
    #tabs{
      display:flex;flex-wrap:wrap;gap:12px;justify-content:center;
      margin-bottom:24px;
    }
    .tab{
      background:rgba(255,255,255,0.9);
      padding:10px 20px;
      border-radius:25px;
      border:2px solid transparent;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      color:#666;
    }
    .tab:hover,.tab.active{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(102,126,234,.3);
    }

    /* Productos grid */
    #content{min-height:160px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:20px;
    }

    .card{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(15px);
      border-radius:20px;
      padding:20px;
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 12px 30px rgba(0,0,0,0.08);
      transition:.35s cubic-bezier(0.175,0.885,0.32,1.275);
      display:flex;flex-direction:column;gap:10px;
      position:relative;overflow:hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:-100%;
      width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
      transition:.5s;
    }
    .card:hover{transform:translateY(-6px) scale(1.02)}
    .card:hover::before{left:100%}
    .card.out{opacity:.5}

    .icon{
      width:60px;height:60px;
      border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:26px;
      background:linear-gradient(45deg,#667eea,#764ba2);
      margin:0 auto 12px;
      color:#fff;
      box-shadow:0 6px 18px rgba(102,126,234,0.3);
    }
    .name{font-weight:700;font-size:1.05rem;text-align:center;min-height:40px}
    .cat{font-size:12px;color:#888;text-align:center}
    .price{
      font-size:1.6rem;font-weight:700;
      background:linear-gradient(45deg,#ff6b6b,#4ecdc4);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-align:center;
    }
    .stock{
      background:linear-gradient(45deg,#667eea,#764ba2);
      color:#fff;font-size:.9rem;font-weight:600;
      padding:6px 14px;border-radius:20px;
      margin:0 auto;
      box-shadow:0 4px 12px rgba(102,126,234,0.25);
    }

    .actions{display:flex;gap:8px;margin-top:8px;align-items:center;justify-content:center}
    button.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    button.order{background:#111;color:#fff}
    button.order[disabled]{opacity:.5;cursor:not-allowed}
    button.small{padding:6px 8px;border:1px solid #ddd;background:#fff}
    .qty{min-width:20px;text-align:center;font-weight:600}

    /* Debug */
    #debug{
      margin-top:20px;background:#fff;
      padding:12px;border-radius:10px;
      border:1px solid #eee;
      white-space:pre-wrap;font-size:13px;color:#222;
      max-width:1100px;margin-left:auto;margin-right:auto;
    }

    /* Floating emojis */
    .floating-shapes{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
    .shape{position:absolute;opacity:.08;animation:float 6s ease-in-out infinite;font-size:2rem}
    .shape:nth-child(1){top:20%;left:10%;animation-delay:0s}
    .shape:nth-child(2){top:60%;left:80%;animation-delay:2s}
    .shape:nth-child(3){top:30%;left:60%;animation-delay:4s}
    @keyframes float{
      0%,100%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-20px) rotate(180deg)}
    }

    /* Carrito (esquina inferior derecha) */
#cart-btn {
  position: fixed;
  right: 18px;
  bottom: 18px;
  background: #0b84ff;
  color: white;
  border: none;
  padding: 12px 14px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  cursor: pointer;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:9999;
}
#cart-btn .badge { background:#ff4757; padding:4px 7px; border-radius:999px; font-weight:700; }
#cart-popup-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:10000; }
#cart-popup { background:white; width:90%; max-width:560px; border-radius:10px; padding:18px; box-shadow:0 8px 28px rgba(0,0,0,0.2); max-height:80vh; overflow:auto; }
#cart-popup h3 { margin-top:0; }
.cart-item { display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid #eee; }
.cart-item .left { flex:1; }
.cart-item .right { text-align:right; min-width:110px; }
#cart-popup .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
.small-btn { padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
.confirm-btn { background:#0b84ff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
.empty-msg { text-align:center; color:#666; padding:18px 0; }
    
  </style>
</head>
<body>
  <div class="floating-shapes">
    <div class="shape">💄</div>
    <div class="shape">✨</div>
    <div class="shape">💋</div>
  </div>

  <div class="header">
    <h1>💄 Marrie</h1>
    <p>Belleza que inspira, calidad que perdura</p>
  </div>

  <div id="app">
    <div id="tabs">Cargando categorías...</div>
    <div id="content">Cargando productos...</div>
    <div id="debug">Debug: —</div>
  </div>

  <!-- Añade esto en tu HTML (por ejemplo al final del body) -->
<button id="cart-btn" title="Abrir carrito" style="display:none">
  <span id="cart-icon">🛒</span>
  <span id="cart-summary">Carrito</span>
  <span class="badge" id="cart-count">0</span>
</button>

<div id="cart-popup-overlay">
  <div id="cart-popup" role="dialog" aria-modal="true">
    <h3>Confirmar pedido</h3>
    <div id="cart-items-container"></div>
    <div id="cart-total" style="margin-top:12px;font-weight:700"></div>
    <div class="actions">
      <button class="small-btn" id="cart-close">Seguir comprando</button>
      <button class="confirm-btn" id="cart-confirm">Confirmar y enviar por WhatsApp</button>
    </div>
  </div>
</div>
</body>
<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; 
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const debugEl = document.getElementById('debug');
let lastProductsCache = [];
let lastLoadedSheetKey = null;

function dbg(txt){ debugEl.innerText = txt; console.log(txt); }

function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function fmtPrice(v){ return (v===''||v==null) ? '-' : Number(v).toLocaleString(); }

/* ----------------- Carrito ----------------- */
const WHATSAPP_NUMBER = '573207378992'; // <-- Reemplaza por tu número en formato internacional sin '+', ej: 573001234567
let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

const cartBtn = document.getElementById('cart-btn');
const cartCountEl = document.getElementById('cart-count');
const cartSummaryEl = document.getElementById('cart-summary');
const cartOverlay = document.getElementById('cart-popup-overlay');
const cartItemsContainer = document.getElementById('cart-items-container');
const cartTotalEl = document.getElementById('cart-total');
const cartCloseBtn = document.getElementById('cart-close');
const cartConfirmBtn = document.getElementById('cart-confirm');

function saveCart(){
  localStorage.setItem('shop_cart_v1', JSON.stringify(cart));
}
function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

function updateCartUI(){
  const count = cart.reduce((s,i)=>s+i.qty,0);
  const total = cart.reduce((s,i)=> s + (Number(i.price||0) * Number(i.qty||0)), 0);
  cartCountEl.innerText = count;
  cartSummaryEl.innerText = `Carrito ${count>0? '• ' + count + ' items':''}`;
  cartBtn.style.display = 'flex';
  cartBtn.title = count ? `${count} item(s) en carrito — Total $ ${fmtPrice(total)}` : 'Carrito vacío';
  saveCart();
}

function parsePriceFromCardText(txt){
  // txt ejemplo: "$ 1,234"
  if(!txt) return 0;
  return Number(String(txt).replace(/[^\d.-]/g,'') || 0);
}

/* Abre modal con items */
function openCartModal(){
  if(cart.length === 0){
    alert('El carrito está vacío');
    return;
  }
  cartItemsContainer.innerHTML = '';
  cart.forEach(it => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    const left = document.createElement('div');
    left.className = 'left';
    left.innerHTML = `<strong>${it.name}</strong><div style="font-size:13px;color:#666">Precio: $ ${fmtPrice(it.price)} · Nota: ${it.sheetKey}</div>`;
    const right = document.createElement('div');
    right.className = 'right';
    right.innerHTML = `<div>Cant: ${it.qty}</div><div style="font-weight:700">$ ${fmtPrice(Number(it.price) * Number(it.qty))}</div>`;
    div.appendChild(left); div.appendChild(right);
    cartItemsContainer.appendChild(div);
  });
  const total = cart.reduce((s,i)=>s + (Number(i.price||0)*Number(i.qty||0)),0);
  cartTotalEl.innerText = 'Total: $ ' + fmtPrice(total);
  cartOverlay.style.display = 'flex';
}

/* Cerrar modal */
function closeCartModal(){ cartOverlay.style.display = 'none'; }

/* Añadir al carrito */
function addToCart(card, qty){
  const sheetKey = card.dataset.sheetKey || lastLoadedSheetKey || 'UNKNOWN';
  const row = card.dataset.row;
  const name = card.querySelector('.name')?.innerText || 'Sin nombre';
  const price = parsePriceFromCardText(card.querySelector('.price')?.innerText || '') || 0;
  const stockSpan = card.querySelector('.stockval');
  const available = Number(stockSpan?.innerText || 0);

  // validar stock
  if(qty > available){
    alert('No hay suficiente stock disponible.');
    return;
  }

  const key = `${sheetKey}::${row}`;
  const existing = cart.find(i=>cartItemKey(i) === key);
  if(existing){
    const newQty = Math.min(available, existing.qty + qty);
    existing.qty = newQty;
  } else {
    cart.push({ sheetKey, row, name, price, qty });
  }
  updateCartUI();
  dbg('Añadido al carrito: ' + name + ' x' + qty);
}

/* Enviar pedido: decrement en servidor y abrir WhatsApp */
async function sendOrderAndWhatsapp(){
  if(cart.length === 0) return alert('Carrito vacío');
  cartConfirmBtn.disabled = true;
  cartConfirmBtn.innerText = 'Procesando...';

  try{
    // Mandar decrement para cada item (se puede optimizar en lote si el API lo admite)
    const promises = cart.map(it => {
      const form = new URLSearchParams();
      form.append('action','decrement');
      form.append('sheetKey', it.sheetKey);
      form.append('row', it.row);
      form.append('amount', it.qty);
      return fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form })
        .then(r=>r.json())
        .then(res => {
          if(res.error) throw new Error(res.message || 'Error API');
          return { ok:true, ...res, item: it };
        });
    });

    const results = await Promise.all(promises);
    // Si llegamos aquí, todos ok
    // Actualizar stock en los cards visibles
    results.forEach(r => {
      const it = r.item;
      // buscar card con matching dataset
      const selector = `.card[data-row="${it.row}"][data-sheet-key="${it.sheetKey}"], .card[data-row="${it.row}"][data-sheetkey="${it.sheetKey}"]`;
      // nota: algunas implementaciones usan dataset con mayúsculas; buscaremos por atributo dataset
      const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
        // comparar sin importar mayúsculas
        const sk = (c.dataset.sheetKey || c.getAttribute('data-sheet-key') || '').toString();
        const rrow = (c.dataset.row || c.getAttribute('data-row') || '').toString();
        return sk === it.sheetKey && rrow === it.row.toString();
      });
      cards.forEach(card => {
        const stockSpan = card.querySelector('.stockval');
        if(stockSpan && typeof r.newStock !== 'undefined'){
          stockSpan.innerText = Number(r.newStock);
          const orderBtn = card.querySelector('.order');
          if(Number(r.newStock) <= 0){
            card.classList.add('out');
            if(orderBtn) orderBtn.disabled = true;
          } else {
            if(orderBtn) orderBtn.disabled = false;
          }
        }
      });
    });

    // Construir mensaje para WhatsApp
    let msg = 'buenas noches, me interesaria comprar:%0A';
    cart.forEach(it => {
      msg += `- ${it.name}, precio: $ ${fmtPrice(it.price)}, cantidad: ${it.qty}%0A`;
    });
    msg += '%0Amuchas gracias';

    // Abrir WhatsApp
    if(!WHATSAPP_NUMBER || WHATSAPP_NUMBER.includes('WHATSAPP_NUMBER_HERE')){
      // El usuario no reemplazó número
      alert('Por favor reemplaza WHATSAPP_NUMBER_HERE por el número de destino en el script.');
    } else {
      const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      window.open(waUrl, '_blank');
    }

    // Limpiar carrito
    cart = [];
    saveCart();
    updateCartUI();
    closeCartModal();
  }catch(err){
    dbg(err);
    alert('Error al procesar el pedido: ' + (err.message || err));
  }finally{
    cartConfirmBtn.disabled = false;
    cartConfirmBtn.innerText = 'Confirmar y enviar por WhatsApp';
  }
}

/* Inicializar botones del modal */
if(cartCloseBtn) cartCloseBtn.onclick = closeCartModal;
if(cartConfirmBtn) cartConfirmBtn.onclick = sendOrderAndWhatsapp;
if(cartBtn) cartBtn.onclick = openCartModal;

/* Mostrar carrito incluso si vacío (badge 0) */
updateCartUI();

/* ----------------- Cargar categorías (tu código original) -----------------*/
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inválida");
    renderTabs(data.sheets);
  } catch(err){
    tabsEl.innerHTML = 'Error cargando categorías';
    dbg(err);
  }
}
function renderTabs(sheets){
  tabsEl.innerHTML = '';

  // Botón especial "Todos"
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsEl.appendChild(allBtn);

  // Resto de categorías
  sheets.forEach((s, i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
  });

  // 🚀 Cargar "Todos" automáticamente al inicio
  loadProductsAll();
}

/* ======= Cargar productos ======= */
async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  contentEl.innerHTML = 'Cargando...';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, "ALL");
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

function renderProducts(products, sheetKey){
  if (!products.length){ 
    contentEl.innerHTML='No hay productos'; 
    return; 
  }
  const grid = document.createElement('div'); 
  grid.className='grid';

  products.forEach(p=>{
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || '🛍️';
    const cat  = firstKeyValue(d, ['category','categoria']) || '';

    const card = document.createElement('div');
    card.className='card'+(stock<=0?' out':'');

    // Si no hay sheetKey explícito (caso "todos"), usamos la categoría
    card.dataset.row = p.row; 
    card.dataset.sheetKey = (sheetKey === "ALL") ? cat : sheetKey;

    card.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <div class="icon">${icon}</div>
        <div style="flex:1">
          <div class="name">${name}</div>
          <div class="cat">${cat}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div class="actions">
        <button class="small minus">-</button>
        <span class="qty">1</span>
        <button class="small plus">+</button>
        <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
      </div>`;

    const qtyEl = card.querySelector('.qty');
    const minusBtn = card.querySelector('.minus');
    const plusBtn = card.querySelector('.plus');
    const orderBtn = card.querySelector('.order');
    const stockSpan = card.querySelector('.stockval');

    let qty = 1;
    minusBtn.onclick = ()=>{ if(qty>1){ qty--; qtyEl.innerText=qty; } };
    plusBtn.onclick = ()=>{ if(qty < stock){ qty++; qtyEl.innerText=qty; } };
    // <-- Cambiado: ahora añadimos al carrito en vez de decrementar inmediatamente
    orderBtn.onclick = ()=> {
      addToCart(card, qty);
      // reset qty visual a 1
      qty = 1; qtyEl.innerText = qty;
    };

    grid.appendChild(card);
  });

  contentEl.innerHTML=''; 
  contentEl.appendChild(grid);
}

/* ======= Init ======= */
loadCategories();

/* ======= Init ======= */
loadCategories();
</script>
</body>
</html>
