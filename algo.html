<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda din√°mica</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --muted:#666; --accent:#111;
      --radius:10px;
    }
    body{font-family:Inter, system-ui, Arial; margin:0; padding:18px; background:var(--bg); color:#111}
    h1{margin:6px 0 14px 0}
    #app{max-width:1100px;margin:0 auto}
    #tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{background:#fff;border:1px solid #e6e6e6;padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}
    #content{min-height:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #eee;border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 6px rgba(20,20,20,0.03)}
    .card.out{opacity:.5}
    .meta{display:flex;align-items:center;justify-content:space-between}
    .icon{font-size:28px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#f4f4f4}
    .name{font-weight:700}
    .cat{font-size:12px;color:var(--muted)}
    .price{font-weight:700}
    .stock{font-weight:600}
    .actions{display:flex;gap:8px;margin-top:6px}
    button.btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    button.order{background:#111;color:#fff}
    button.order[disabled]{opacity:.5;cursor:not-allowed}
    button.small{padding:6px 8px;border:1px solid #ddd;background:#fff}
    #debug{margin-top:14px;background:#fff;padding:10px;border-radius:8px;border:1px solid #eee;white-space:pre-wrap;font-size:13px;color:#222}
  </style>
</head>
<body>
  <div id="app">
    <h1>Tienda din√°mica</h1>
    <div id="tabs">Cargando categor√≠as...</div>
    <div id="content">Cargando productos...</div>
    <div id="debug">Debug: ‚Äî</div>
  </div>

<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; 
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const debugEl = document.getElementById('debug');
let lastProductsCache = [];
let lastLoadedSheetKey = null;

function dbg(txt){ debugEl.innerText = txt; console.log(txt); }

function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function fmtPrice(v){ return (v===''||v==null) ? '-' : Number(v).toLocaleString(); }
function escapeHTML(s){ return String(s==null ? '' : s); }

/* ======= Cargar categor√≠as ======= */
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida");
    renderTabs(data.sheets);
  } catch(err){
    tabsEl.innerHTML = 'Error cargando categor√≠as';
    dbg(err);
  }
}
function renderTabs(sheets){
  tabsEl.innerHTML = '';
  sheets.forEach((s, i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
    if (i===0){ btn.classList.add('active'); loadProductsFor(s.key); }
  });
}

/* ======= Cargar productos ======= */
async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  contentEl.innerHTML = 'Cargando...';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}
function renderProducts(products, sheetKey){
  if (!products.length){ contentEl.innerHTML='No hay productos'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  products.forEach(p=>{
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || 'üõçÔ∏è';
    const cat = firstKeyValue(d, ['category','categoria']) || '';

    const card = document.createElement('div');
    card.className='card'+(stock<=0?' out':'');
    card.dataset.row=p.row; card.dataset.sheetKey=sheetKey;
    card.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <div class="icon">${escapeHTML(icon)}</div>
        <div style="flex:1">
          <div class="name">${escapeHTML(name)}</div>
          <div class="cat">${escapeHTML(cat)}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div class="actions">
        <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
      </div>`;
    card.querySelector('.order').onclick=()=>handleOrder(card);
    grid.appendChild(card);
  });
  contentEl.innerHTML=''; contentEl.appendChild(grid);
}

/* ======= Pedir producto ======= */
async function handleOrder(card){
  const sheetKey = card.dataset.sheetKey;
  const row = card.dataset.row;
  const stockSpan = card.querySelector('.stockval');
  const before = Number(stockSpan.innerText||0);
  if (before<=0){ alert('Sin stock'); return; }

  const btn = card.querySelector('.order');
  btn.disabled=true; btn.innerText='...';
  try{
    const form=new URLSearchParams();
    form.append('action','decrement');
    form.append('sheetKey',sheetKey);
    form.append('row',row);
    const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form});
    const data=await r.json();
    if (data.error) throw new Error(data.message);
    const newStock=Number(data.newStock);
    stockSpan.innerText=newStock;
    if (newStock<=0){ card.classList.add('out'); btn.disabled=true; }
    btn.innerText='Pedir';
  }catch(err){ dbg(err); alert('Error pedido'); btn.disabled=false; btn.innerText='Pedir'; }
}

/* ======= Init ======= */
loadCategories();
</script>
</body>
</html>

</body>
</html>
