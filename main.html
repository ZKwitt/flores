<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WyvernStore</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            position: relative;
            color: #fff;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(75, 0, 130, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(75, 0, 130, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(75, 0, 130, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        header {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.2rem 2rem;
            box-shadow: 0 2px 30px rgba(75, 0, 130, 0.4);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid rgba(75, 0, 130, 0.5);
        }
        nav { display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto; position: relative; z-index: 1; }
        .logo {
            font-size:2rem;
            font-weight:900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(75, 0, 130, 0.8);
        }
        .logo::before {
            content: 'ü¶∏';
            filter: grayscale(100%) brightness(0) invert(1);
            margin-right: 0.5rem;
        }
        .nav-links { display:flex; gap:2.5rem; list-style:none; }
        .nav-links a {
            text-decoration:none;
            color:#fff;
            font-weight:600;
            transition:all .3s;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .nav-links a:hover {
            color:#7B2CBF;
            text-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }

        .search-container { max-width:600px; margin:2.5rem auto; position:relative; z-index: 1; }
        .search-bar {
            width:100%;
            padding:1rem 3rem 1rem 1.5rem;
            border:2px solid rgba(75, 0, 130, 0.4);
            border-radius:8px;
            font-size:1rem;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition:all .3s;
            color: #fff;
        }
        .search-bar::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-bar:focus {
            outline:none;
            border-color: #7B2CBF;
            box-shadow:0 4px 30px rgba(75, 0, 130, 0.5);
            transform:translateY(-2px);
        }
        .search-btn {
            position:absolute;
            right:8px;
            top:50%;
            transform:translateY(-50%);
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            border:none;
            color:white;
            width:42px;
            height:42px;
            border-radius:6px;
            cursor:pointer;
            font-size:1.2rem;
            transition:all .3s;
            box-shadow: 0 4px 15px rgba(75, 0, 130, 0.5);
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .search-btn:hover {
            transform:translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.7);
        }

        .cart-icon {
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            color:white;
            padding:.8rem 1.8rem;
            border-radius:6px;
            cursor:pointer;
            transition:all .3s;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .cart-icon:hover {
            transform:translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.7);
        }
        .cart-icon::before {
            content: 'üõí ';
            filter: grayscale(100%) brightness(0) invert(1);
        }

        .container { max-width:1400px; margin:2rem auto; padding:0 2rem; position: relative; z-index: 1; }

        .carousel-section {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.3);
            border-radius:12px;
            padding:2.5rem;
            margin-bottom:3rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        /* Carrusel: contenedor cuadrado centrado para cada slide */
.carousel-item .carousel-img-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
  aspect-ratio: 1 / 1;      /* cuadrado */
  max-height: 450px;
  width: 100%;
  overflow: hidden;
  background: #0f0f0f;
  border-radius: 8px;
}

/* imagen dentro del cuadrado: mantener proporciones, no recortar */
.carousel-item .carousel-img{
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display:block;
}
        .carousel-title {
            text-align:center;
            font-size:2.2rem;
            color:#fff;
            margin-bottom:2rem;
            text-shadow:0 0 20px rgba(75, 0, 130, 0.8);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .carousel-container { position:relative; overflow:hidden; border-radius:8px; }
        .carousel { display:flex; transition:transform .5s ease-in-out; }
        .carousel-item { min-width:100%; position:relative; }
        .carousel-item img {
            display:block;
            width:100%;
            height:450px;
            object-fit:contain;
            border-radius:8px;
            background:#0f0f0f;
            border: 2px solid rgba(75, 0, 130, 0.3);
        }
        .carousel-caption {
            position:absolute;
            bottom:25px;
            left:25px;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            color:white;
            padding:1.2rem 2rem;
            border-radius:8px;
            border: 2px solid rgba(75, 0, 130, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        }
        .carousel-caption h3 { font-size:1.6rem; margin-bottom:.5rem; font-weight: 800; text-shadow: 0 0 10px rgba(75, 0, 130, 0.8); }
        .carousel-caption p { font-size:1.3rem; font-weight:bold; color: #9D4EDD; }
        .carousel-btn {
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            background:rgba(20, 20, 20, 0.9);
            border:2px solid rgba(75, 0, 130, 0.4);
            font-size:2rem;
            padding:1rem;
            cursor:pointer;
            border-radius:6px;
            width:50px;
            height:50px;
            z-index:10;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .3s;
            color: #fff;
        }
        .carousel-btn:hover {
            background:#7B2CBF;
            border-color: #7B2CBF;
            box-shadow: 0 4px 20px rgba(75, 0, 130, 0.7);
        }
        .carousel-btn.prev { left:20px; }
        .carousel-btn.next { right:20px; }
        .carousel-dots { display:flex; justify-content:center; gap:10px; margin-top:1.5rem; }
        .dot {
            width:10px;
            height:10px;
            border-radius:2px;
            background:rgba(255, 255, 255, 0.3);
            cursor:pointer;
            transition:all .3s;
            border: 1px solid rgba(75, 0, 130, 0.4);
        }
        .dot.active {
            background:#7B2CBF;
            width:35px;
            border-radius:2px;
            box-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }

        .products-section { margin-top:3rem; }
        .section-title {
            text-align:center;
            font-size:2.5rem;
            color:#fff;
            margin-bottom:2.5rem;
            text-shadow:0 0 20px rgba(75, 0, 130, 0.8);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .tabs-row { display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
        .tab {
            padding:8px 14px;
            border-radius:999px;
            background: rgba(255,255,255,0.04);
            border:1px solid rgba(255,255,255,0.04);
            cursor:pointer;
            font-weight:700;
            color:#fff;
        }
        .tab.active { background: linear-gradient(135deg,#4B0082,#7B2CBF); box-shadow:0 8px 24px rgba(75,0,130,0.35); }

        .products-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
            gap:2rem;
            margin-bottom:3rem;
        }
        .product-card {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.3);
            border-radius:10px;
            overflow:hidden;
            box-shadow:0 8px 32px rgba(0, 0, 0, 0.6);
            transition:all .3s;
            cursor:pointer;
            position: relative;
        }
        .product-card:hover { transform:translateY(-8px); box-shadow:0 12px 40px rgba(75, 0, 130, 0.5); border-color: #7B2CBF; }
        .product-image { display:block; width:100%; height:380px; object-fit:contain; background:#0f0f0f; transition: transform .3s; }
        .product-card:hover .product-image { transform: scale(1.05); }
        .product-info { padding:1.5rem; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); }
        .product-title { font-size:1.15rem; color:#fff; margin-bottom:.5rem; font-weight: 700; }
        .product-price { font-size:1.4rem; color:#9D4EDD; font-weight:900; margin-bottom:0.8rem; text-shadow: 0 0 10px rgba(75, 0, 130, 0.5); }
        .stock-badge { display:inline-block; padding:6px 10px; border-radius:999px; background: #222; color:#fff; font-weight:800; margin-bottom:1rem; border: 1px solid rgba(255,255,255,0.06); }
        .product-actions { display:flex; gap:8px; align-items:center; margin-top:10px; }
        .qty-btn { padding:8px 12px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.04); border-radius:6px; cursor:pointer; color:#fff; font-weight:700; }
        .qty-display { min-width:36px; text-align:center; font-weight:800; font-size:1rem; color:#fff; padding:6px 8px; background: rgba(255,255,255,0.02); border-radius:6px; }
        .product-btn {
            margin-left:auto;
            padding:.9rem 1rem;
            background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%);
            color:white; border:none; border-radius:6px; font-size:1rem; cursor:pointer;
            transition:all .3s; font-weight:700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(75, 0, 130, 0.5);
        }
        .product-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

        .load-more { text-align:center; margin:3rem 0; }
        .load-more-btn {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border:2px solid rgba(75, 0, 130, 0.5);
            color:white;
            padding:1.2rem 2.5rem;
            border-radius:8px;
            font-size:1.1rem;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            gap:.8rem;
            font-weight:700;
            transition:all .3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .load-more-btn:hover {
            background: rgba(75, 0, 130, 0.3);
            transform:translateY(-3px);
            border-color:#7B2CBF;
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.5);
        }
        .arrow-down { font-size:1.5rem; animation:bounce 2s infinite; }
        @keyframes bounce {
            0%,20%,50%,80%,100%{transform:translateY(0);}
            40%{transform:translateY(10px);}
            60%{transform:translateY(5px);}
        }

        footer {
            background: rgba(15, 15, 15, 0.95);
            padding:2.5rem;
            text-align:center;
            margin-top:4rem;
            border-top: 2px solid rgba(75, 0, 130, 0.5);
            position: relative;
            z-index: 1;
        }
        .footer-content { max-width:1400px; margin:0 auto; }
        .footer-links {
            display:flex;
            justify-content:center;
            gap:2.5rem;
            margin-bottom:1.5rem;
            flex-wrap:wrap;
        }
        .footer-links a {
            color:#9D4EDD;
            text-decoration:none;
            font-weight:600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
            transition: all .3s;
        }
        .footer-links a:hover {
            color:#7B2CBF;
            text-shadow: 0 0 10px rgba(75, 0, 130, 0.8);
        }
        footer p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width:768px){
            .nav-links{display:none;}
            .carousel-item img{height:280px;}
            .carousel-btn{width:40px;height:40px;font-size:1.5rem;}
            .section-title{font-size:1.8rem;}
            .products-grid{grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem;}
            .product-image{height:320px;}
        }

        /* cart popup (simple overlay) */
        #cart-popup-overlay{ position: fixed; inset: 0; background: rgba(10,10,12,0.8); display:none; align-items:center; justify-content:center; z-index:10000; padding:20px; }
        #cart-popup{ background: linear-gradient(135deg, #0f0f10 0%, #161216 100%); border-radius:12px; padding:20px; width:420px; max-width:95%; color:#fff; border:1px solid rgba(255,255,255,0.04); box-shadow:0 30px 60px rgba(0,0,0,0.6); }
        #cart-items-container{ max-height:300px; overflow:auto; margin-bottom:10px; }
        .cart-item{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.02); }
        #cart-total{ font-weight:900; margin-top:8px; text-align:right; }
        #cart-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
        .btn-small{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
        .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#fff; }
        .btn-primary{ background: linear-gradient(135deg, #4B0082 0%, #7B2CBF 100%); color:#fff; }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">WyvernStore</div>
            <ul class="nav-links">
                <!-- Botones "Inicio", "Productos" y "Ofertas" eliminados seg√∫n petici√≥n -->
            </ul>
            <!-- Usamos este bot√≥n como disparador del carrito -->
            <button id="cart-icon-btn" class="cart-icon" aria-label="Abrir carrito">Carrito (0)</button>
        </nav>
    </header>

    <div class="container">
        <div class="search-container">
            <input id="searchInput" class="search-bar" type="text" placeholder="üîç Buscar c√≥mics...">
            <button class="search-btn" onclick="searchProducts()" aria-label="Buscar"></button>
        </div>

        <section class="carousel-section">
            <h2 class="carousel-title">Destacados</h2>
            <div class="carousel-container">
                <button class="carousel-btn prev" onclick="moveCarousel(-1)">‚Äπ</button>
                <div class="carousel">
                    <!-- Carousel din√°mico: se llenar√° con populateCarouselFromProducts(...) -->
                </div>
                <button class="carousel-btn next" onclick="moveCarousel(1)">‚Ä∫</button>
            </div>
            <div id="carouselDots" class="carousel-dots"></div>
        </section>

        <section id="productos" class="products-section">
            <h2 class="section-title">Cat√°logo</h2>

            <!-- FILTROS / TABS: llenados por la API -->
            <div id="tabsRow" class="tabs-row">
              <!-- tabs din√°micos (DC, Marvel, Manga, Todos...) -->
            </div>

            <!-- Contenedor donde se renderizan los productos desde la API -->
            <div id="productsGrid" class="products-grid">
                <!-- los productos se inyectar√°n aqu√≠ -->
                <div id="loadingMessage" style="text-align:center;width:100%;padding:40px;color:#aaa">Cargando productos...</div>
            </div>
        </section>

        <div class="load-more">
            <button class="load-more-btn" onclick="loadMore()">Ver m√°s <span class="arrow-down">‚Üì</span></button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="#sobre">Sobre Nosotros</a>
                <a href="#terminos">T√©rminos</a>
                <a href="#privacidad">Privacidad</a>
                <a href="#contacto">Contacto</a>
            </div>
            <p>&copy; 2025 WyvernStore. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- CART POPUP -->
    <div id="cart-popup-overlay" aria-hidden="true">
      <div id="cart-popup" role="dialog" aria-modal="true" aria-label="Carrito de compras">
        <h3 style="margin-bottom:8px">üõí Tu carrito</h3>
        <div id="cart-items-container"><p style="color:#999;text-align:center">Carrito vac√≠o</p></div>
        <div id="cart-total"></div>
        <div id="cart-actions">
          <button id="cart-close" class="btn-small btn-ghost">Cerrar</button>
          <button id="cart-confirm" class="btn-small btn-primary">Enviar por WhatsApp</button>
        </div>
      </div>
    </div>

    <!-- IMAGE MODAL (simple) -->
    <div id="img-modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:20000;">
      <div style="max-width:90vw; max-height:90vh; padding:12px;">
        <img id="img-modal-img" src="" alt="" style="max-width:100%; max-height:90vh; border-radius:8px; display:block;" />
        <div style="text-align:center;margin-top:8px;">
          <button id="img-modal-close" class="btn-small btn-ghost">Cerrar</button>
        </div>
      </div>
    </div>
<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; // tu worker
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
let lastProductsCache = [];
let lastLoadedSheetKey = null;
let availableSheetKeys = [];

(function initDecorAndUi(){
  const emojis = ['üíÑ','üíã','üå∏','‚ú®','ü©∑','üå∫'];
  const count = 14;
  const container = document.createElement('div');
  container.className = 'emoji-bg';
  for(let i=0;i<count;i++){
    const s = document.createElement('span');
    s.className = 'emoji';
    s.textContent = emojis[i % emojis.length];
    s.style.fontSize = (Math.round((Math.random()*36)+20)) + 'px';
    s.style.left = (Math.random()*100) + '%';
    s.style.top = (Math.random()*100) + '%';
    s.style.opacity = (Math.random()*0.06) + 0.03;
    s.style.animationDuration = (18 + Math.random()*32) + 's';
    s.style.animationDelay = (-Math.random()*20) + 's';
    s.style.transform = 'translate3d(0,0,0)';
    s.style.zIndex = '0';
    container.appendChild(s);
  }
  document.body.appendChild(container);

  document.addEventListener('click', function(e){
    if(e.target.matches('.tab')){
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
    }
    if(e.target.matches('.small')) e.target.classList.toggle('selected');
  });

  const cartClose = document.getElementById('cart-close');
  if(cartClose) cartClose.setAttribute('aria-label','Cerrar carrito');
  document.addEventListener('keydown', function(e){ if(e.key === 'Tab') document.documentElement.classList.add('kbd'); });
  window.addEventListener('resize', function(){
    const els = document.querySelectorAll('.emoji-bg .emoji');
    els.forEach(el => { if(Math.random() < 0.35){ el.style.left = (Math.random()*100) + '%'; el.style.top = (Math.random()*100) + '%'; } });
  });
})();

/* ---------- utilidades ---------- */
function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function parsePriceNumber(v){
  if (v === undefined || v === null) return 0;
  if (typeof v === 'number' && !isNaN(v)) return v;
  let s = String(v).trim();
  if (s === '') return 0;
  s = s.replace(/\s+/g, '');
  s = s.replace(/\./g, '');
  s = s.replace(/,/g, '.');
  s = s.replace(/[^0-9.\-]/g, '');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtPrice(v){
  if (v===undefined || v===null) return '-';
  const s = String(v).trim();
  if (s === '') return '-';
  const n = parsePriceNumber(s);
  return Number(n).toLocaleString('de-DE');
}
function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ---------- carrito ---------- */
const WHATSAPP_NUMBER = '573207378992';
let cart = JSON.parse(localStorage.getItem('shop_cart_v1') || '[]');

const cartBtn = document.getElementById('cart-btn');
const cartCountEl = document.getElementById('cart-count');
const cartSummaryEl = document.getElementById('cart-summary');
const cartOverlay = document.getElementById('cart-popup-overlay');
const cartItemsContainer = document.getElementById('cart-items-container');
const cartTotalEl = document.getElementById('cart-total');
const cartCloseBtn = document.getElementById('cart-close');
const cartConfirmBtn = document.getElementById('cart-confirm');

function saveCart(){ localStorage.setItem('shop_cart_v1', JSON.stringify(cart)); }
function cartItemKey(item){ return `${item.sheetKey}::${item.row}`; }

function findProductInCache(sheetKey, row){
  if(!Array.isArray(lastProductsCache)) return null;
  const targetSk = (sheetKey || '').toString().trim().toLowerCase();
  return lastProductsCache.find(pp => {
    const sk = (pp.sheetKey || (pp.data && (pp.data.Categoria || pp.data.categoria)) || '').toString().trim().toLowerCase();
    return String(pp.row) === String(row) && sk === targetSk;
  }) || null;
}

function getOriginalStock(sheetKey, row){
  const card = Array.from(document.querySelectorAll('.card')).find(c => {
    const sk = (c.dataset.sheetKey || '').toString().trim().toLowerCase();
    const rrow = (c.dataset.row || '').toString();
    return sk === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
  });
  if (card){
    if(card.dataset.serverStock !== undefined && card.dataset.serverStock !== '') return Number(card.dataset.serverStock || 0);
    if(card.dataset.origStock !== undefined && card.dataset.origStock !== '') return Number(card.dataset.origStock || 0);
  }
  const p = findProductInCache(sheetKey, row);
  if (p){
    const d = p.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0;
    return Number(stock || 0);
  }
  const p2 = (Array.isArray(lastProductsCache) && lastProductsCache.find(pp=>String(pp.row)===String(row))) || null;
  if(p2){
    const d = p2.data || {};
    const stock = firstKeyValue(d, ['stock','cantidad','Stock']) || 0;
    return Number(stock || 0);
  }
  return 0;
}

function getReservedQty(sheetKey, row){
  return cart.filter(i => (i.sheetKey||'').toString().trim().toLowerCase() === (sheetKey||'').toString().trim().toLowerCase() && String(i.row) === String(row)).reduce((s,i)=>s+Number(i.qty||0), 0);
}

function refreshCardStockDisplay(sheetKey, row){
  const cards = Array.from(document.querySelectorAll('.card')).filter(c => {
    const sk = (c.dataset.sheetKey || '').toString().trim().toLowerCase();
    const rrow = (c.dataset.row || '').toString();
    return sk === (sheetKey||'').toString().trim().toLowerCase() && rrow === (row||'').toString();
  });
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey, row);
  const avail = Math.max(0, origStock - reserved);
  cards.forEach(card => {
    const stockSpan = card.querySelector('.stockval');
    if(stockSpan) stockSpan.innerText = avail;
    const orderBtn = card.querySelector('.order');
    if(avail <= 0){
      card.classList.add('out');
      card.style.opacity = '0.45';
      if(orderBtn) orderBtn.disabled = true;
    } else {
      card.classList.remove('out');
      card.style.opacity = '';
      if(orderBtn) orderBtn.disabled = false;
    }
  });
}

function updateCartUI(){
  const count = cart.reduce((s,i)=>s+Number(i.qty||0),0);
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  if(cartCountEl) cartCountEl.innerText = count;
  if(cartSummaryEl) cartSummaryEl.innerText = count > 0 ? 'Carrito' : 'Carrito vac√≠o';
  if(cartBtn) cartBtn.style.display = count > 0 ? 'flex' : 'none';
  if(cartBtn) cartBtn.title = count ? `${count} item(s) ‚Äî Total $ ${Number(total).toLocaleString('de-DE')}` : 'Carrito vac√≠o';
  saveCart();
}

/* ---------- sync stock con servidor (cache-bust y reconciliaci√≥n) ---------- */
function mapToAvailableSheetKey(input){
  if(!input) return null;
  const s = String(input).trim();
  if(availableSheetKeys && availableSheetKeys.length){
    const found = availableSheetKeys.find(k => String(k).toLowerCase() === s.toLowerCase());
    if(found) return found;
  }
  return s || null;
}

async function fetchServerStock(sheetKeyRaw, row){
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  if(!mappedKey) return null;
  const resp = await fetch(API_URL + '?sheetKey=' + encodeURIComponent(mappedKey) + '&_=' + Date.now(), { cache: 'no-store' });
  if(!resp.ok) return null;
  const json = await resp.json().catch(()=>null);
  if(!json || !Array.isArray(json.products)) return null;
  const found = json.products.find(p => String(p.row) === String(row));
  if(!found) return null;
  const stockVal = firstKeyValue(found.data || {}, ['stock','cantidad','Stock']) || found.data && (found.data.Stock || found.data.cantidad) || 0;
  return Number(stockVal || 0);
}

async function updateStockOnServer_decrement(sheetKeyRaw, row, qty){
  if(!qty || qty <= 0) return { ok:false, newStock: undefined };
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw);
  if(!mappedKey) return { ok:false, newStock: undefined };

  // intento at√≥mico con qty
  const respAtomic = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row), qty: Number(qty) })
  }).catch(()=>null);

  if(respAtomic && respAtomic.ok){
    const txt = await respAtomic.text().catch(()=>null);
    let json = null;
    try { json = txt ? JSON.parse(txt) : null; } catch(e){ json = null; }
    if(json && !json.error && (json.newStock !== undefined)){
      const ns = Number(json.newStock);
      const reservedLocal = getReservedQty(mappedKey, row);
      document.querySelectorAll('.card').forEach(card=>{
        if(card.dataset.sheetKey && card.dataset.row && normalize(card.dataset.sheetKey) === normalize(mappedKey) && String(card.dataset.row) === String(row)){
          card.dataset.serverStock = String(ns);
          card.dataset.origStock = String(Math.max(0, ns + reservedLocal));
        }
      });
      if (Array.isArray(lastProductsCache)){
        const p = lastProductsCache.find(pp => String(pp.row) === String(row) && normalize(pp.sheetKey) === normalize(mappedKey));
        if(p){ p.data = p.data || {}; p.data.Stock = Number(ns); }
      }
      refreshCardStockDisplay(mappedKey, row);
      return { ok:true, newStock: ns };
    }
  }

  // fallback: N requests en paralelo
  const promises = [];
  for(let i=0;i<qty;i++){
    promises.push(
      fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'decrement', sheetKey: mappedKey, row: String(row) })
      }).then(async r => {
        const txt = await r.text().catch(()=>null);
        let j = null;
        try { j = txt ? JSON.parse(txt) : null; } catch(e){ j = null; }
        return { ok: r.ok, json: j };
      }).catch(()=>({ ok:false }))
    );
  }
  const results = await Promise.all(promises);
  let successCount = 0;
  let lastNewStock;
  results.forEach(res => {
    if(res && res.ok && res.json && !res.json.error){
      successCount++;
      if(res.json.newStock !== undefined) lastNewStock = Number(res.json.newStock);
    }
  });

  if(lastNewStock !== undefined){
    const ns = lastNewStock;
    const reservedLocal = getReservedQty(mappedKey, row);
    document.querySelectorAll('.card').forEach(card=>{
      if(card.dataset.sheetKey && normalize(card.dataset.sheetKey) === normalize(mappedKey) && String(card.dataset.row) === String(row)){
        card.dataset.serverStock = String(ns);
        card.dataset.origStock = String(Math.max(0, ns + reservedLocal));
      }
    });
    if (Array.isArray(lastProductsCache)){
      const p = lastProductsCache.find(pp => String(pp.row) === String(row) && normalize(pp.sheetKey) === normalize(mappedKey));
      if(p){ p.data = p.data || {}; p.data.Stock = Number(ns); }
    }
    refreshCardStockDisplay(mappedKey, row);
  } else if(successCount > 0){
    // partial success -> force refresh from server to reconcile
    await refreshStockFromServerForItem(mappedKey, row);
  }

  return { ok: successCount === qty, newStock: lastNewStock };
}

async function updateStockOnServer_set(sheetKeyRaw, row, newStock){
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  const resp = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'set', sheetKey: mappedKey, row: String(row), value: String(newStock) })
  }).catch(()=>null);

  if(!resp) return false;
  const txt = await resp.text().catch(()=>null);
  let json = null;
  try { json = txt ? JSON.parse(txt) : null; } catch(e){ json = null; }
  if(resp.ok && json && !json.error){
    const confirmedStock = (json.newStock !== undefined) ? Number(json.newStock) : Number(newStock);
    const reservedLocal = getReservedQty(mappedKey, row);
    document.querySelectorAll('.card').forEach(card=>{
      if(card.dataset.sheetKey && normalize(card.dataset.sheetKey) === normalize(mappedKey) && String(card.dataset.row) === String(row)){
        card.dataset.serverStock = String(confirmedStock);
        card.dataset.origStock = String(Math.max(0, confirmedStock + reservedLocal));
      }
    });
    refreshCardStockDisplay(mappedKey, row);
    return true;
  }
  return false;
}

async function updateStockOnServer_increaseViaSet(sheetKeyRaw, row, delta){
  if(!delta || delta <= 0) return;
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  const serverStock = await fetchServerStock(mappedKey, row);
  const baseStock = (serverStock !== null && serverStock !== undefined) ? Number(serverStock) : Number(getOriginalStock(mappedKey, row) || 0);
  const newStock = Math.max(0, baseStock + Number(delta));
  await updateStockOnServer_set(mappedKey, row, newStock);
}

/* ---------- helpers ---------- */
function normalize(s){ return (s||'').toString().trim().toLowerCase(); }

async function refreshStockFromServerForItem(sheetKeyRaw, row){
  const mappedKey = mapToAvailableSheetKey(sheetKeyRaw) || sheetKeyRaw;
  const serverStock = await fetchServerStock(mappedKey, row);
  if (serverStock === null || serverStock === undefined) return;
  const pk = normalize(mappedKey);
  const reservedLocal = getReservedQty(mappedKey, row);
  document.querySelectorAll('.card').forEach(card => {
    if(card.dataset.sheetKey && normalize(card.dataset.sheetKey) === pk && String(card.dataset.row) === String(row)){
      card.dataset.serverStock = String(Number(serverStock));
      card.dataset.origStock = String(Math.max(0, Number(serverStock) + reservedLocal));
    }
  });
  if (Array.isArray(lastProductsCache)){
    const p = lastProductsCache.find(pp => String(pp.row) === String(row) && normalize(pp.sheetKey) === pk);
    if (p){ p.data = p.data || {}; p.data.Stock = Number(serverStock); }
  }
  refreshCardStockDisplay(mappedKey, row);
}

/* ---------- finalizar compra (decrement paralelos por item) ---------- */
async function finalizePurchaseOnServer(items){
  const failures = [];
  if(!Array.isArray(items) || items.length === 0) return failures;

  const promises = items.map(async (it) => {
    const qty = Number(it.qty || 0);
    if(!qty) return { ok: true, item: it };
    const res = await updateStockOnServer_decrement(it.sheetKey, it.row, qty);
    return { ok: !!res.ok, item: it, newStock: res.newStock };
  });

  const results = await Promise.all(promises);

  // aplicar newStock si viene (ya aplicado dentro de decrement), y forzar refresh si no vino newStock
  const toRefresh = [];
  results.forEach(r => {
    if(!r.ok) failures.push(r.item);
    if(r.ok && r.newStock === undefined) toRefresh.push(r.item);
  });

  if(toRefresh.length) {
    await Promise.all(toRefresh.map(it => refreshStockFromServerForItem(it.sheetKey, it.row)));
  }

  return failures;
}

/* ---------- add/remove carrito y env√≠os ---------- */
async function addToCart(card, qty){
  const rawSheetKey = (card && card.dataset.sheetKey) || lastLoadedSheetKey || 'UNKNOWN';
  const sheetKey = mapToAvailableSheetKey(rawSheetKey) || rawSheetKey;
  const row = card && card.dataset.row;
  const name = card?.querySelector('.name')?.innerText || 'Sin nombre';
  const priceRaw = card?.dataset.price !== undefined ? card.dataset.price : (card?.querySelector('.price')?.innerText || '');
  const priceNum = parsePriceNumber(priceRaw);
  const origStock = getOriginalStock(sheetKey, row);
  const reserved = getReservedQty(sheetKey,row);
  const available = Math.max(0, origStock - reserved);
  if(qty > available){
    alert('No hay suficiente stock disponible.');
    return;
  }
  const key = `${sheetKey}::${row}`;
  const existing = cart.find(i=>cartItemKey(i) === key);
  if(existing){
    existing.qty = Math.min(origStock, existing.qty + qty);
  } else {
    cart.push({ sheetKey, row, name, price: priceRaw, _priceNum: priceNum, qty });
  }
  refreshCardStockDisplay(sheetKey,row);
  updateCartUI();
  // intentar decrementar en servidor; si devuelve newStock se aplica inmediatamente
  updateStockOnServer_decrement(sheetKey, row, qty).catch(()=>{});
}

function removeFromCart(idx){
  if(idx >= 0 && idx < cart.length){
    const item = cart[idx];
    const removedQty = Number(item.qty || 0);
    cart.splice(idx, 1);
    refreshCardStockDisplay(item.sheetKey, item.row);
    updateCartUI();
    updateStockOnServer_increaseViaSet(item.sheetKey, item.row, removedQty).catch(()=>{});
  }
}

function sendToWhatsApp(){
  if(cart.length === 0){ alert('El carrito est√° vac√≠o'); return; }
  let message = '*Nuevo Pedido - Marrie*\n\n';
  let total = 0;
  cart.forEach(item => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    total += itemTotal;
    message += `*${item.name}*\n   Cantidad: ${item.qty}\n   Precio: ${Number(itemTotal).toLocaleString('de-DE')}\n\n`;
  });
  message += `*TOTAL: ${Number(total).toLocaleString('de-DE')}*\n\n`;
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

  finalizePurchaseOnServer(cart).then(async (failures) => {
    if (failures.length === 0){
      // refrescar stocks para los items comprados (asegurar consistencia)
      await Promise.all(cart.map(it => refreshStockFromServerForItem(it.sheetKey, it.row)));
      window.open(url, '_blank');
      cart = [];
      updateCartUI();
      document.querySelectorAll('.card').forEach(card => refreshCardStockDisplay(card.dataset.sheetKey, card.dataset.row));
      closeCartPopup();
    } else {
      const proceed = confirm('No fue posible actualizar el stock en el servidor para algunos productos. ¬øDeseas continuar y enviar el pedido por WhatsApp de todas maneras?');
      if (proceed){
        window.open(url, '_blank');
        cart = [];
        updateCartUI();
        document.querySelectorAll('.card').forEach(card => refreshCardStockDisplay(card.dataset.sheetKey, card.dataset.row));
        closeCartPopup();
      } else {
        await Promise.all(failures.map(it => refreshStockFromServerForItem(it.sheetKey, it.row)));
      }
    }
  }).catch(() => {
    // en caso de error general, abrir WA y vaciar carrito (comportamiento previo)
    window.open(url, '_blank');
    cart = [];
    updateCartUI();
    document.querySelectorAll('.card').forEach(card => refreshCardStockDisplay(card.dataset.sheetKey, card.dataset.row));
    closeCartPopup();
  });
}

/* ---------- UI carrito ---------- */
function openCartPopup(){
  let html = '';
  if(cart.length === 0){
    cartItemsContainer.innerHTML = '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';
    cartTotalEl.innerHTML = '';
    cartOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    return;
  }
  cart.forEach((item, idx) => {
    const itemTotal = parsePriceNumber(item._priceNum !== undefined ? item._priceNum : item.price) * Number(item.qty||0);
    html += `
      <div class="cart-item">
        <span class="cart-item-name">${escapeHtml(item.name)}</span>
        <span class="cart-item-qty">x${item.qty}</span>
        <span class="cart-item-price">${Number(itemTotal).toLocaleString('de-DE')}</span>
        <button class="cart-item-remove" onclick="removeFromCart(${idx})">‚úï</button>
      </div>
    `;
  });
  cartItemsContainer.innerHTML = html || '<p style="text-align:center;color:#999">Carrito vac√≠o</p>';
  const total = cart.reduce((s,i)=> s + (parsePriceNumber(i._priceNum !== undefined ? i._priceNum : i.price) * Number(i.qty||0)), 0);
  cartTotalEl.innerHTML = `üí∞ Total: <span style="color:var(--primary)">${Number(total).toLocaleString('de-DE')}</span>`;
  cartOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeCartPopup(){ cartOverlay.style.display = 'none'; document.body.style.overflow = ''; }

if(cartBtn) cartBtn.addEventListener('click', openCartPopup);
if(cartCloseBtn) cartCloseBtn.addEventListener('click', closeCartPopup);
if(cartConfirmBtn) cartConfirmBtn.addEventListener('click', sendToWhatsApp);
window.removeFromCart = removeFromCart;

/* ---------- modal imagen ---------- */
const imgModalOverlay = document.getElementById('img-modal-overlay');
const imgModalImg = document.getElementById('img-modal-img');
const imgModalClose = document.getElementById('img-modal-close');
function proxiedUrl(raw){ return API_URL + 'image-proxy?url=' + encodeURIComponent(raw); }
function openImageModal(url, alt){
  if(!url) return;
  imgModalImg.src = proxiedUrl(url);
  imgModalImg.alt = alt || '';
  imgModalOverlay.style.display = 'flex';
  imgModalOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}
function closeImageModal(){ imgModalOverlay.style.display = 'none'; imgModalOverlay.setAttribute('aria-hidden','true'); imgModalImg.src = ''; document.body.style.overflow = ''; }
if(imgModalClose) imgModalClose.addEventListener('click', closeImageModal);
if(imgModalOverlay) imgModalOverlay.addEventListener('click', (e)=>{ if(e.target === imgModalOverlay) closeImageModal(); });

/* ---------- lazy-load ---------- */
const lazyObserver = (function(){
  if (typeof IntersectionObserver === 'undefined') return null;
  return new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;
      const img = entry.target;
      const src = img.dataset && img.dataset.src;
      if (src) {
        img.src = src;
        delete img.dataset.src;
      }
      obs.unobserve(img);
    });
  }, { rootMargin: '300px 0px', threshold: 0.01 });
})();
function observeLazyImages(rootEl) {
  if (!lazyObserver) return;
  const imgs = (rootEl || document).querySelectorAll('img[data-src]');
  imgs.forEach(img => { if (document.contains(img)) lazyObserver.observe(img); });
}
function makeImgEl(raw, alt, className){
  const img = document.createElement('img');
  img.alt = alt || '';
  img.className = className || '';
  if (raw) img.dataset.src = proxiedUrl(raw);
  img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
  img.onerror = () => { img.remove(); };
  return img;
}

/* ---------- render productos (chunked) ---------- */
function renderProducts(products, sheetKey){
  if (!products || !products.length){
    if(contentEl) contentEl.innerHTML = '<div class="loading">No hay productos</div>';
    return;
  }
  const CHUNK_SIZE = 20;
  const total = products.length;
  lastProductsCache = (products || []).map(p => ({
    row: p.row,
    sheetKey: (p.sheetKey || (p.data && (p.data.Categoria || p.data.categoria)) || sheetKey || 'UNKNOWN').toString(),
    data: p.data || {}
  }));
  if(contentEl) contentEl.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid';
  contentEl.appendChild(grid);

  function createCardNode(p, index){
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto','Nombre']) || d.Nombre || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio','Precio']) || d.Precio || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad','Stock']) || d.Stock || 0);
    const emojiIcon = firstKeyValue(d, ['icono','Icono','icon','emoji']) || d.Icono || 'üõçÔ∏è';
    const imgUrl = firstKeyValue(d, ['img','Img','imagen','image','url','Imagen']) || d.Img || '';
    const description = firstKeyValue(d, ['descripcion','Descripcion','description','desc','nota','Nota']) || d.descripcion || d.Descripcion || '';
    const productSheetKey = mapToAvailableSheetKey(p.sheetKey || d.Categoria || sheetKey || 'UNKNOWN') || (p.sheetKey || d.Categoria || sheetKey || 'UNKNOWN');

    const cardWrap = document.createElement('div');
    cardWrap.className = 'card';
    cardWrap.dataset.origStock = String(stock);
    cardWrap.dataset.price = price;
    cardWrap.dataset.row = String(p.row);
    cardWrap.dataset.sheetKey = String(productSheetKey);
    if (d.Stock !== undefined) cardWrap.dataset.serverStock = String(Number(d.Stock || 0));
    cardWrap.dataset._imgUrl = imgUrl || '';
    cardWrap.dataset._emoji = emojiIcon || '';
    cardWrap.dataset._desc = description || '';
    cardWrap.innerHTML = `
      <div class="flip-inner">
        <div class="face front">
          <div style="position:relative;padding:12px;">
            <button class="eye-toggle" aria-pressed="false" title="Ver imagen y descripci√≥n" type="button" aria-label="Ver imagen y descripci√≥n">üîç</button>
            <div class="front-image" aria-hidden="true"><div style="padding:20px;color:#ddd;font-size:2rem">üîú</div></div>
            <div class="meta">
              <div class="name">${escapeHtml(name)}</div>
              <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px">
                <div class="price">$ ${fmtPrice(price)}</div>
                <div class="stock">Stock: <span class="stockval">${Math.max(0, stock - getReservedQty(productSheetKey, p.row))}</span></div>
              </div>
            </div>
          </div>
          <div style="padding:0 16px 16px">
            <div class="actions">
              <button class="small minus">‚àí</button>
              <span class="qty">1</span>
              <button class="small plus">+</button>
              <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
            </div>
          </div>
        </div>
        <div class="face back" aria-hidden="true">
          <div style="position:relative;padding:12px">
            <button class="eye-toggle" aria-pressed="true" title="Volver" type="button" aria-label="Volver">‚Ü©</button>
          </div>
          <div class="back-image-wrap"><div style="padding:30px;color:#bbb;font-size:3rem">üñºÔ∏è</div></div>
          <div style="padding:12px"><div class="desc-box">Cargando...</div></div>
        </div>
      </div>
    `;
    return cardWrap;
  }

  function populateCardDetails(card){
    const imgUrl = card.dataset._imgUrl || '';
    const emojiIcon = card.dataset._emoji || '';
    const description = card.dataset._desc || '';
    const front = card.querySelector('.face.front');
    const back = card.querySelector('.face.back');
    const frontImageWrap = front.querySelector('.front-image');
    frontImageWrap.innerHTML = '';
    if (emojiIcon && !/^(https?:)?\/\//i.test(emojiIcon)) {
      const span = document.createElement('div');
      span.style.fontSize = '52px';
      span.style.lineHeight = '1';
      span.innerText = emojiIcon;
      frontImageWrap.appendChild(span);
    } else if (imgUrl) {
      const smallImg = makeImgEl(imgUrl, card.querySelector('.name')?.innerText || '', 'product-img');
      frontImageWrap.appendChild(smallImg);
    } else {
      frontImageWrap.innerHTML = '<div style="padding:18px;color:#eee;font-size:2rem">üõçÔ∏è</div>';
    }

    const backImageWrap = back.querySelector('.back-image-wrap');
    backImageWrap.innerHTML = '';
    if (imgUrl && /^(https?:)?\/\//i.test(imgUrl)) {
      const imgLarge = makeImgEl(imgUrl, card.querySelector('.name')?.innerText || '', 'back-image');
      imgLarge.addEventListener('click', (e)=>{ e.stopPropagation(); openImageModal(imgUrl, card.querySelector('.name')?.innerText || ''); });
      backImageWrap.appendChild(imgLarge);
    } else {
      backImageWrap.innerHTML = `<div style="padding:30px;color:#bbb;font-size:3rem">üñºÔ∏è</div>`;
    }

    const descBox = back.querySelector('.desc-box');
    if (descBox) descBox.innerText = description || 'Sin descripci√≥n disponible';
    observeLazyImages(card);
  }

  let index = 0;
  function processChunk(){
    if (index >= total) return;
    const start = index;
    const frag = document.createDocumentFragment();
    const end = Math.min(index + CHUNK_SIZE, total);
    const appended = [];
    for (let i = index; i < end; i++){
      const p = products[i];
      const node = createCardNode(p, i);
      frag.appendChild(node);
      appended.push(node);
    }
    grid.appendChild(frag);
    const fill = () => appended.forEach(card => populateCardDetails(card));
    if (typeof requestIdleCallback !== 'undefined') requestIdleCallback(fill, { timeout: 300 });
    else setTimeout(fill, 80);
    index = end;
    if (typeof requestIdleCallback !== 'undefined') requestIdleCallback(processChunk, { timeout: 500 });
    else setTimeout(processChunk, 50);
  }
  processChunk();

  if (!grid._hasDelegation) {
    grid.addEventListener('click', function(e){
      const plus = e.target.closest('.plus');
      if (plus) {
        e.preventDefault();
        const card = plus.closest('.card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty');
        const current = Number(qtySpan?.innerText || '1');
        const orig = getOriginalStock(card.dataset.sheetKey, card.dataset.row);
        if (current < Math.max(0, orig - getReservedQty(card.dataset.sheetKey, card.dataset.row))){
          qtySpan.innerText = current + 1;
        }
        return;
      }
      const minus = e.target.closest('.minus');
      if (minus) {
        e.preventDefault();
        const card = minus.closest('.card');
        if (!card) return;
        const qtySpan = card.querySelector('.qty');
        const current = Number(qtySpan?.innerText || '1');
        if (current > 1) qtySpan.innerText = current - 1;
        return;
      }
      const orderBtn = e.target.closest('.order');
      if (orderBtn) {
        e.preventDefault();
        const card = orderBtn.closest('.card');
        if (!card) return;
        const qty = Number(card.querySelector('.qty')?.innerText || '1');
        addToCart(card, qty);
        return;
      }
      const eye = e.target.closest('.eye-toggle');
      if (eye) {
        e.preventDefault();
        const card = eye.closest('.card');
        if (!card) return;
        const inner = card.querySelector('.flip-inner');
        if (!inner) return;
        inner.classList.toggle('flipped');
        return;
      }
    });
    grid._hasDelegation = true;
  }

  // after render, refresh shown stocks concurrently but without flooding the worker
  (async function syncShownStocks(){
    const cards = Array.from(document.querySelectorAll('.card'));
    const jobs = cards.map(c => ({ sheetKey: c.dataset.sheetKey, row: c.dataset.row }));
    // limit concurrency
    const CONC = 6;
    for (let i = 0; i < jobs.length; i += CONC){
      const batch = jobs.slice(i, i+CONC);
      await Promise.all(batch.map(j => refreshStockFromServerForItem(j.sheetKey, j.row)));
    }
  })();
}

/* ---------- categor√≠as y carga (con cache-bust) ---------- */
async function loadCategories(){
  try {
    const r = await fetch(API_URL + '?_=' + Date.now(), {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida");
    availableSheetKeys = (data.sheets || []).map(s => s.key).filter(Boolean);
    renderTabs(data.sheets);
  } catch(err){
    if(tabsEl) tabsEl.innerHTML = 'Error cargando categor√≠as';
  }
}

function renderTabs(sheets){
  if(!tabsEl) return;
  tabsEl.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'tab active';
  allBtn.innerText = "‚ú® Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsEl.appendChild(allBtn);

  sheets.forEach((s)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
  });

  loadProductsAll();
}

/* ---------- loadProductsFor (cache-buster) ---------- */
async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando productos</div>';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey)+'&_='+Date.now(), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ if(contentEl) contentEl.innerHTML='Error: '+data.message; return; }
    const products = (data.products || []).map(p=> { if(!p.sheetKey) p.sheetKey = sheetKey; return p; });
    lastProductsCache = products.map(p => ({ row: p.row, sheetKey: p.sheetKey, data: p.data || {} }));
    renderProducts(products, sheetKey);
  } catch(err){
    if(contentEl) contentEl.innerHTML='<div class="loading">Error cargando productos</div>';
  }
}

/* ---------- loadProductsAll (cache-bust + detail-merge) ---------- */
async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  if(contentEl) contentEl.innerHTML = '<div class="loading">Cargando todos los productos</div>';
  try {
    const r = await fetch(API_URL+'?all=1&_='+Date.now(), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ if(contentEl) contentEl.innerHTML='Error: '+data.message; return; }
    let products = data.products || [];

    products.forEach(p=>{
      p.data = p.data || {};
      if(!p.data.Categoria) p.data.Categoria = p.data.categoria || p.sheetKey || 'UNKNOWN';
    });

    const cats = [...new Set(products.map(p => (p.data && (p.data.Categoria || p.data.categoria)) ).filter(Boolean))];

    const detailsPromises = cats.map(cat => fetch(API_URL+'?sheetKey='+encodeURIComponent(cat)+'&_='+Date.now(), {cache:'no-store'}).then(res=>res.json().catch(()=>({products:[]}))).then(json => ({ cat, products: json.products || [] })));
    const details = await Promise.all(detailsPromises);

    const detailMap = {};
    details.forEach(obj=>{
      const cat = obj.cat;
      (obj.products || []).forEach(pp=>{
        const key = `${cat}::${String(pp.row)}`;
        detailMap[key] = pp.data || pp;
        if(!pp.sheetKey) pp.sheetKey = cat;
      });
    });

    products = products.map(p=>{
      const d = p.data || {};
      const cat = d.Categoria || d.categoria || 'UNKNOWN';
      const key = `${cat}::${String(p.row)}`;
      const det = detailMap[key];
      if(det){
        if(!d.descripcion && (det.descripcion || det.Descripcion || det.description)) d.descripcion = firstKeyValue(det, ['descripcion','Descripcion','description','desc','nota','Nota']);
        if(!d.Icono && (det.Icono || det.icono || det.icon)) d.Icono = det.Icono || det.icono || det.icon;
        if(!d.Img && (det.Img || det.img || det.imagen || det.image)) d.Img = det.Img || det.img || det.imagen || det.image;
        if((det.Stock !== undefined) && (d.Stock === undefined)) d.Stock = det.Stock;
        if(!d.Categoria && det.Categoria) d.Categoria = det.Categoria;
      }
      p.sheetKey = p.sheetKey || d.Categoria || cat;
      p.data = d;
      return p;
    });

    lastProductsCache = products.map(p => ({ row: p.row, sheetKey: String(p.sheetKey), data: p.data || {} }));
    renderProducts(lastProductsCache.map(p=>({ row: p.row, data: p.data, sheetKey: p.sheetKey })), "ALL");
  } catch(err){
    if(contentEl) contentEl.innerHTML = '<div class="loading">Error cargando productos</div>';
  }
}

/* ---------- boot ---------- */
loadCategories();
updateCartUI();
</script>
</body>
</html>


