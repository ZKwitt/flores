<script>
const API_URL = "https://d.thepersonmrt.workers.dev/"; 
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const debugEl = document.getElementById('debug');
let lastProductsCache = [];
let lastLoadedSheetKey = null;

function dbg(txt){ debugEl.innerText = txt; console.log(txt); }

function firstKeyValue(obj, keys){
  if (!obj) return undefined;
  const map = {};
  Object.keys(obj).forEach(k => map[k.toLowerCase()] = obj[k]);
  for (let key of keys){
    const v = map[key.toLowerCase()];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return undefined;
}
function fmtPrice(v){ return (v===''||v==null) ? '-' : Number(v).toLocaleString(); }

/* ======= Cargar categor√≠as ======= */
async function loadCategories(){
  try {
    const r = await fetch(API_URL, {cache:'no-store'});
    const data = await r.json();
    if (!data.sheets) throw new Error("Respuesta inv√°lida");
    renderTabs(data.sheets);
  } catch(err){
    tabsEl.innerHTML = 'Error cargando categor√≠as';
    dbg(err);
  }
}
function renderTabs(sheets){
  tabsEl.innerHTML = '';

  // Bot√≥n especial "Todos"
  const allBtn = document.createElement('button');
  allBtn.className = 'tab';
  allBtn.innerText = "Todos";
  allBtn.onclick = () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    allBtn.classList.add('active');
    loadProductsAll();
  };
  tabsEl.appendChild(allBtn);

  sheets.forEach((s, i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.innerText = s.key;
    btn.dataset.key = s.key;
    btn.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      loadProductsFor(s.key);
    };
    tabsEl.appendChild(btn);
    if (i===0){ btn.classList.add('active'); loadProductsFor(s.key); }
  });
}

/* ======= Cargar productos ======= */
async function loadProductsFor(sheetKey){
  lastLoadedSheetKey = sheetKey;
  contentEl.innerHTML = 'Cargando...';
  try {
    const r = await fetch(API_URL+'?sheetKey='+encodeURIComponent(sheetKey), {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, sheetKey);
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

async function loadProductsAll(){
  lastLoadedSheetKey = "ALL";
  contentEl.innerHTML = 'Cargando todos los productos... (puede tardar)';
  try {
    const r = await fetch(API_URL+'?all=1', {cache:'no-store'});
    const data = await r.json();
    if (data.error){ contentEl.innerHTML='Error: '+data.message; return; }
    const products = data.products || [];
    lastProductsCache = products;
    renderProducts(products, "ALL");
  } catch(err){ dbg(err); contentEl.innerHTML='Error cargando productos'; }
}

function renderProducts(products, sheetKey){
  if (!products.length){ contentEl.innerHTML='No hay productos'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  products.forEach(p=>{
    const d = p.data || {};
    const name = firstKeyValue(d, ['name','nombre','producto']) || 'Sin nombre';
    const price = firstKeyValue(d, ['price','precio']) || '';
    const stock = Number(firstKeyValue(d, ['stock','cantidad']) || 0);
    const icon = firstKeyValue(d, ['icon','emoji']) || 'üõçÔ∏è';
    const cat = firstKeyValue(d, ['category','categoria']) || '';

    const card = document.createElement('div');
    card.className='card'+(stock<=0?' out':'');
    card.dataset.row=p.row; card.dataset.sheetKey=sheetKey;

    card.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <div class="icon">${icon}</div>
        <div style="flex:1">
          <div class="name">${name}</div>
          <div class="cat">${cat}</div>
        </div>
      </div>
      <div class="meta">
        <div class="price">$ ${fmtPrice(price)}</div>
        <div class="stock">Stock: <span class="stockval">${stock}</span></div>
      </div>
      <div class="actions">
        <button class="small minus">-</button>
        <span class="qty">1</span>
        <button class="small plus">+</button>
        <button class="btn order" ${stock<=0?'disabled':''}>Pedir</button>
      </div>`;

    const qtyEl = card.querySelector('.qty');
    const minusBtn = card.querySelector('.minus');
    const plusBtn = card.querySelector('.plus');
    const orderBtn = card.querySelector('.order');
    const stockSpan = card.querySelector('.stockval');

    let qty = 1;
    minusBtn.onclick = ()=>{ if(qty>1){ qty--; qtyEl.innerText=qty; } };
    plusBtn.onclick = ()=>{ if(qty < stock){ qty++; qtyEl.innerText=qty; } };
    orderBtn.onclick = ()=>handleOrder(card, qty);

    grid.appendChild(card);
  });
  contentEl.innerHTML=''; contentEl.appendChild(grid);
}

/* ======= Pedir producto ======= */
async function handleOrder(card, qty){
  const sheetKey = card.dataset.sheetKey;
  const row = card.dataset.row;
  const stockSpan = card.querySelector('.stockval');
  const before = Number(stockSpan.innerText||0);
  if (before<=0){ alert('Sin stock'); return; }
  if (qty > before){ alert('No hay suficiente stock'); return; }

  const btn = card.querySelector('.order');
  btn.disabled=true; btn.innerText='...';
  try{
    const form=new URLSearchParams();
    form.append('action','decrement');
    form.append('sheetKey',sheetKey);
    form.append('row',row);
    form.append('amount', qty); // enviar cantidad
    const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form});
    const data=await r.json();
    if (data.error) throw new Error(data.message);
    const newStock=Number(data.newStock);
    stockSpan.innerText=newStock;
    if (newStock<=0){ card.classList.add('out'); btn.disabled=true; }
    btn.innerText='Pedir';
  }catch(err){ dbg(err); alert('Error pedido'); btn.disabled=false; btn.innerText='Pedir'; }
}

/* ======= Init ======= */
loadCategories();
</script>
